<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Investor Portfolio Report -->
    <template id="report_investor_portfolio_document">
        <t t-call="web.external_layout">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
            <div class="page">
                <div class="oe_structure"/>
                
                <h2>Portfolio Report</h2>
                <div class="row mt-4 mb-4">
                    <div class="col-6">
                        <strong>Investor:</strong> <span t-field="doc.name"/><br/>
                        <strong>Date:</strong> <span t-esc="datetime.datetime.now().strftime('%Y-%m-%d')"/><br/>
                        <strong>Session:</strong> <span t-esc="session.name if session else 'All Sessions'"/>
                    </div>
                    <div class="col-6 text-right">
                        <strong>Initial Capital:</strong> <span t-field="doc.initial_capital"/><br/>
                        <strong>Cash Balance:</strong> <span t-field="doc.cash_balance"/><br/>
                        <strong>Portfolio Value:</strong> <span t-field="doc.portfolio_value"/>
                    </div>
                </div>
                
                <!-- Financial Summary -->
                <h3>Financial Summary</h3>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Cash Balance</td>
                            <td class="text-right"><span t-field="doc.cash_balance"/></td>
                        </tr>
                        <tr>
                            <td>Portfolio Value (Securities)</td>
                            <td class="text-right"><span t-field="doc.portfolio_value"/></td>
                        </tr>
                        <tr>
                            <td>Total Deposits</td>
                            <td class="text-right"><span t-field="doc.total_deposits"/></td>
                        </tr>
                        <tr>
                            <td>Total Loans</td>
                            <td class="text-right">(<span t-field="doc.total_loans"/>)</td>
                        </tr>
                        <tr class="font-weight-bold">
                            <td>Total Assets</td>
                            <td class="text-right"><span t-field="doc.total_assets"/></td>
                        </tr>
                        <tr t-attf-class="font-weight-bold #{doc.profit_loss >= 0 and 'text-success' or 'text-danger'}">
                            <td>Profit/Loss</td>
                            <td class="text-right">
                                <span t-field="doc.profit_loss"/>
                                (<span t-field="doc.profit_loss_percentage"/>%)
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Holdings -->
                <h3 class="mt-4">Current Holdings</h3>
                <t t-if="doc.position_ids">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Security</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Avg Cost</th>
                                <th class="text-right">Current Price</th>
                                <th class="text-right">Market Value</th>
                                <th class="text-right">Unrealized P&amp;L</th>
                                <th class="text-right">P&amp;L %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="doc.position_ids" t-as="position">
                                <tr>
                                    <td><span t-field="position.security_id.symbol"/> - <span t-field="position.security_id.name"/></td>
                                    <td class="text-right"><span t-field="position.quantity"/></td>
                                    <td class="text-right"><span t-field="position.average_cost" t-options='{"widget": "float", "precision": 2}'/></td>
                                    <td class="text-right"><span t-field="position.security_id.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                    <td class="text-right"><span t-field="position.market_value"/></td>
                                    <td class="text-right" t-attf-class="#{position.unrealized_pnl >= 0 and 'text-success' or 'text-danger'}">
                                        <span t-field="position.unrealized_pnl"/>
                                    </td>
                                    <td class="text-right" t-attf-class="#{position.unrealized_pnl_percent >= 0 and 'text-success' or 'text-danger'}">
                                        <span t-field="position.unrealized_pnl_percent" t-options='{"widget": "float", "precision": 2}'/>%
                                    </td>
                                </tr>
                            </t>
                            <tr class="font-weight-bold">
                                <td colspan="4">Total</td>
                                <td class="text-right"><span t-esc="sum(doc.position_ids.mapped('market_value'))"/></td>
                                <td class="text-right" t-attf-class="#{sum(doc.position_ids.mapped('unrealized_pnl')) >= 0 and 'text-success' or 'text-danger'}">
                                    <span t-esc="sum(doc.position_ids.mapped('unrealized_pnl'))"/>
                                </td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </t>
                <t t-else="">
                    <p>No current holdings.</p>
                </t>
                
                <!-- Recent Trades -->
                <h3 class="mt-4">Recent Trades</h3>
                <t t-set="recent_trades" t-value="env['stock.trade'].search(['|', ('buyer_id', '=', doc.id), ('seller_id', '=', doc.id)], limit=10, order='trade_date desc')"/>
                <t t-if="recent_trades">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Security</th>
                                <th>Side</th>
                                <th class="text-right">Quantity</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Value</th>
                                <th class="text-right">Commission</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="recent_trades" t-as="trade">
                                <tr>
                                    <td><span t-field="trade.trade_date" t-options='{"widget": "date"}'/></td>
                                    <td><span t-field="trade.security_id.symbol"/></td>
                                    <td><t t-if="trade.buyer_id == doc">Buy</t><t t-else="">Sell</t></td>
                                    <td class="text-right"><span t-field="trade.quantity"/></td>
                                    <td class="text-right"><span t-field="trade.price" t-options='{"widget": "float", "precision": 2}'/></td>
                                    <td class="text-right"><span t-field="trade.value"/></td>
                                    <td class="text-right">
                                        <t t-if="trade.buyer_id == doc"><span t-field="trade.buy_commission"/></t>
                                        <t t-else=""><span t-field="trade.sell_commission"/></t>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
                <t t-else="">
                    <p>No recent trades.</p>
                </t>
                
                <div class="oe_structure"/>
            </div>
        </t>
    </template>
    
    <template id="report_investor_portfolio">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="stock.report_investor_portfolio_document"/>
            </t>
        </t>
    </template>
    
    <!-- Report Action -->
    <report
        id="action_report_investor_portfolio"
        string="Portfolio Report"
        model="res.users"
        report_type="qweb-pdf"
        file="stock.report_investor_portfolio"
        name="stock.report_investor_portfolio"
        print_report_name="'Portfolio Report - %s' % (object.name)"
    />
    
</odoo> 