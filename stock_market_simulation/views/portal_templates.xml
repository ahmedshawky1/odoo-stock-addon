<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Removed portal home inheritance to avoid pulling default portal layout -->
    
    <!-- Portfolio Page -->
    <template id="portal_my_portfolio" name="My Portfolio">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">My Portfolio</h1>
                </div>
                
                <t t-if="not positions">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"/> You don't have any positions yet.
                    </div>
                </t>
                
                <t t-if="positions">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fa fa-briefcase"/> Portfolio Positions</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr class="active">
                                            <th>Security</th>
                                            <th class="text-right">Quantity</th>
                                            <th class="text-right">Avg Cost</th>
                                            <th class="text-right">Market Value</th>
                                            <th class="text-right">Unrealized P&amp;L</th>
                                            <th class="text-right">P&amp;L %</th>
                                            <th class="text-right">Weight %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="positions" t-as="position">
                                            <tr>
                                                <td><t t-esc="position.security_id.symbol"/> - <t t-esc="position.security_id.name"/></td>
                                                <td class="text-right"><t t-esc="position.quantity"/></td>
                                                <td class="text-right"><t t-esc="position.average_cost" t-options='{"widget": "float", "precision": 2}'/></td>
                                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(position.market_value or 0.0)"/></td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        $<t t-esc="'{:,.2f}'.format(position.unrealized_pnl or 0.0)"/>
                                                    </span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-esc="position.unrealized_pnl_percent" t-options='{"widget": "float", "precision": 2}'/>%
                                                    </span>
                                                </td>
                                                <td class="text-right"><t t-esc="position.portfolio_weight" t-options='{"widget": "float", "precision": 2}'/>%</td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>
    
    <!-- Order Entry Page -->
    <template id="portal_order_new" name="Place New Order">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Order Entry Content (for embedding in other templates) -->
    <template id="portal_order_new_content" name="Place New Order Content">
        <div class="container-fluid">
            <div class="page-header mb-4">
                <h1 class="h2">Place New Order</h1>
            </div>
            
            <t t-if="error">
                <div class="alert alert-danger" role="alert">
                    <t t-esc="error"/>
                </div>
            </t>
                
                <t t-if="active_session">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Order Type Selection (Trading vs IPO) -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Order Category</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                            <label class="btn btn-outline-primary active" id="trading_tab">
                                                <input type="radio" name="order_category" value="trading" checked="checked"/> Regular Trading
                                            </label>
                                            <t t-if="ipo_securities and request.env.user.user_type in ['admin', 'superadmin', 'broker']">
                                                <label class="btn btn-outline-success" id="ipo_tab">
                                                    <input type="radio" name="order_category" value="ipo"/> IPO/PO Orders
                                                </label>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Investor Selection (Required for All Users) -->
                            <div class="form-group mb-4">
                                <label for="investor_id" class="form-label">Select Investor <span class="text-danger">*</span></label>
                                <select class="form-control" id="investor_id" name="investor_id" required="required">
                                    <option value="">-- Select Investor --</option>
                                    <t t-foreach="clients" t-as="client">
                                        <option t-att-value="client.id" t-att-data-cash="client.cash_balance">
                                            <t t-esc="client.name"/> (Cash: $<t t-esc="'{:,.2f}'.format(client.cash_balance)"/>)
                                        </option>
                                    </t>
                                </select>
                                <small class="form-text text-muted">Select the investor for whom this order will be placed</small>
                            </div>
                            
                            <div id="investor_info" class="alert alert-info" style="display: none;">
                                <strong>Investor Information:</strong>
                                <div id="investor_cash">Cash Balance: $0.00</div>
                                <div id="investor_portfolio">Portfolio Value: $0.00</div>
                            </div>
                            
                            <!-- Trading Order Form -->
                            <div id="trading_form" class="order-form">
                                <form id="trading_order_form" onsubmit="return false;">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="order_type_category" value="trading"/>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fa fa-line-chart me-2"></i>Regular Trading Order</h5>
                                        </div>
                                        <div class="card-body">
                                
                                <div class="form-group">
                                    <label for="side">Order Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_side" id="trading_side_buy" value="buy" checked="checked"/>
                                            <label class="form-check-label" for="trading_side_buy">Buy</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_side" id="trading_side_sell" value="sell"/>
                                            <label class="form-check-label" for="trading_side_sell">Sell</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_security_id">Trading Security</label>
                                    <select name="trading_security_id" id="trading_security_id" class="form-control" required="required">
                                        <option value="">Select Trading Security</option>
                                        <t t-foreach="trading_securities" t-as="security">
                                            <option t-att-value="security.id" t-att-data-price="security.current_price" t-att-data-status="security.ipo_status">
                                                <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                (Current: $<t t-esc="'{:,.2f}'.format(security.current_price or 0.0)"/>)
                                            </option>
                                        </t>
                                    </select>
                                    <small class="form-text text-muted">Regular trading securities (post-IPO)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_order_type">Price Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_order_type" id="trading_order_type_limit" value="limit" checked="checked"/>
                                            <label class="form-check-label" for="trading_order_type_limit">Limit</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_order_type" id="trading_order_type_market" value="market"/>
                                            <label class="form-check-label" for="trading_order_type_market">Market</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_quantity">Quantity</label>
                                    <input type="number" class="form-control" id="trading_quantity" name="trading_quantity" min="1" required="required"/>
                                </div>
                                
                                <div class="form-group" id="trading_price_group">
                                    <label for="trading_price">Price</label>
                                    <input type="number" class="form-control" id="trading_price" name="trading_price" step="0.01" min="0.01" required="required"/>
                                </div>
                                
                                <div class="form-group">
                                    <label>Estimated Order Value</label>
                                    <p class="form-control-static h4" id="trading_order_value">$0.00</p>
                                </div>
                                
                                <button type="submit" id="submit-trading-order-btn" class="btn btn-primary">
                                    <i class="fa fa-paper-plane me-2"></i>Submit Trading Order
                                </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- IPO Order Form -->
                            <t t-if="request.env.user.user_type in ['admin', 'superadmin', 'broker']">
                                <div id="ipo_form" class="order-form" style="display: none;">
                                <form id="ipo_order_form" onsubmit="return false;">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="order_type_category" value="ipo"/>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fa fa-star me-2"></i>IPO/PO Order</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <i class="fa fa-info-circle me-2"></i>
                                                <strong>IPO Orders:</strong> These are initial public offerings or public offerings. 
                                                Orders are typically at fixed prices and allocated based on availability.
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="ipo_security_id">IPO/PO Security</label>
                                                <select name="ipo_security_id" id="ipo_security_id" class="form-control" required="required">
                                                    <option value="">Select IPO/PO Security</option>
                                                    <t t-foreach="ipo_securities" t-as="security">
                                                        <option t-att-value="security.id" 
                                                                t-att-data-price="security.ipo_price or security.current_price" 
                                                                t-att-data-status="security.ipo_status"
                                                                t-att-data-total-shares="security.total_shares">
                                                            <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                            (IPO Price: $<t t-esc="'{:,.2f}'.format(security.ipo_price or security.current_price or 0.0)"/>)
                                                            <span class="badge badge-secondary ms-2"><t t-esc="security.ipo_status.upper()"/></span>
                                                        </option>
                                                    </t>
                                                </select>
                                                <small class="form-text text-muted">Available IPO and PO securities</small>
                                            </div>
                                            
                                            <div id="ipo_details" class="alert alert-secondary" style="display: none;">
                                                <strong>IPO Details:</strong>
                                                <div id="ipo_price_display">Price: $0.00</div>
                                                <div id="ipo_total_shares">Total Shares: 0</div>
                                                <div id="ipo_status_display">Status: -</div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="ipo_quantity">Requested Quantity</label>
                                                <input type="number" class="form-control" id="ipo_quantity" name="ipo_quantity" min="1" required="required"/>
                                                <small class="form-text text-muted">Enter the number of shares you want to request (subject to allocation)</small>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label>Estimated Investment</label>
                                                <p class="form-control-static h4" id="ipo_order_value">$0.00</p>
                                                <small class="text-muted">Final allocation may differ based on demand</small>
                                            </div>
                                            
                                            <button type="submit" id="submit-ipo-order-btn" class="btn btn-success">
                                                <i class="fa fa-star me-2"></i>Submit IPO Order
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            </t>
                            
                            <div class="mt-3 text-center">
                                <a href="/my" class="btn btn-secondary">
                                    <i class="fa fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Session Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Order Placed By:</strong> <t t-esc="user.name"/> (<t t-esc="user.user_type.title()"/>)</p>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="selected_investor_card" style="display: none;">
                                <div class="card-header">
                                    <h5><i class="fa fa-user me-2"></i>Selected Investor</h5>
                                </div>
                                <div class="card-body">
                                    <div id="selected_investor_name">No investor selected</div>
                                    <div id="selected_investor_cash">Cash Balance: $0.00</div>
                                    <div id="selected_investor_portfolio">Portfolio Value: $0.00</div>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="trading_help_card">
                                <div class="card-header">
                                    <h5><i class="fa fa-question-circle me-2"></i>Order Types</h5>
                                </div>
                                <div class="card-body">
                                    <div class="trading-help active" id="trading_help">
                                        <h6><i class="fa fa-line-chart me-2"></i>Regular Trading</h6>
                                        <p class="small mb-2">Trade securities that are already listed and trading on the market.</p>
                                        <ul class="small mb-0">
                                            <li><strong>Limit Orders:</strong> Set your own price</li>
                                            <li><strong>Market Orders:</strong> Execute at current market price</li>
                                            <li><strong>Buy/Sell:</strong> Standard trading operations</li>
                                        </ul>
                                    </div>
                                    <t t-if="request.env.user.user_type in ['admin', 'superadmin', 'broker']">
                                        <div class="trading-help" id="ipo_help" style="display: none;">
                                            <h6><i class="fa fa-star me-2"></i>IPO/PO Orders</h6>
                                            <p class="small mb-2">Participate in Initial Public Offerings or Public Offerings.</p>
                                            <ul class="small mb-0">
                                                <li><strong>Fixed Pricing:</strong> IPO price is set</li>
                                                <li><strong>Allocation:</strong> Shares allocated based on demand</li>
                                                <li><strong>Request Only:</strong> Final allocation may vary</li>
                                            </ul>
                                        </div>
                                    </t>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="investor_positions_card" style="display: none;">
                                <div class="card-header">
                                    <h5><i class="fa fa-briefcase me-2"></i>Investor Positions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="investor_positions_content">
                                        <p class="text-muted">Select an investor to view positions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
            
            <script>//<![CDATA[
                // Enhanced Trading Portal JavaScript
                
                // Global variables for state management
                let selectedInvestor = null;
                let currentOrderType = 'trading';
                
                // Show notification function
                function showNotification(title, message, type = 'info') {
                    if (window.stockPortal && window.stockPortal.showToast) {
                        window.stockPortal.showToast(message, type);
                        return;
                    }
                    
                    const typeMap = {
                        'success': '✅ Success',
                        'danger': '❌ Error', 
                        'warning': '⚠️ Warning',
                        'info': 'ℹ️ Info'
                    };
                    alert(`${typeMap[type] || 'Notification'}: ${message}`);
                }
                
                // Switch between Trading and IPO order types
                function switchOrderType(orderType) {
                    currentOrderType = orderType;
                    
                    // Update tab appearance
                    const tradingTab = document.getElementById('trading_tab');
                    const ipoTab = document.getElementById('ipo_tab');
                    const tradingForm = document.getElementById('trading_form');
                    const ipoForm = document.getElementById('ipo_form');
                    const tradingHelp = document.getElementById('trading_help');
                    const ipoHelp = document.getElementById('ipo_help');
                    
                    if (orderType === 'trading') {
                        tradingTab.classList.add('active');
                        ipoTab.classList.remove('active');
                        tradingForm.style.display = 'block';
                        ipoForm.style.display = 'none';
                        tradingHelp.style.display = 'block';
                        ipoHelp.style.display = 'none';
                    } else {
                        tradingTab.classList.remove('active');
                        ipoTab.classList.add('active');
                        tradingForm.style.display = 'none';
                        ipoForm.style.display = 'block';
                        tradingHelp.style.display = 'none';
                        ipoHelp.style.display = 'block';
                    }
                    
                    console.log('Switched to order type:', orderType);
                }
                
                // Handle investor selection
                function handleInvestorSelection(investorSelect) {
                    const selectedOption = investorSelect.options[investorSelect.selectedIndex];
                    const investorCard = document.getElementById('selected_investor_card');
                    const positionsCard = document.getElementById('investor_positions_card');
                    
                    if (selectedOption && selectedOption.value) {
                        selectedInvestor = {
                            id: selectedOption.value,
                            name: selectedOption.text.split(' (Cash:')[0],
                            cash: parseFloat(selectedOption.getAttribute('data-cash')) || 0
                        };
                        
                        // Update investor info display
                        document.getElementById('selected_investor_name').innerHTML = 
                            `<strong>${selectedInvestor.name}</strong>`;
                        document.getElementById('selected_investor_cash').innerHTML = 
                            `Cash Balance: $${selectedInvestor.cash.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                        
                        investorCard.style.display = 'block';
                        positionsCard.style.display = 'block';
                        
                        // Load investor positions
                        loadInvestorPositions(selectedInvestor.id);
                    } else {
                        selectedInvestor = null;
                        investorCard.style.display = 'none';
                        positionsCard.style.display = 'none';
                    }
                }
                
                // Load investor positions
                function loadInvestorPositions(investorId) {
                    const positionsContent = document.getElementById('investor_positions_content');
                    positionsContent.innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading positions...</div>';
                    
                    fetch(`/my/investor/${investorId}/positions`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.positions) {
                            let html = '';
                            if (data.positions.length > 0) {
                                html = '<table class="table table-sm"><thead><tr><th>Security</th><th>Available</th></tr></thead><tbody>';
                                data.positions.forEach(pos => {
                                    html += `<tr><td>${pos.symbol}</td><td>${pos.available_quantity}</td></tr>`;
                                });
                                html += '</tbody></table>';
                            } else {
                                html = '<p class="text-muted text-center">No positions found</p>';
                            }
                            positionsContent.innerHTML = html;
                        } else {
                            positionsContent.innerHTML = '<p class="text-muted">Unable to load positions</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading positions:', error);
                        positionsContent.innerHTML = '<p class="text-danger">Error loading positions</p>';
                    });
                }
                
                // Calculate order values
                function calculateTradingOrderValue() {
                    const quantityEl = document.getElementById('trading_quantity');
                    const priceEl = document.getElementById('trading_price');
                    const orderValueEl = document.getElementById('trading_order_value');
                    const securitySelect = document.getElementById('trading_security_id');
                    const orderTypeMarket = document.getElementById('trading_order_type_market');
                    
                    if (!quantityEl || !orderValueEl) return;
                    
                    const quantity = parseFloat(quantityEl.value) || 0;
                    let price = 0;
                    
                    // For market orders, use current market price from security
                    if (orderTypeMarket && orderTypeMarket.checked) {
                        if (securitySelect) {
                            const selectedOption = securitySelect.options[securitySelect.selectedIndex];
                            if (selectedOption && selectedOption.value) {
                                price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                            }
                        }
                    } else {
                        // For limit orders, use the price input field
                        price = priceEl ? parseFloat(priceEl.value) || 0 : 0;
                    }
                    
                    const value = quantity * price;
                    
                    orderValueEl.textContent = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                function calculateIpoOrderValue() {
                    const quantityEl = document.getElementById('ipo_quantity');
                    const securitySelect = document.getElementById('ipo_security_id');
                    const orderValueEl = document.getElementById('ipo_order_value');
                    
                    if (!quantityEl || !securitySelect || !orderValueEl) return;
                    
                    const quantity = parseFloat(quantityEl.value) || 0;
                    const selectedOption = securitySelect.options[securitySelect.selectedIndex];
                    const price = selectedOption ? parseFloat(selectedOption.getAttribute('data-price')) || 0 : 0;
                    const value = quantity * price;
                    
                    orderValueEl.textContent = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                // Handle IPO security selection
                function handleIpoSecuritySelection(securitySelect) {
                    const selectedOption = securitySelect.options[securitySelect.selectedIndex];
                    const detailsDiv = document.getElementById('ipo_details');
                    
                    if (selectedOption && selectedOption.value) {
                        const price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                        const totalShares = parseInt(selectedOption.getAttribute('data-total-shares')) || 0;
                        const status = selectedOption.getAttribute('data-status') || '';
                        
                        document.getElementById('ipo_price_display').textContent = 
                            `Price: $${price.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                        document.getElementById('ipo_total_shares').textContent = 
                            `Total Shares: ${totalShares.toLocaleString()}`;
                        document.getElementById('ipo_status_display').textContent = 
                            `Status: ${status.toUpperCase()}`;
                        
                        detailsDiv.style.display = 'block';
                        calculateIpoOrderValue();
                    } else {
                        detailsDiv.style.display = 'none';
                    }
                }
                
                // Handle price type changes
                function handleTradingPriceTypeChange() {
                    const limitRadio = document.getElementById('trading_order_type_limit');
                    const priceGroup = document.getElementById('trading_price_group');
                    const priceInput = document.getElementById('trading_price');
                    
                    if (limitRadio && priceGroup) {
                        if (limitRadio.checked) {
                            // Limit order: show and require price input
                            priceGroup.style.display = 'block';
                            if (priceInput) priceInput.required = true;
                        } else {
                            // Market order: hide price input
                            priceGroup.style.display = 'none';
                            if (priceInput) priceInput.required = false;
                        }
                        calculateTradingOrderValue();
                    }
                }
                
                // Submit Trading Order
                function submitTradingOrder() {
                    const form = document.getElementById('trading_order_form');
                    const submitBtn = document.getElementById('submit-trading-order-btn');
                    
                    if (!selectedInvestor) {
                        showNotification('Error', 'Please select an investor first', 'danger');
                        return;
                    }
                    
                    const formData = new FormData(form);
                    formData.append('investor_id', selectedInvestor.id);
                    formData.append('side', document.querySelector('input[name="trading_side"]:checked').value);
                    formData.append('security_id', document.getElementById('trading_security_id').value);
                    formData.append('order_type', document.querySelector('input[name="trading_order_type"]:checked').value);
                    formData.append('quantity', document.getElementById('trading_quantity').value);
                    
                    if (document.querySelector('input[name="trading_order_type"]:checked').value === 'limit') {
                        formData.append('price', document.getElementById('trading_price').value);
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
                    
                    fetch('/my/order/submit', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Success', data.message || 'Trading order submitted successfully', 'success');
                            form.reset();
                            calculateTradingOrderValue();
                        } else {
                            showNotification('Error', data.error || 'Failed to submit order', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Trading order error:', error);
                        showNotification('Error', 'Network error occurred', 'danger');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-paper-plane me-2"></i>Submit Trading Order';
                    });
                }
                
                // Submit IPO Order
                function submitIpoOrder() {
                    const form = document.getElementById('ipo_order_form');
                    const submitBtn = document.getElementById('submit-ipo-order-btn');
                    
                    if (!selectedInvestor) {
                        showNotification('Error', 'Please select an investor first', 'danger');
                        return;
                    }
                    
                    const formData = new FormData(form);
                    formData.append('investor_id', selectedInvestor.id);
                    formData.append('security_id', document.getElementById('ipo_security_id').value);
                    formData.append('quantity', document.getElementById('ipo_quantity').value);
                    formData.append('order_type', 'ipo');
                    formData.append('side', 'buy'); // IPO orders are always buy
                    
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
                    
                    fetch('/my/order/submit', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Success', data.message || 'IPO order submitted successfully', 'success');
                            form.reset();
                            calculateIpoOrderValue();
                            document.getElementById('ipo_details').style.display = 'none';
                        } else {
                            showNotification('Error', data.error || 'Failed to submit IPO order', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('IPO order error:', error);
                        showNotification('Error', 'Network error occurred', 'danger');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-star me-2"></i>Submit IPO Order';
                    });
                }
                
                // DOM Ready Event Listeners
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Enhanced Trading Portal loaded');
                    
                    // Order type tab switching
                    const tradingTab = document.getElementById('trading_tab');
                    const ipoTab = document.getElementById('ipo_tab');
                    
                    if (tradingTab) {
                        tradingTab.addEventListener('click', () => switchOrderType('trading'));
                    }
                    if (ipoTab) {
                        ipoTab.addEventListener('click', () => switchOrderType('ipo'));
                    }
                    
                    // Investor selection
                    const investorSelect = document.getElementById('investor_id');
                    if (investorSelect) {
                        investorSelect.addEventListener('change', function() {
                            handleInvestorSelection(this);
                        });
                    }
                    
                    // Trading form events
                    const tradingQuantity = document.getElementById('trading_quantity');
                    const tradingPrice = document.getElementById('trading_price');
                    const tradingSecuritySelect = document.getElementById('trading_security_id');
                    const tradingOrderTypeRadios = document.querySelectorAll('input[name="trading_order_type"]');
                    const tradingForm = document.getElementById('trading_order_form');
                    
                    if (tradingQuantity) tradingQuantity.addEventListener('input', calculateTradingOrderValue);
                    if (tradingPrice) tradingPrice.addEventListener('input', calculateTradingOrderValue);
                    if (tradingSecuritySelect) tradingSecuritySelect.addEventListener('change', calculateTradingOrderValue);
                    
                    tradingOrderTypeRadios.forEach(radio => {
                        radio.addEventListener('change', handleTradingPriceTypeChange);
                    });
                    
                    if (tradingForm) {
                        tradingForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitTradingOrder();
                        });
                    }
                    
                    // IPO form events
                    const ipoQuantity = document.getElementById('ipo_quantity');
                    const ipoSecuritySelect = document.getElementById('ipo_security_id');
                    const ipoForm = document.getElementById('ipo_order_form');
                    
                    if (ipoQuantity) ipoQuantity.addEventListener('input', calculateIpoOrderValue);
                    if (ipoSecuritySelect) {
                        ipoSecuritySelect.addEventListener('change', function() {
                            handleIpoSecuritySelection(this);
                        });
                    }
                    
                    if (ipoForm) {
                        ipoForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitIpoOrder();
                        });
                    }
                    
                    // Initialize default state
                    switchOrderType('trading');
                    handleTradingPriceTypeChange();
                });
            //]]></script>
    </template>
    
    <!-- Market Data Page -->
    <template id="portal_market_data" name="Market Data">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">Market Data</h1>
                </div>
                
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#all">All Securities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#stocks">Stocks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#bonds">Bonds</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#mf">Mutual Funds</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div id="all" class="tab-pane fade show active">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Change</th>
                                    <th class="text-right">Change %</th>
                                    <th class="text-right">Volume</th>
                                    <th class="text-right">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="securities" t-as="security">
                                    <tr>
                                        <td><strong><t t-esc="security.symbol"/></strong></td>
                                        <td><t t-esc="security.name"/></td>
                                        <td><t t-esc="security.security_type"/></td>
                                        <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                            </span>
                                        </td>
                                        <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(security.value_today or 0.0)"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <t t-foreach="grouped_securities" t-as="sec_type">
                        <div t-att-id="sec_type" class="tab-pane fade">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th class="text-right">Price</th>
                                        <th class="text-right">Change</th>
                                        <th class="text-right">Change %</th>
                                        <th class="text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="grouped_securities[sec_type]" t-as="security">
                                        <tr>
                                            <td><strong><t t-esc="security.symbol"/></strong></td>
                                            <td><t t-esc="security.name"/></td>
                                            <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                                </span>
                                            </td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                                </span>
                                            </td>
                                            <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- JavaScript for real-time updates -->
    <template id="portal_stock_js" name="Stock Portal JavaScript">
        <script>//<![CDATA[
            // Global namespace for stock portal functionality
            window.stockPortal = window.stockPortal || {};
            
            // Portfolio refresh functionality
            function refreshPortfolioSummary() {
                fetch('/api/portfolio/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update portfolio values on dashboard
                        const cashEl = document.querySelector('[data-portfolio="cash"]');
                        const portfolioEl = document.querySelector('[data-portfolio="value"]');
                        const totalEl = document.querySelector('[data-portfolio="total"]');
                        const plEl = document.querySelector('[data-portfolio="pl"]');
                        
                        if (cashEl) cashEl.textContent = '$' + data.cash_balance.toLocaleString();
                        if (portfolioEl) portfolioEl.textContent = '$' + data.portfolio_value.toLocaleString();
                        if (totalEl) totalEl.textContent = '$' + data.total_assets.toLocaleString();
                        if (plEl) {
                            plEl.textContent = '$' + data.profit_loss.toLocaleString() + ' (' + data.profit_loss_percentage + '%)';
                            plEl.className = data.profit_loss >= 0 ? 'text-success' : 'text-danger';
                        }
                        
                        console.log('Portfolio data refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing portfolio:', error);
                });
            }
            
            // Market data refresh functionality
            function refreshMarketQuotes() {
                const symbols = [];
                document.querySelectorAll('[data-symbol]').forEach(el => {
                    symbols.push(el.dataset.symbol);
                });
                
                if (symbols.length === 0) return;
                
                fetch('/api/market/quotes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({symbols: symbols})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.quotes) {
                        data.quotes.forEach(quote => {
                            const rows = document.querySelectorAll(`[data-symbol="${quote.symbol}"]`);
                            rows.forEach(row => {
                                const priceEl = row.querySelector('.quote-price');
                                const changeEl = row.querySelector('.quote-change');
                                const pctEl = row.querySelector('.quote-percentage');
                                
                                if (priceEl) priceEl.textContent = quote.current_price.toFixed(2);
                                if (changeEl) {
                                    changeEl.textContent = quote.price_change.toFixed(2);
                                    changeEl.className = quote.price_change >= 0 ? 'text-success' : 'text-danger';
                                }
                                if (pctEl) {
                                    pctEl.textContent = quote.change_percentage + '%';
                                    pctEl.className = quote.change_percentage >= 0 ? 'text-success' : 'text-danger';
                                }
                            });
                        });
                        console.log('Market quotes refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing market quotes:', error);
                });
            }
            
            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Start periodic updates for real-time data
                if (window.location.pathname.startsWith('/my')) {
                    // Refresh portfolio every 30 seconds
                    setInterval(refreshPortfolioSummary, 30000);
                    
                    // Refresh market quotes every 15 seconds
                    setInterval(refreshMarketQuotes, 15000);
                    
                    console.log('Stock portal real-time updates initialized');
                }
            });
            
            // Expose functions globally
            window.stockPortal = window.stockPortal || {};
            window.stockPortal.refreshPortfolioSummary = refreshPortfolioSummary;
            window.stockPortal.refreshMarketQuotes = refreshMarketQuotes;
            window.stockPortal.submitOrder = submitOrder;
            window.stockPortal.showNotification = showNotification;
        //]]></script>
    </template>
    
    <!-- Completely Standalone Stock Market Layout - No Inheritance -->
    <template id="stock_standalone_layout" name="Stock Market Standalone Layout">
    <!-- Standalone HTML skeleton; DOCTYPE removed for XML validity -->
    <html lang="en">
            <head>
                <meta charset="utf-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1"/>
                <title><t t-esc="page_title or 'Stock Market Portal'"/></title>
                <!-- Mark document as stock portal ASAP to allow CSS to hide Odoo chrome before paint -->
                <script>
                //<![CDATA[
                (function(){
                    try { document.documentElement.classList.add('stock-portal'); } catch(e) {}
                })();
                //]]>
                </script>
                
                <!-- Bootstrap CSS -->
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <!-- Font Awesome 6 with v4 shims for backward compatibility -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/v4-shims.min.css"/>
                
                <!-- Custom Stock Market CSS -->
                <style>
                    /* Hide Odoo's website/backoffice chrome on these standalone pages.
                       We avoid relying on a class on the html element so this works even if CSP blocks inline JS.
                       This CSS is only loaded on our pages, so it won't affect other routes. */
                    .o_main_navbar,
                    header.o_main_navbar,
                    /* Website header variants */
                    #wrapwrap > header,
                    header#top,
                    .o_header_standard,
                    .o_header_affixed,
                    .o_header_mobile,
                    .o_website_preview_header,
                    /* Website footer variants */
                    .o_footer,
                    footer#footer,
                    #wrapwrap > footer {
                        display: none !important;
                    }
                    body {
                        padding-top: 0 !important;
                        margin-top: 0 !important;
                    }
                    :root {
                        /* Primary Colors - Modern Blue Gradient */
                        --stock-primary: #3b82f6;
                        --stock-primary-dark: #2563eb;
                        --stock-primary-darker: #1e40af;
                        --stock-primary-light: #60a5fa;
                        --stock-primary-lighter: #93c5fd;
                        --stock-primary-bg: rgba(59, 130, 246, 0.08);
                        
                        /* Success Colors - Vibrant Green */
                        --stock-success: #10b981;
                        --stock-success-dark: #059669;
                        --stock-success-light: #34d399;
                        --stock-success-bg: rgba(16, 185, 129, 0.08);
                        
                        /* Danger Colors - Modern Red */
                        --stock-danger: #ef4444;
                        --stock-danger-dark: #dc2626;
                        --stock-danger-light: #f87171;
                        --stock-danger-bg: rgba(239, 68, 68, 0.08);
                        
                        /* Warning Colors - Amber */
                        --stock-warning: #f59e0b;
                        --stock-warning-dark: #d97706;
                        --stock-warning-light: #fbbf24;
                        --stock-warning-bg: rgba(245, 158, 11, 0.08);
                        
                        /* Info Colors - Cyan */
                        --stock-info: #06b6d4;
                        --stock-info-dark: #0891b2;
                        --stock-info-light: #22d3ee;
                        --stock-info-bg: rgba(6, 182, 212, 0.08);
                        
                        /* Neutral Colors - Slate Scale */
                        --stock-gray-50: #f8fafc;
                        --stock-gray-100: #f1f5f9;
                        --stock-gray-200: #e2e8f0;
                        --stock-gray-300: #cbd5e1;
                        --stock-gray-400: #94a3b8;
                        --stock-gray-500: #64748b;
                        --stock-gray-600: #475569;
                        --stock-gray-700: #334155;
                        --stock-gray-800: #1e293b;
                        --stock-gray-900: #0f172a;
                        
                        /* Layout */
                        --stock-sidebar-width: 280px;
                        --stock-sidebar-width-collapsed: 80px;
                        --stock-navbar-height: 70px;
                        
                        /* Spacing */
                        --spacing-xs: 0.25rem;
                        --spacing-sm: 0.5rem;
                        --spacing-md: 1rem;
                        --spacing-lg: 1.5rem;
                        --spacing-xl: 2rem;
                        --spacing-2xl: 3rem;
                        
                        /* Border Radius */
                        --radius-sm: 0.375rem;
                        --radius-md: 0.5rem;
                        --radius-lg: 0.75rem;
                        --radius-xl: 1rem;
                        --radius-2xl: 1.5rem;
                        
                        /* Shadows */
                        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
                        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
                        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
                        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        
                        /* Typography */
                        --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
                        
                        /* Transitions */
                        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
                        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
                        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    * {
                        box-sizing: border-box;
                        margin: 0;
                        padding: 0;
                    }
                    
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: var(--font-sans);
                        background: linear-gradient(135deg, var(--stock-gray-50) 0%, var(--stock-gray-100) 100%);
                        color: var(--stock-gray-900);
                        overflow-x: hidden;
                        line-height: 1.6;
                        -webkit-font-smoothing: antialiased;
                        -moz-osx-font-smoothing: grayscale;
                    }
                    
                    /* Smooth Scrolling */
                    html {
                        scroll-behavior: smooth;
                    }
                    
                    /* Selection Color */
                    ::selection {
                        background-color: var(--stock-primary);
                        color: white;
                    }
                    
                    /* Stock Portal Layout */
                    .stock-portal-layout {
                        min-height: 100vh;
                        display: flex;
                    }
                    
                    /* Sidebar Styles */
                    .stock-sidebar {
                        width: var(--stock-sidebar-width);
                        background: white;
                        color: var(--stock-gray-900);
                        position: fixed;
                        left: 0;
                        top: 0;
                        height: 100vh;
                        z-index: 1000;
                        transition: width var(--transition-base), transform var(--transition-base);
                        overflow-y: auto;
                        overflow-x: hidden;
                        box-shadow: var(--shadow-lg);
                        border-right: 1px solid var(--stock-gray-200);
                    }
                    
                    /* Custom Scrollbar for Sidebar */
                    .stock-sidebar::-webkit-scrollbar {
                        width: 6px;
                    }
                    
                    .stock-sidebar::-webkit-scrollbar-track {
                        background: var(--stock-gray-100);
                    }
                    
                    .stock-sidebar::-webkit-scrollbar-thumb {
                        background: var(--stock-gray-400);
                        border-radius: 3px;
                    }
                    
                    .stock-sidebar::-webkit-scrollbar-thumb:hover {
                        background: var(--stock-gray-500);
                    }
                    
                    .stock-sidebar.collapsed {
                        width: var(--stock-sidebar-width-collapsed);
                    }
                    
                    .stock-sidebar-header {
                        padding: var(--spacing-lg);
                        border-bottom: 1px solid var(--stock-gray-200);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        min-height: 70px;
                        background: var(--stock-gray-50);
                    }
                    
                    .sidebar-brand {
                        display: flex;
                        align-items: center;
                        color: var(--stock-gray-900);
                        text-decoration: none;
                        font-weight: 700;
                        font-size: 1.25rem;
                        white-space: nowrap;
                        overflow: hidden;
                        transition: all var(--transition-base);
                    }
                    
                    .sidebar-brand:hover {
                        color: var(--stock-primary);
                        text-decoration: none;
                        transform: translateX(2px);
                    }
                    
                    .sidebar-brand-icon {
                        width: 40px;
                        height: 40px;
                        background: linear-gradient(135deg, var(--stock-primary) 0%, var(--stock-primary-dark) 100%);
                        border-radius: var(--radius-lg);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: var(--spacing-md);
                        flex-shrink: 0;
                        box-shadow: var(--shadow-md);
                        transition: all var(--transition-base);
                    }
                    
                    .sidebar-brand:hover .sidebar-brand-icon {
                        transform: scale(1.05) rotate(-5deg);
                        box-shadow: var(--shadow-lg);
                    }
                    
                    .sidebar-brand-text {
                        transition: opacity var(--transition-base);
                        letter-spacing: -0.01em;
                    }
                    
                    .stock-sidebar.collapsed .sidebar-brand-text {
                        opacity: 0;
                        width: 0;
                    }
                    
                    .stock-sidebar-toggle-icon {
                        background: var(--stock-gray-100);
                        border: 1px solid var(--stock-gray-300);
                        color: var(--stock-gray-700);
                        cursor: pointer;
                        padding: var(--spacing-sm);
                        border-radius: var(--radius-md);
                        transition: all var(--transition-base);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                    }
                    
                    .stock-sidebar-toggle-icon:hover {
                        background: var(--stock-gray-200);
                        border-color: var(--stock-gray-400);
                        color: var(--stock-primary);
                        transform: scale(1.1);
                    }
                    
                    .stock-sidebar-toggle-icon:active {
                        transform: scale(0.95);
                    }
                    
                    .stock-sidebar.collapsed .sidebar-toggle-collapse {
                        display: none;
                    }
                    
                    .sidebar-toggle-expand {
                        display: none;
                    }
                    
                    .stock-sidebar.collapsed .sidebar-toggle-expand {
                        display: block;
                    }
                    
                    .stock-sidebar-nav {
                        padding: var(--spacing-lg) 0;
                    }
                    
                    .sidebar-section {
                        margin-bottom: var(--spacing-xl);
                    }
                    
                    .stock-sidebar.collapsed .sidebar-section {
                        margin-bottom: var(--spacing-md);
                    }
                    
                    .sidebar-section-title {
                        padding: 0 var(--spacing-lg) var(--spacing-sm);
                        font-size: 0.6875rem;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.1em;
                        color: var(--stock-gray-500);
                        white-space: nowrap;
                        overflow: hidden;
                        transition: all var(--transition-base);
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-sm);
                    }
                    
                    .sidebar-section-title i {
                        font-size: 0.75rem;
                        color: var(--stock-gray-400);
                    }
                    
                    .stock-sidebar.collapsed .sidebar-section-title {
                        font-size: 0.5rem;
                        padding: 0 var(--spacing-xs) var(--spacing-xs);
                        letter-spacing: 0.02em;
                        text-align: center;
                        justify-content: center;
                    }
                    
                    .stock-sidebar.collapsed .sidebar-section-title i {
                        display: none;
                    }
                    
                    .nav-link {
                        display: flex;
                        align-items: center;
                        padding: var(--spacing-md) var(--spacing-lg);
                        color: var(--stock-gray-700);
                        text-decoration: none;
                        transition: all var(--transition-fast);
                        position: relative;
                        margin: var(--spacing-xs) var(--spacing-sm);
                        border-radius: var(--radius-md);
                        font-size: 0.9375rem;
                        font-weight: 500;
                    }
                    
                    .nav-link::before {
                        content: '';
                        position: absolute;
                        left: 0;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 3px;
                        height: 0;
                        background: var(--stock-primary);
                        border-radius: 0 2px 2px 0;
                        transition: height var(--transition-fast);
                    }
                    
                    .nav-link:hover {
                        background: var(--stock-gray-100);
                        color: var(--stock-primary);
                        text-decoration: none;
                        transform: translateX(4px);
                    }
                    
                    .nav-link:hover::before {
                        height: 60%;
                    }
                    
                    .nav-link.active {
                        background: linear-gradient(90deg, var(--stock-primary-bg) 0%, rgba(59, 130, 246, 0.02) 100%);
                        color: var(--stock-primary);
                        font-weight: 600;
                        box-shadow: inset 0 0 0 1px var(--stock-primary-light);
                    }
                    
                    .nav-link.active::before {
                        height: 70%;
                        background: var(--stock-primary);
                    }
                    
                    .nav-link i {
                        width: 20px;
                        margin-right: var(--spacing-md);
                        flex-shrink: 0;
                        text-align: center;
                        font-size: 1.125rem;
                        color: var(--stock-gray-600);
                        transition: color var(--transition-fast);
                    }
                    
                    .stock-sidebar.collapsed .nav-link {
                        justify-content: center;
                        padding: var(--spacing-md) var(--spacing-xs);
                    }
                    
                    .stock-sidebar.collapsed .nav-link i {
                        margin-right: 0;
                        font-size: 1.25rem;
                    }
                    
                    .nav-link:hover i,
                    .nav-link.active i {
                        color: var(--stock-primary);
                    }
                    
                    .nav-text {
                        white-space: nowrap;
                        overflow: hidden;
                        transition: opacity var(--transition-base);
                    }
                    
                    .stock-sidebar.collapsed .nav-text {
                        opacity: 0;
                        width: 0;
                    }
                    
                    .nav-badge {
                        margin-left: auto;
                        background: var(--stock-danger);
                        color: white;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        transition: opacity var(--transition-base);
                    }
                    
                    .stock-sidebar.collapsed .nav-badge {
                        opacity: 0;
                        width: 0;
                    }
                    
                    /* Main Content */
                    .stock-main-content {
                        flex: 1;
                        margin-left: var(--stock-sidebar-width);
                        transition: margin-left var(--transition-base);
                        min-height: 100vh;
                        display: flex;
                        flex-direction: column;
                        background: linear-gradient(135deg, var(--stock-gray-50) 0%, #f0f4f8 100%);
                    }
                    
                    .stock-sidebar.collapsed + .stock-main-content {
                        margin-left: var(--stock-sidebar-width-collapsed);
                    }
                    
                    /* Top Navbar */
                    .stock-navbar {
                        background: white;
                        border-bottom: 1px solid var(--stock-gray-200);
                        padding: var(--spacing-lg) var(--spacing-xl);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        min-height: var(--stock-navbar-height);
                        box-shadow: var(--shadow-sm);
                        backdrop-filter: blur(20px);
                        background: rgba(255, 255, 255, 0.95);
                        position: sticky;
                        top: 0;
                        z-index: 100;
                    }
                    
                    .navbar-title {
                        font-size: 1.75rem;
                        font-weight: 700;
                        color: var(--stock-gray-900);
                        display: flex;
                        align-items: center;
                        letter-spacing: -0.02em;
                    }
                    
                    .title-icon {
                        margin-right: var(--spacing-md);
                        color: var(--stock-primary);
                        font-size: 1.5rem;
                        animation: pulse 2s ease-in-out infinite;
                    }
                    
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: 0.7;
                        }
                    }
                    
                    .navbar-actions {
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-lg);
                    }
                    
                    .navbar-actions .alert {
                        margin: 0;
                        padding: var(--spacing-sm) var(--spacing-lg);
                        border-radius: var(--radius-lg);
                        font-size: 0.875rem;
                        box-shadow: var(--shadow-sm);
                        border: 1px solid;
                        font-weight: 500;
                    }
                    
                    .navbar-actions .alert-success {
                        background: var(--stock-success-bg);
                        border-color: var(--stock-success-light);
                        color: var(--stock-success-dark);
                    }
                    
                    .navbar-actions .alert-warning {
                        background: var(--stock-warning-bg);
                        border-color: var(--stock-warning-light);
                        color: var(--stock-warning-dark);
                    }
                    
                    /* User dropdown */
                    .navbar-user {
                        position: relative;
                    }
                    
                    .user-dropdown-toggle {
                        display: flex;
                        align-items: center;
                        text-decoration: none;
                        color: var(--stock-gray-700);
                        padding: var(--spacing-sm) var(--spacing-md);
                        border-radius: var(--radius-lg);
                        transition: all var(--transition-fast);
                        border: 1px solid transparent;
                    }
                    
                    .user-dropdown-toggle:hover {
                        background: var(--stock-gray-100);
                        color: var(--stock-gray-900);
                        text-decoration: none;
                        border-color: var(--stock-gray-200);
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .user-avatar {
                        width: 36px;
                        height: 36px;
                        background: linear-gradient(135deg, var(--stock-primary) 0%, var(--stock-primary-dark) 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        margin-right: var(--spacing-md);
                        font-size: 0.875rem;
                        box-shadow: var(--shadow-md);
                        border: 2px solid white;
                    }
                    
                    .user-info {
                        text-align: left;
                    }
                    
                    .user-name {
                        font-weight: 600;
                        line-height: 1.2;
                        font-size: 0.9375rem;
                        color: var(--stock-gray-900);
                    }
                    
                    .user-role {
                        font-size: 0.75rem;
                        color: var(--stock-gray-500);
                        text-transform: capitalize;
                        line-height: 1.2;
                        font-weight: 500;
                    }
                    
                    /* Dropdown Menu */
                    .dropdown-menu {
                        border: 1px solid var(--stock-gray-200);
                        box-shadow: var(--shadow-xl);
                        border-radius: var(--radius-lg);
                        padding: var(--spacing-sm);
                        margin-top: var(--spacing-sm);
                    }
                    
                    .dropdown-item {
                        padding: var(--spacing-sm) var(--spacing-md);
                        border-radius: var(--radius-md);
                        transition: all var(--transition-fast);
                        font-weight: 500;
                        font-size: 0.875rem;
                    }
                    
                    .dropdown-item:hover {
                        background: var(--stock-gray-100);
                        color: var(--stock-gray-900);
                    }
                    
                    .dropdown-item i {
                        width: 20px;
                        text-align: center;
                    }
                    
                    .dropdown-divider {
                        margin: var(--spacing-sm) 0;
                        border-color: var(--stock-gray-200);
                    }
                    
                    /* Dashboard Stats */
                    .stock-dashboard-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: var(--spacing-lg);
                        margin-bottom: var(--spacing-xl);
                    }
                    
                    .stock-stat-card {
                        background: white;
                        border-radius: var(--radius-xl);
                        padding: var(--spacing-xl);
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--stock-gray-200);
                        transition: all var(--transition-base);
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .stock-stat-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                        background: linear-gradient(90deg, var(--stock-primary) 0%, var(--stock-primary-light) 100%);
                        opacity: 0;
                        transition: opacity var(--transition-base);
                    }
                    
                    .stock-stat-card:hover {
                        transform: translateY(-4px);
                        box-shadow: var(--shadow-lg);
                        border-color: var(--stock-primary-light);
                    }
                    
                    .stock-stat-card:hover::before {
                        opacity: 1;
                    }
                    
                    .stat-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: var(--spacing-lg);
                    }
                    
                    .stat-title {
                        font-size: 0.875rem;
                        font-weight: 600;
                        color: var(--stock-gray-600);
                        margin: 0;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                    }
                    
                    .stat-icon {
                        width: 48px;
                        height: 48px;
                        border-radius: var(--radius-lg);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: var(--icon-bg);
                        color: var(--icon-color);
                        font-size: 1.25rem;
                        box-shadow: var(--shadow-sm);
                        transition: all var(--transition-base);
                    }
                    
                    .stock-stat-card:hover .stat-icon {
                        transform: scale(1.1) rotate(-5deg);
                        box-shadow: var(--shadow-md);
                    }
                    
                    .stat-value {
                        font-size: 2.25rem;
                        font-weight: 800;
                        color: var(--stock-gray-900);
                        line-height: 1;
                        margin-bottom: var(--spacing-sm);
                        font-family: var(--font-mono);
                        letter-spacing: -0.02em;
                    }
                    
                    .stat-change {
                        font-size: 0.8125rem;
                        color: var(--stock-gray-600);
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-xs);
                    }
                    
                    .stat-change.positive {
                        color: var(--stock-success);
                    }
                    
                    .stat-change.negative {
                        color: var(--stock-danger);
                    }
                    
                    .stat-change i {
                        font-size: 0.75rem;
                    }
                    
                    /* Card Components */
                    .card {
                        background: white;
                        border-radius: var(--radius-xl);
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--stock-gray-200);
                        overflow: hidden;
                        transition: all var(--transition-base);
                    }
                    
                    .card:hover {
                        box-shadow: var(--shadow-md);
                    }
                    
                    .card-header {
                        background: linear-gradient(135deg, var(--stock-gray-50) 0%, white 100%);
                        border-bottom: 1px solid var(--stock-gray-200);
                        padding: var(--spacing-lg) var(--spacing-xl);
                    }
                    
                    .card-header h4,
                    .card-header h5,
                    .card-header h6 {
                        margin: 0;
                        font-weight: 700;
                        color: var(--stock-gray-900);
                    }
                    
                    .card-body {
                        padding: var(--spacing-xl);
                    }
                    
                    /* Buttons */
                    .btn {
                        padding: var(--spacing-sm) var(--spacing-lg);
                        border-radius: var(--radius-md);
                        font-weight: 600;
                        font-size: 0.875rem;
                        transition: all var(--transition-fast);
                        border: 1px solid transparent;
                        display: inline-flex;
                        align-items: center;
                        gap: var(--spacing-sm);
                        cursor: pointer;
                    }
                    
                    .btn-primary {
                        background: linear-gradient(135deg, var(--stock-primary) 0%, var(--stock-primary-dark) 100%);
                        color: white;
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md);
                        color: white;
                    }
                    
                    .btn-success {
                        background: linear-gradient(135deg, var(--stock-success) 0%, var(--stock-success-dark) 100%);
                        color: white;
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .btn-success:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md);
                        color: white;
                    }
                    
                    .btn-danger {
                        background: linear-gradient(135deg, var(--stock-danger) 0%, var(--stock-danger-dark) 100%);
                        color: white;
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .btn-danger:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md);
                        color: white;
                    }
                    
                    .btn-secondary {
                        background: var(--stock-gray-100);
                        color: var(--stock-gray-700);
                        border-color: var(--stock-gray-300);
                    }
                    
                    .btn-secondary:hover {
                        background: var(--stock-gray-200);
                        border-color: var(--stock-gray-400);
                        color: var(--stock-gray-900);
                    }
                    
                    .btn:active {
                        transform: translateY(0) scale(0.98);
                    }
                    
                    .btn:disabled {
                        opacity: 0.6;
                        cursor: not-allowed;
                        transform: none !important;
                    }
                    
                    /* Tables */
                    .table {
                        width: 100%;
                        margin: 0;
                    }
                    
                    .table thead {
                        background: linear-gradient(135deg, var(--stock-gray-50) 0%, white 100%);
                        border-bottom: 2px solid var(--stock-gray-200);
                    }
                    
                    .table thead th {
                        font-weight: 700;
                        font-size: 0.8125rem;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                        color: var(--stock-gray-700);
                        padding: var(--spacing-md) var(--spacing-lg);
                        border: none;
                    }
                    
                    .table tbody tr {
                        transition: all var(--transition-fast);
                        border-bottom: 1px solid var(--stock-gray-100);
                    }
                    
                    .table tbody tr:last-child {
                        border-bottom: none;
                    }
                    
                    .table tbody tr:hover {
                        background: var(--stock-gray-50);
                        transform: scale(1.005);
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .table tbody td {
                        padding: var(--spacing-md) var(--spacing-lg);
                        color: var(--stock-gray-800);
                        font-size: 0.875rem;
                    }
                    
                    .table-striped tbody tr:nth-of-type(odd) {
                        background: rgba(248, 250, 252, 0.5);
                    }
                    
                    .table-hover tbody tr:hover {
                        background: var(--stock-primary-bg);
                    }
                    
                    .table-sm th,
                    .table-sm td {
                        padding: var(--spacing-sm) var(--spacing-md);
                    }
                    
                    /* Form Controls */
                    .form-control,
                    .form-select {
                        padding: var(--spacing-sm) var(--spacing-md);
                        border: 1px solid var(--stock-gray-300);
                        border-radius: var(--radius-md);
                        font-size: 0.9375rem;
                        transition: all var(--transition-fast);
                        background: white;
                        color: var(--stock-gray-900);
                    }
                    
                    .form-control:focus,
                    .form-select:focus {
                        outline: none;
                        border-color: var(--stock-primary);
                        box-shadow: 0 0 0 3px var(--stock-primary-bg);
                    }
                    
                    .form-control:hover,
                    .form-select:hover {
                        border-color: var(--stock-gray-400);
                    }
                    
                    .form-label {
                        font-weight: 600;
                        font-size: 0.875rem;
                        color: var(--stock-gray-700);
                        margin-bottom: var(--spacing-sm);
                        display: block;
                    }
                    
                    .form-group {
                        margin-bottom: var(--spacing-lg);
                    }
                    
                    .form-text {
                        font-size: 0.8125rem;
                        color: var(--stock-gray-500);
                        margin-top: var(--spacing-xs);
                    }
                    
                    /* Badges */
                    .badge {
                        padding: var(--spacing-xs) var(--spacing-md);
                        border-radius: var(--radius-md);
                        font-weight: 600;
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        letter-spacing: 0.025em;
                        display: inline-flex;
                        align-items: center;
                        gap: var(--spacing-xs);
                    }
                    
                    .badge-primary,
                    .bg-primary {
                        background: var(--stock-primary) !important;
                        color: white;
                    }
                    
                    .badge-success,
                    .bg-success {
                        background: var(--stock-success) !important;
                        color: white;
                    }
                    
                    .badge-danger,
                    .bg-danger {
                        background: var(--stock-danger) !important;
                        color: white;
                    }
                    
                    .badge-warning,
                    .bg-warning {
                        background: var(--stock-warning) !important;
                        color: white;
                    }
                    
                    .badge-info,
                    .bg-info {
                        background: var(--stock-info) !important;
                        color: white;
                    }
                    
                    .badge-secondary,
                    .bg-secondary {
                        background: var(--stock-gray-600) !important;
                        color: white;
                    }
                    
                    /* Alerts */
                    .alert {
                        padding: var(--spacing-md) var(--spacing-lg);
                        border-radius: var(--radius-lg);
                        border: 1px solid;
                        font-weight: 500;
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-md);
                    }
                    
                    .alert i {
                        font-size: 1.25rem;
                    }
                    
                    .alert-success {
                        background: var(--stock-success-bg);
                        border-color: var(--stock-success-light);
                        color: var(--stock-success-dark);
                    }
                    
                    .alert-danger {
                        background: var(--stock-danger-bg);
                        border-color: var(--stock-danger-light);
                        color: var(--stock-danger-dark);
                    }
                    
                    .alert-warning {
                        background: var(--stock-warning-bg);
                        border-color: var(--stock-warning-light);
                        color: var(--stock-warning-dark);
                    }
                    
                    .alert-info {
                        background: var(--stock-info-bg);
                        border-color: var(--stock-info-light);
                        color: var(--stock-info-dark);
                    }
                    
                    /* Text Colors */
                    .text-success {
                        color: var(--stock-success) !important;
                    }
                    
                    .text-danger {
                        color: var(--stock-danger) !important;
                    }
                    
                    .text-warning {
                        color: var(--stock-warning) !important;
                    }
                    
                    .text-info {
                        color: var(--stock-info) !important;
                    }
                    
                    .text-primary {
                        color: var(--stock-primary) !important;
                    }
                    
                    .text-muted {
                        color: var(--stock-gray-500) !important;
                    }
                    
                    /* Utilities */
                    .page-header {
                        margin-bottom: var(--spacing-xl);
                        padding-bottom: var(--spacing-lg);
                        border-bottom: 2px solid var(--stock-gray-200);
                    }
                    
                    .page-header h1,
                    .page-header h2 {
                        font-weight: 800;
                        color: var(--stock-gray-900);
                        margin: 0;
                        letter-spacing: -0.02em;
                    }
                    
                    .table-responsive {
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                    }
                    
                    .table-responsive::-webkit-scrollbar {
                        height: 8px;
                    }
                    
                    .table-responsive::-webkit-scrollbar-track {
                        background: var(--stock-gray-100);
                        border-radius: 4px;
                    }
                    
                    .table-responsive::-webkit-scrollbar-thumb {
                        background: var(--stock-gray-400);
                        border-radius: 4px;
                    }
                    
                    .table-responsive::-webkit-scrollbar-thumb:hover {
                        background: var(--stock-gray-500);
                    }
                    
                    /* Spinner Animation */
                    .spinner-border {
                        animation: spinner 0.75s linear infinite;
                    }
                    
                    @keyframes spinner {
                        to {
                            transform: rotate(360deg);
                        }
                    }
                    
                    /* Loading States */
                    .btn .spinner-border-sm {
                        width: 1rem;
                        height: 1rem;
                        border-width: 0.15em;
                    }
                    @media (max-width: 1024px) {
                        .stock-dashboard-stats {
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: var(--spacing-md);
                        }
                        
                        .stat-value {
                            font-size: 1.75rem;
                        }
                        
                        .navbar-title {
                            font-size: 1.5rem;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        .stock-sidebar {
                            transform: translateX(-100%);
                            width: var(--stock-sidebar-width);
                        }
                        
                        .stock-sidebar.collapsed {
                            transform: translateX(0);
                            width: var(--stock-sidebar-width-collapsed);
                        }
                        
                        .stock-main-content {
                            margin-left: 0;
                        }
                        
                        .stock-dashboard-stats {
                            grid-template-columns: 1fr;
                        }
                        
                        .navbar-actions {
                            gap: var(--spacing-sm);
                        }
                        
                        .navbar-actions .alert {
                            font-size: 0.75rem;
                            padding: var(--spacing-xs) var(--spacing-sm);
                        }
                        
                        .user-name,
                        .user-role {
                            display: none;
                        }
                        
                        .card-header,
                        .card-body {
                            padding: var(--spacing-md);
                        }
                        
                        .table thead th,
                        .table tbody td {
                            padding: var(--spacing-sm) var(--spacing-md);
                            font-size: 0.8125rem;
                        }
                    }
                    
                    @media (max-width: 576px) {
                        .navbar-title {
                            font-size: 1.25rem;
                        }
                        
                        .stat-value {
                            font-size: 1.5rem;
                        }
                        
                        .stock-stat-card {
                            padding: var(--spacing-lg);
                        }
                        
                        .btn {
                            padding: var(--spacing-sm) var(--spacing-md);
                            font-size: 0.8125rem;
                        }
                    }
                    
                    /* Accessibility Improvements */
                    .btn:focus-visible,
                    .nav-link:focus-visible,
                    .form-control:focus-visible,
                    .form-select:focus-visible {
                        outline: 2px solid var(--stock-primary);
                        outline-offset: 2px;
                    }
                    
                    /* Reduced Motion */
                    @media (prefers-reduced-motion: reduce) {
                        *,
                        *::before,
                        *::after {
                            animation-duration: 0.01ms !important;
                            animation-iteration-count: 1 !important;
                            transition-duration: 0.01ms !important;
                        }
                    }
                    
                    /* Fade In Animation for Page Load */
                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    .stock-main-content > .container-fluid {
                        animation: fadeIn 0.4s ease-out;
                    }
                    
                    /* Pagination */
                    .pagination {
                        display: flex;
                        gap: var(--spacing-xs);
                        list-style: none;
                        padding: 0;
                        margin: var(--spacing-lg) 0;
                    }
                    
                    .page-item {
                        display: flex;
                    }
                    
                    .page-link {
                        padding: var(--spacing-sm) var(--spacing-md);
                        border: 1px solid var(--stock-gray-300);
                        border-radius: var(--radius-md);
                        color: var(--stock-gray-700);
                        text-decoration: none;
                        transition: all var(--transition-fast);
                        font-weight: 500;
                    }
                    
                    .page-link:hover {
                        background: var(--stock-primary);
                        color: white;
                        border-color: var(--stock-primary);
                    }
                    
                    .page-item.active .page-link {
                        background: var(--stock-primary);
                        color: white;
                        border-color: var(--stock-primary);
                    }
                    
                    .page-item.disabled .page-link {
                        opacity: 0.5;
                        cursor: not-allowed;
                        pointer-events: none;
                    }
                    
                    /* Modal Enhancements */
                    .modal-content {
                        border-radius: var(--radius-xl);
                        border: 1px solid var(--stock-gray-200);
                        box-shadow: var(--shadow-2xl);
                    }
                    
                    .modal-header {
                        border-bottom: 1px solid var(--stock-gray-200);
                        padding: var(--spacing-lg) var(--spacing-xl);
                        background: linear-gradient(135deg, var(--stock-gray-50) 0%, white 100%);
                    }
                    
                    .modal-body {
                        padding: var(--spacing-xl);
                    }
                    
                    .modal-footer {
                        border-top: 1px solid var(--stock-gray-200);
                        padding: var(--spacing-lg) var(--spacing-xl);
                        background: var(--stock-gray-50);
                    }
                    
                    /* Tab Navigation */
                    .nav-tabs {
                        border-bottom: 2px solid var(--stock-gray-200);
                        gap: var(--spacing-sm);
                    }
                    
                    .nav-tabs .nav-link {
                        border: none;
                        border-bottom: 2px solid transparent;
                        color: var(--stock-gray-600);
                        font-weight: 600;
                        padding: var(--spacing-md) var(--spacing-lg);
                        margin: 0;
                        border-radius: 0;
                        transition: all var(--transition-fast);
                    }
                    
                    .nav-tabs .nav-link:hover {
                        color: var(--stock-primary);
                        border-bottom-color: var(--stock-primary-light);
                        background: transparent;
                    }
                    
                    .nav-tabs .nav-link.active {
                        color: var(--stock-primary);
                        border-bottom-color: var(--stock-primary);
                        background: transparent;
                    }
                </style>
                
                <!-- Bootstrap JS -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
            </head>
            <body>
                <div class="stock-portal-layout">
                    <t t-raw="0"/>
                </div>
            </body>
        </html>
    </template>
    
    <!-- Market Portal Layout - Uses the standalone layout -->
    <template id="market_portal_layout" name="Stock Market Portal Layout">
        <t t-call="stock_market_simulation.stock_standalone_layout">
            <t t-set="page_title" t-value="page_title or 'Stock Market Portal'"/>
            
            <!-- Auto-fetch active session if not provided -->
            <t t-if="not active_session">
                <t t-set="active_session" t-value="request.env['stock.session'].sudo().search([('state', '=', 'open')], limit=1)"/>
            </t>
            
            <!-- Sidebar Navigation -->
            <nav class="stock-sidebar" id="stockSidebar">
                <!-- Sidebar Header -->
                <div class="stock-sidebar-header">
                    <a href="/market" class="sidebar-brand">
                        <div class="sidebar-brand-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span class="sidebar-brand-text">Stock Market</span>
                    </a>
                    <button type="button" class="stock-sidebar-toggle-icon" aria-label="Toggle sidebar" tabindex="0">
                        <i class="fas fa-angle-left sidebar-toggle-collapse"></i>
                        <i class="fas fa-angle-right sidebar-toggle-expand"></i>
                    </button>
                </div>
                
                <!-- Sidebar Navigation -->
                <div class="stock-sidebar-nav">
                    <!-- Main Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Trading</div>
                        <a href="/market" class="nav-link" data-page="dashboard" data-tooltip="Dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                        <t t-if="request.env.user.user_type in ['broker', 'investor', 'admin'] or request.env.user.has_group('base.group_system')">
                            <a href="/market/trading" class="nav-link" data-page="trading" data-tooltip="Trading">
                                <i class="fas fa-exchange-alt"></i>
                                <span class="nav-text">Trading</span>
                            </a>
                        </t>
                        <t t-if="request.env.user.user_type in ['investor', 'broker', 'admin']">
                            <a href="/market/orders" class="nav-link" data-page="orders" data-tooltip="Orders">
                                <i class="fas fa-list"></i>
                                <span class="nav-text">Orders</span>
                                <span class="nav-badge" t-if="order_count"><t t-esc="order_count"/></span>
                            </a>
                        </t>
                    </div>
                    
                    <!-- Portfolio Section -->
                    <t t-if="request.env.user.user_type in ['investor', 'broker', 'admin']">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Portfolio</div>
                            <a href="/market/portfolio" class="nav-link" data-page="portfolio" data-tooltip="Positions">
                                <i class="fas fa-briefcase"></i>
                                <span class="nav-text">Positions</span>
                                <span class="nav-badge" t-if="position_count"><t t-esc="position_count"/></span>
                            </a>
                            <a href="/market/trades" class="nav-link" data-page="trades" data-tooltip="Trade History">
                                <i class="fas fa-history"></i>
                                <span class="nav-text">Trade History</span>
                            </a>
                            <a href="/market/performance" class="nav-link" data-page="performance" data-tooltip="Performance">
                                <i class="fas fa-chart-area"></i>
                                <span class="nav-text">Performance</span>
                            </a>
                        </div>
                    </t>
                    
                    <!-- Banking Section -->
                    <t t-if="request.env.user.user_type in ['investor', 'banker', 'admin']">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Banking</div>
                            <a href="/market/deposits" class="nav-link" data-page="deposits" data-tooltip="Deposits">
                                <i class="fas fa-university"></i>
                                <span class="nav-text">Deposits</span>
                                <span class="nav-badge" t-if="deposit_count"><t t-esc="deposit_count"/></span>
                            </a>
                            <a href="/market/loans" class="nav-link" data-page="loans" data-tooltip="Loans">
                                <i class="fas fa-money-bill"></i>
                                <span class="nav-text">Loans</span>
                                <span class="nav-badge" t-if="loan_count"><t t-esc="loan_count"/></span>
                            </a>
                        </div>
                    </t>
                    
                    <!-- Broker Section -->
                    <t t-if="request.env.user.user_type in ['broker', 'admin', 'superadmin'] or request.env.user.has_group('base.group_system')">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Broker Tools</div>
                            <a href="/market/commissions" class="nav-link" data-page="commissions" data-tooltip="Commissions">
                                <i class="fas fa-percentage"></i>
                                <span class="nav-text">Commissions</span>
                            </a>
                            <a href="/market/clients" class="nav-link" data-page="clients" data-tooltip="Clients">
                                <i class="fas fa-users"></i>
                                <span class="nav-text">Clients</span>
                            </a>
                        </div>
                    </t>
                    
                    <!-- Market Data Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Market</div>
                        <a href="/market/securities" class="nav-link" data-page="securities" data-tooltip="Securities">
                            <i class="fas fa-chart-bar"></i>
                            <span class="nav-text">Securities</span>
                        </a>
                        <a href="/market/session" class="nav-link" data-page="session" data-tooltip="Session Info">
                            <i class="fas fa-clock"></i>
                            <span class="nav-text">Session Info</span>
                        </a>
                        <a href="/market/reports" class="nav-link" data-page="reports" data-tooltip="Reports">
                            <i class="fas fa-file-alt"></i>
                            <span class="nav-text">Reports</span>
                        </a>
                        <t t-if="request.env.user.user_type in ['admin', 'superadmin', 'broker']">
                            <a href="/market/ipo" class="nav-link" data-page="ipo" data-tooltip="IPO &amp; Allocation">
                                <i class="fas fa-rocket"></i>
                                <span class="nav-text">IPO &amp; Allocation</span>
                            </a>
                        </t>
                    </div>
                    
                    <!-- Administration Section -->
                    <t t-if="request.env.user.user_type in ['admin', 'superadmin'] or request.env.user.has_group('base.group_system')">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="fas fa-lock"></i> Administration
                            </div>
                            <a href="/market/admin/users" class="nav-link" data-page="admin-users" data-tooltip="Manage Users">
                                <i class="fas fa-users"></i>
                                <span class="nav-text">Users Management</span>
                            </a>
                            <a href="/market/admin/users" class="nav-link" data-page="admin-analytics" data-tooltip="User Analytics">
                                <i class="fas fa-chart-bar"></i>
                                <span class="nav-text">User Analytics</span>
                            </a>
                        </div>
                    </t>
                    
                    <!-- Account Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Account</div>
                        <a href="/my/account" class="nav-link" data-page="account" data-tooltip="Settings">
                            <i class="fas fa-cog"></i>
                            <span class="nav-text">Settings</span>
                        </a>
                        <a href="/web/session/logout" class="nav-link" data-tooltip="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="nav-text">Logout</span>
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="stock-main-content">
                <!-- Top Navigation Bar -->
                <header class="stock-navbar">
                    <div class="navbar-title">
                        <i class="fas fa-chart-line title-icon"></i>
                        <span t-esc="page_title or 'Stock Market Portal'"/>
                    </div>
                    
                    <div class="navbar-actions">
                        <!-- Active Session Information -->
                        <t t-if="active_session">
                            <div class="alert alert-success mb-0 py-1 px-3">
                                <small>
                                    <i class="fas fa-clock text-success me-1"></i>
                                    Active: <strong t-esc="active_session.name"/>
                                    <t t-if="active_session.planned_end_date">
                                        (ends <t t-esc="active_session.planned_end_date.strftime('%H:%M')"/>)
                                    </t>
                                </small>
                            </div>
                        </t>
                        <t t-if="not active_session">
                            <div class="alert alert-warning mb-0 py-1 px-3">
                                <small><i class="fas fa-clock text-warning me-1"></i>No active session</small>
                            </div>
                        </t>
                        
                        <!-- User Info with Dropdown -->
                        <div class="navbar-user dropdown">
                            <a href="#" class="user-dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="user-avatar">
                                    <t t-esc="request.env.user.name[:2].upper()"/>
                                </div>
                                <div class="user-info">
                                    <div class="user-name" t-esc="request.env.user.name"/>
                                    <div class="user-role" t-esc="request.env.user.user_type"/>
                                </div>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/my/home"><i class="fas fa-user me-2"></i>My Account</a></li>
                                <t t-if="request.env.user.user_type in ['admin', 'superadmin'] or request.env.user.has_group('base.group_system')">
                                    <li><hr class="dropdown-divider"/></li>
                                    <li><a class="dropdown-item" href="/market/admin/users"><i class="fas fa-users me-2"></i>Admin: Users</a></li>
                                    <li><a class="dropdown-item" href="/market/admin/users"><i class="fas fa-chart-bar me-2"></i>Admin: Analytics</a></li>
                                    <li><hr class="dropdown-divider"/></li>
                                </t>
                                <li><a class="dropdown-item" href="/odoo"><i class="fas fa-th me-2"></i>Backend</a></li>
                                <li><hr class="dropdown-divider"/></li>
                                <li><a class="dropdown-item" href="/web/session/logout?redirect=/"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </header>
                
                <!-- Page Content -->
                <div class="container-fluid px-4 py-4">
                    <!-- Financial Summary Cards (hidden on trading page) -->
                    <t t-if="not hide_stats">
                        <div class="stock-dashboard-stats mb-4">
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Cash Balance</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-success-light); --icon-color: var(--stock-success);">
                                        <i class="fa fa-money"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(cash_balance or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Available for trading
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Portfolio Value</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-info-light); --icon-color: var(--stock-info);">
                                        <i class="fa fa-briefcase"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(portfolio_value or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Current market value
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Total Assets</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-primary-light); --icon-color: var(--stock-primary);">
                                        <i class="fa fa-pie-chart"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(total_assets or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Cash + Portfolio
                                </div>
                            </div>
                            
                            <div t-attf-class="#{(profit_loss or 0.0) >= 0 and 'profit stock-stat-card' or 'loss stock-stat-card'}">
                                <div class="stat-header">
                                    <h6 class="stat-title">P&amp;L</h6>
                                    <div class="stat-icon" t-attf-style="--icon-bg: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success-light)' or 'var(--stock-danger-light)'}; --icon-color: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success)' or 'var(--stock-danger)'};">
                                        <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(profit_loss or 0.0)"/>
                                </div>
                                <div t-attf-class="stat-change #{(profit_loss or 0.0) >= 0 and 'positive' or 'negative'}">
                                    <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    <t t-esc="profit_loss_percentage or 0.0"/>%
                                </div>
                            </div>
                        </div>
                    </t>

                    <!-- Main Page Content -->
                    <t t-raw="0"/>
                </div>
                
                <!-- Sidebar Toggle Script -->
                <script>
                    //<![CDATA[
                    (function() {
                        'use strict';
                        
                        // Configuration
                        const SIDEBAR_STATE_KEY = 'stock_sidebar_collapsed';
                        const MOBILE_BREAKPOINT = 768;
                        
                        // Global toggle function
                        window.toggleStockSidebar = function() {
                            const sidebar = document.getElementById('stockSidebar');
                            if (!sidebar) return;
                            
                            sidebar.classList.toggle('collapsed');
                            
                            // Save state to localStorage
                            const isCollapsed = sidebar.classList.contains('collapsed');
                            try {
                                localStorage.setItem(SIDEBAR_STATE_KEY, isCollapsed.toString());
                            } catch (e) {
                                console.warn('Failed to save sidebar state:', e);
                            }
                        };
                        
                        // Initialize when DOM is ready
                        function initSidebar() {
                            const sidebar = document.getElementById('stockSidebar');
                            if (!sidebar) return;
                            
                            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
                            
                            // Load saved state (desktop only)
                            if (!isMobile) {
                                const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
                                if (savedState === 'true') {
                                    sidebar.classList.add('collapsed');
                                }
                            } else {
                                // Force collapsed on mobile
                                sidebar.classList.add('collapsed');
                            }
                            
                            // Setup toggle button click handler
                            const toggleBtn = sidebar.querySelector('.stock-sidebar-toggle-icon');
                            if (toggleBtn) {
                                toggleBtn.addEventListener('click', toggleStockSidebar);
                                
                                // Keyboard support
                                toggleBtn.addEventListener('keydown', function(e) {
                                    if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        toggleStockSidebar();
                                    }
                                });
                            }
                            
                            // Set active navigation
                            setActiveNavigation();
                        }
                        
                        function setActiveNavigation() {
                            const currentPath = window.location.pathname;
                            const navLinks = document.querySelectorAll('.stock-sidebar .nav-link');
                            
                            let hasMatch = false;
                            
                            navLinks.forEach(link => {
                                link.classList.remove('active');
                                const href = link.getAttribute('href');
                                
                                if (!href) return;
                                
                                // Exact match for root paths
                                if (href === '/market' || href === '/market/') {
                                    if (currentPath === '/market' || currentPath === '/market/' || currentPath === '/market/dashboard') {
                                        link.classList.add('active');
                                        hasMatch = true;
                                    }
                                } else {
                                    // For other paths, check if current path starts with href
                                    if (currentPath === href || currentPath.startsWith(href + '/')) {
                                        link.classList.add('active');
                                        hasMatch = true;
                                    }
                                }
                            });
                        }
                        
                        // Initialize
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', initSidebar);
                        } else {
                            initSidebar();
                        }
                    })();
                    //]]>
                </script>
            </main>
        </t>
    </template>


    <!-- IPO & Direct Allocation Page -->
    <template id="portal_ipo_page" name="IPO &amp; Allocation">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2"><i class="fa fa-rocket"/> IPO &amp; Direct Allocation</h1>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>IPO Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Security</label>
                                    <select class="form-control" id="ipo_security">
                                        <option value="">-- Select --</option>
                                        <t t-foreach="securities" t-as="sec">
                                            <option t-att-value="sec.id"><t t-esc="sec.symbol"/> - <t t-esc="sec.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>IPO Price</label>
                                    <input type="number" class="form-control" id="ipo_price" step="0.01" min="0.01"/>
                                </div>
                                <div class="form-group">
                                    <label>Total Shares</label>
                                    <input type="number" class="form-control" id="ipo_total_shares" min="0" placeholder="Optional"/>
                                </div>
                                <div class="form-group">
                                    <label>Allocation Quantity</label>
                                    <input type="number" class="form-control" id="ipo_alloc_qty" min="0" placeholder="Optional"/>
                                </div>
                                <button class="btn btn-primary" id="btn_run_ipo">Run IPO</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Direct Allocation</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Investor</label>
                                    <select class="form-control" id="alloc_user_id">
                                        <option value="">-- Select Investor --</option>
                                        <t t-foreach="investors" t-as="investor">
                                            <option t-att-value="investor.id">
                                                <t t-esc="investor.name"/> 
                                                <span class="text-muted">
                                                    (ID: <t t-esc="investor.id"/>, Balance: $<t t-esc="'{:,.2f}'.format(investor.cash_balance)"/>)
                                                </span>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Security</label>
                                    <select class="form-control" id="alloc_security">
                                        <option value="">-- Select --</option>
                                        <t t-foreach="securities" t-as="sec">
                                            <option t-att-value="sec.id"><t t-esc="sec.symbol"/> - <t t-esc="sec.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-control" id="alloc_qty" min="1"/>
                                </div>
                                <div class="form-group">
                                    <label>Price</label>
                                    <input type="number" class="form-control" id="alloc_price" step="0.01" min="0.01"/>
                                </div>
                                <button class="btn btn-success" id="btn_direct_alloc">Allocate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>//<![CDATA[
            document.addEventListener('DOMContentLoaded', function() {
                const btnIPO = document.getElementById('btn_run_ipo');
                const btnAlloc = document.getElementById('btn_direct_alloc');
                function toast(msg, type='info') {
                    if (window.stockPortal && window.stockPortal.showNotification) {
                        window.stockPortal.showNotification('Info', msg, type);
                    } else { alert(msg); }
                }
                if (btnIPO) {
                    btnIPO.addEventListener('click', async function() {
                        const security_id = document.getElementById('ipo_security').value;
                        const ipo_price = document.getElementById('ipo_price').value;
                        const total_shares = document.getElementById('ipo_total_shares').value;
                        const ipo_quantity = document.getElementById('ipo_alloc_qty').value;
                        
                        // Validate required fields
                        if (!security_id) {
                            toast('Please select a security', 'danger');
                            return;
                        }
                        if (!ipo_price || ipo_price <= 0) {
                            toast('Please enter a valid IPO price', 'danger');
                            return;
                        }
                        
                        try {
                            const resp = await fetch('/market/ipo/create', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({security_id, ipo_price, total_shares, ipo_quantity})
                            });
                            const raw = await resp.json();
                            const payload = raw?.result || raw;
                            if (payload.success) {
                                toast('IPO processed successfully', 'success');
                                // Clear form
                                document.getElementById('ipo_security').value = '';
                                document.getElementById('ipo_price').value = '';
                                document.getElementById('ipo_total_shares').value = '';
                                document.getElementById('ipo_alloc_qty').value = '';
                            } else {
                                toast(payload.error || 'IPO failed', 'danger');
                            }
                        } catch (e) { 
                            toast('Network error: ' + e.message, 'danger'); 
                        }
                    });
                }
                if (btnAlloc) {
                    btnAlloc.addEventListener('click', async function() {
                        const user_id = document.getElementById('alloc_user_id').value;
                        const security_id = document.getElementById('alloc_security').value;
                        const quantity = document.getElementById('alloc_qty').value;
                        const price = document.getElementById('alloc_price').value;
                        
                        // Validate required fields
                        if (!user_id) {
                            toast('Please select an investor', 'danger');
                            return;
                        }
                        if (!security_id) {
                            toast('Please select a security', 'danger');
                            return;
                        }
                        if (!quantity || quantity <= 0) {
                            toast('Please enter a valid quantity', 'danger');
                            return;
                        }
                        if (!price || price <= 0) {
                            toast('Please enter a valid price', 'danger');
                            return;
                        }
                        
                        try {
                            const resp = await fetch('/market/allocation/direct', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id, security_id, quantity, price})
                            });
                            const raw = await resp.json();
                            const payload = raw?.result || raw;
                            if (payload.success) {
                                toast('Allocation completed successfully', 'success');
                                // Clear form
                                document.getElementById('alloc_user_id').value = '';
                                document.getElementById('alloc_security').value = '';
                                document.getElementById('alloc_qty').value = '';
                                document.getElementById('alloc_price').value = '';
                            } else {
                                toast(payload.error || 'Allocation failed', 'danger');
                            }
                        } catch (e) { 
                            toast('Network error: ' + e.message, 'danger'); 
                        }
                    });
                }
            });
            //]]></script>
        </t>
    </template>
    
    <!-- Market Dashboard View -->
    <template id="market_dashboard_view" name="Market Dashboard View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="page_title">Dashboard</t>
            
            <!-- Quick Actions -->
            <div class="row mb-4" t-if="user.user_type == 'investor'">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <a href="/market/orders" class="btn btn-primary">
                                    <i class="fa fa-exchange"></i> Place Order
                                </a>
                                <a href="/market/portfolio" class="btn btn-info">
                                    <i class="fa fa-briefcase"></i> View Portfolio
                                </a>
                                <a href="/market/orders" class="btn btn-secondary">
                                    <i class="fa fa-list"></i> My Orders
                                </a>
                                <a href="/my/banking" class="btn btn-success">
                                    <i class="fa fa-university"></i> Banking
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Movers -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-up"></i> Top Gainers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_gainers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_gainers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            $<t t-esc="'{:,.2f}'.format(security.current_price)"/>
                                        </td>
                                        <td class="text-end text-success">
                                            +<t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_gainers">No gainers today</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-down"></i> Top Losers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_losers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_losers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            $<t t-esc="'{:,.2f}'.format(security.current_price)"/>
                                        </td>
                                        <td class="text-end text-danger">
                                            <t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_losers">No losers today</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Securities -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa fa-line-chart"></i> All Securities</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" t-if="securities">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Change</th>
                                            <th class="text-end">Change %</th>
                                            <th class="text-end">Volume</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="securities" t-as="sec">
                                            <td><strong><t t-esc="sec.symbol"/></strong></td>
                                            <td><t t-esc="sec.name"/></td>
                                            <td><span class="badge bg-secondary"><t t-esc="sec.security_type"/></span></td>
                                            <td class="text-end">
                                                $<t t-esc="'{:,.2f}'.format(sec.current_price)"/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                $<t t-esc="'{:,.2f}'.format(sec.change_amount)"/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="sec.change_percentage"/>%
                                            </td>
                                            <td class="text-end"><t t-esc="sec.volume_today"/></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p class="text-center text-muted p-3 mb-0" t-if="not securities">No securities available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </t>
    </template>
    
    <!-- Market Portfolio View -->
    <template id="market_portfolio_view" name="Market Portfolio View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-briefcase me-2"></i>My Portfolio</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Security</th>
                                    <th>Quantity</th>
                                    <th>Avg Cost</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>P&amp;L</th>
                                    <th>P&amp;L %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="positions" t-as="position">
                                    <td><strong><t t-esc="position.security_id.symbol"/></strong><br/><small class="text-muted"><t t-esc="position.security_id.name"/></small></td>
                                    <td><t t-esc="position.quantity"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.average_cost or 0.0)"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.security_id.current_price or 0.0)"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.market_value or 0.0)"/></td>
                                    <td t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        $<t t-esc="'{:,.2f}'.format(position.unrealized_pnl or 0.0)"/>
                                    </td>
                                    <td t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl_percent or 0.0"/>%
                                    </td>
                                </tr>
                                <tr t-if="not positions">
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="fa fa-inbox fa-3x mb-3 d-block"></i>
                                        No positions yet. Start trading to build your portfolio!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Market Trading View -->
    <template id="market_trading_view" name="Market Trading View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <h4 class="mb-4"><i class="fa fa-exchange me-2"></i>Trading Platform</h4>
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Market Orders View -->
    <template id="market_orders_view" name="Market Orders View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fa fa-list me-2"></i>My Orders</h4>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Order scope">
                            <a t-attf-href="/market/orders?scope=current" t-attf-class="btn btn-outline-primary #{scope == 'current' and 'active' or ''}">
                                <i class="fa fa-clock-o"></i> Current Session
                            </a>
                            <a t-attf-href="/market/orders?scope=all" t-attf-class="btn btn-outline-secondary #{scope == 'all' and 'active' or ''}">
                                <i class="fa fa-th-list"></i> All
                            </a>
                        </div>
                    </div>
                    <small class="text-muted" t-if="active_session and scope == 'current'">Showing orders for session: <t t-esc="active_session.name"/></small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Session</th>
                                    <th>Security</th>
                                    <th>Entered By</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="orders" t-as="order">
                                    <td><span class="badge bg-secondary"><t t-esc="order.name"/></span></td>
                                    <td><small><t t-esc="order.session_id.name or '-'"/></small></td>
                                    <td><strong><t t-esc="order.security_id.symbol"/></strong></td>
                                    <td><small><t t-esc="order.entered_by_id and order.entered_by_id.name or '-'"/></small></td>
                                    <td>
                                        <span t-attf-class="badge #{order.side == 'buy' and 'bg-success' or 'bg-danger'}">
                                            <t t-esc="order.side.upper()"/>
                                        </span>
                                    </td>
                                    <td><t t-esc="order.order_type"/></td>
                                    <td><t t-esc="order.quantity"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(order.price or 0.0)"/></td>
                                    <td>
                                        <span t-attf-class="badge #{order.status == 'filled' and 'bg-success' or order.status == 'cancelled' and 'bg-danger' or 'bg-warning'}">
                                            <t t-esc="order.status.upper()"/>
                                        </span>
                                    </td>
                                    <td><small><t t-esc="order.create_date" t-options='{"widget": "datetime"}'/></small></td>
                                </tr>
                                <tr t-if="not orders">
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fa fa-list fa-3x mb-3 d-block"></i>
                                        No orders yet. Place your first order to get started!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- REMOVED: All inheritance-based templates since we now use standalone layouts -->
    
    <!-- Removed legacy redirect template to eliminate portal inheritance -->

    <!-- WIKI-Style Error Page Template -->
    <template id="stock_error_page" name="Stock Market Error Page">
        <t t-call="stock_market_simulation.stock_standalone_layout">
            <t t-set="page_title" t-value="page_title or 'Error'"/>
            <div class="container-fluid py-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-xl-6">
                        <div class="card shadow-sm">
                            <div class="card-body text-center">
                                <h1 class="display-3 mb-3 text-primary" t-esc="status_code"/>
                                <h2 class="h3 mb-3" t-esc="status_message"/>
                                <p class="text-muted mb-4" t-esc="description"/>
                                <div class="mb-4">
                                    <a href="/market" class="btn btn-primary me-2">
                                        <i class="fa fa-home"/> Back to Market
                                    </a>
                                    <a href="javascript:history.back()" class="btn btn-outline-secondary">
                                        <i class="fa fa-arrow-left"/> Go Back
                                    </a>
                                </div>
                                <t t-if="show_suggestions">
                                    <div class="text-start">
                                        <t t-if="suggested_sessions">
                                            <h5 class="mt-4">Active Trading Sessions</h5>
                                            <div class="row">
                                                <t t-foreach="suggested_sessions" t-as="session">
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card h-100">
                                                            <div class="card-body">
                                                                <h6 class="card-title" t-field="session.name"/>
                                                                <p class="card-text text-muted">
                                                                    <span class="badge" t-attf-class="badge-#{session.state}">
                                                                        <t t-esc="session.state.title()"/>
                                                                    </span>
                                                                </p>
                                                                <a t-attf-href="/market/session/#{session.id}" class="btn btn-sm btn-outline-primary">View Session</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                        <t t-if="popular_securities">
                                            <h5 class="mt-4">Available Securities</h5>
                                            <div class="row">
                                                <t t-foreach="popular_securities" t-as="security">
                                                    <div class="col-md-4 mb-3">
                                                        <div class="card h-100">
                                                            <div class="card-body">
                                                                <h6 class="card-title" t-field="security.name"/>
                                                                <p class="card-text"><small class="text-muted" t-field="security.symbol"/></p>
                                                                <a t-attf-href="/market/security/#{security.id}" class="btn btn-sm btn-outline-success">View Details</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <style>
                .badge-active { background-color: var(--stock-success); }
                .badge-planned { background-color: var(--stock-warning); }
                .badge-closed { background-color: var(--stock-muted); }
            </style>
        </t>
    </template>
    
    <!-- ========== ADMIN USERS LIST TEMPLATE ========== -->
    <template id="admin_users_list" name="Admin Users List">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <!-- Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h2">Users Management</h1>
                            <p class="text-muted">View and manage all system users</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filters and Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="get" class="form-inline">
                            <!-- Search -->
                            <div class="form-group mr-2 mb-2">
                                <input type="text" name="search" class="form-control" placeholder="Search by name or login..." t-attf-value="#{search or ''}"/>
                            </div>
                            
                            <!-- Filter by User Type -->
                            <div class="form-group mr-2 mb-2">
                                <select name="filterby" class="form-control">
                                    <t t-foreach="searchbar_filters.items()" t-as="filter_option">
                                        <option t-att-value="filter_option[0]" t-att-selected="filter_option[0] == filterby and 'selected'">
                                            <t t-esc="filter_option[1]['label']"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            
                            <!-- Sort -->
                            <div class="form-group mr-2 mb-2">
                                <select name="sortby" class="form-control">
                                    <t t-foreach="searchbar_sortings.items()" t-as="sort_option">
                                        <option t-att-value="sort_option[0]" t-att-selected="sort_option[0] == sortby and 'selected'">
                                            <t t-esc="sort_option[1]['label']"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary mb-2">Search</button>
                        </form>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-users"/> Total Users: <span class="badge badge-info"><t t-esc="user_count"/></span></h5>
                    </div>
                    <div class="card-body p-0">
                        <t t-if="not users">
                            <div class="alert alert-info m-3">
                                <i class="fa fa-info-circle"/> No users found.
                            </div>
                        </t>
                        <t t-if="users">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Login</th>
                                            <th>User Type</th>
                                            <th class="text-right">Cash Balance</th>
                                            <th class="text-right">Initial Capital</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="users" t-as="u">
                                            <tr>
                                                <td>
                                                    <strong><t t-esc="u.name"/></strong>
                                                </td>
                                                <td><t t-esc="u.login"/></td>
                                                <td>
                                                    <span t-attf-class="badge #{u.user_type == 'superadmin' and 'badge-danger' or u.user_type == 'admin' and 'badge-warning' or u.user_type == 'banker' and 'badge-info' or u.user_type == 'broker' and 'badge-success' or 'badge-secondary'}">
                                                        <t t-esc="u.user_type.upper()"/>
                                                    </span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{u.cash_balance >= 0 and 'text-success' or 'text-danger'}">
                                                        $<t t-esc="'{:,.2f}'.format(u.cash_balance or 0.0)"/>
                                                    </span>
                                                </td>
                                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(u.initial_capital or 0.0)"/></td>
                                                <td>
                                                    <a t-attf-href="/market/admin/user/#{u.id}/360" class="btn btn-sm btn-primary">
                                                        <i class="fa fa-eye"/> View 360
                                                    </a>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>
                    </div>
                </div>
                
                <!-- Pagination (custom, no portal dependency) -->
                <t t-if="pager and pager.get('page_count', 0) > 1">
                    <nav aria-label="Users pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" t-att-class="(pager.get('page',1) &lt;= 1) and 'disabled' or ''">
                                <a class="page-link" t-att-href="'/market/admin/users/page/' + str((pager.get('page',1) - 1) if pager.get('page',1) &gt; 1 else 1) + '?sortby=' + str(sortby or '') + '&amp;filterby=' + str(filterby or '') + (('&amp;search=' + search) if search else '')" aria-label="Previous">
                                    <span aria-hidden="true">&#171;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Page <t t-esc="pager.get('page',1)"/> of <t t-esc="pager.get('page_count',1)"/></span>
                            </li>
                            <li class="page-item" t-att-class="(pager.get('page',1) &gt;= pager.get('page_count',1)) and 'disabled' or ''">
                                <a class="page-link" t-att-href="'/market/admin/users/page/' + str((pager.get('page',1) + 1) if pager.get('page',1) &lt; pager.get('page_count',1) else pager.get('page_count',1)) + '?sortby=' + str(sortby or '') + '&amp;filterby=' + str(filterby or '') + (('&amp;search=' + search) if search else '')" aria-label="Next">
                                    <span aria-hidden="true">&#187;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </t>
            </div>
        </t>
    </template>
    
    <!-- ========== ADMIN USER 360 VIEW TEMPLATE ========== -->
    <template id="admin_user_360_view" name="Admin User 360 View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <style>
                    .col-md-5th {
                        flex: 0 0 20%;
                        max-width: 20%;
                    }
                    @media (max-width: 768px) {
                        .col-md-5th {
                            flex: 0 0 50%;
                            max-width: 50%;
                        }
                    }
                    @media (max-width: 576px) {
                        .col-md-5th {
                            flex: 0 0 100%;
                            max-width: 100%;
                        }
                    }
                </style>
                
                <!-- Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h2">360° User View: <t t-esc="view_user.name"/></h1>
                            <p class="text-muted">
                                <span class="badge badge-primary"><t t-esc="view_user.user_type.upper()"/></span>
                                Login: <strong><t t-esc="view_user.login"/></strong>
                            </p>
                        </div>
                        <div class="col-auto">
                            <a href="/market/admin/users" class="btn btn-secondary">
                                <i class="fa fa-arrow-left"/> Back to Users
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-5th mb-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="fa fa-money text-success"></i> Cash Balance
                                </h6>
                                <h3 class="card-text" t-attf-style="color: #{view_user.cash_balance >= 0 and '#28a745' or '#dc3545'}">
                                    $<t t-esc="'{:,.2f}'.format(view_user.cash_balance or 0.0)"/>
                                </h3>
                                <small class="text-muted">Actual liquid cash available</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5th mb-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="fa fa-briefcase text-info"></i> Portfolio Value
                                </h6>
                                <h3 class="card-text text-info">
                                    $<t t-esc="'{:,.2f}'.format(total_positions_value or 0.0)"/>
                                </h3>
                                <small class="text-muted">Stock holdings value only</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5th mb-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="fa fa-bank text-warning"></i> Total Deposits
                                </h6>
                                <h3 class="card-text text-warning">
                                    $<t t-esc="'{:,.2f}'.format(total_deposits or 0.0)"/>
                                </h3>
                                <small class="text-muted">Active deposits separately</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5th mb-3">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="fa fa-credit-card text-danger"></i> Total Loans
                                </h6>
                                <h3 class="card-text text-danger">
                                    $<t t-esc="'{:,.2f}'.format(total_loans or 0.0)"/>
                                </h3>
                                <small class="text-muted">Outstanding loans separately</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5th mb-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="fa fa-pie-chart text-success"></i> Total Assets
                                </h6>
                                <h3 class="card-text" t-attf-style="color: #{net_worth >= (view_user.initial_capital or 0) and '#28a745' or '#dc3545'}">
                                    $<t t-esc="'{:,.2f}'.format(net_worth or 0.0)"/>
                                </h3>
                                <small class="text-muted">Comprehensive net worth</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Balance Sheet & Transaction History -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-list-alt"></i> Complete Balance Sheet &amp; Transaction History
                                </h5>
                                <small>Every transaction from initial cash to current value</small>
                            </div>
                            
                            <!-- Category Summary -->
                            <div class="card-body border-bottom">
                                <h6 class="text-muted mb-3">Transaction Summary by Category</h6>
                                <div class="row">
                                    <t t-foreach="category_summaries.items()" t-as="cat_item">
                                        <t t-set="cat_key" t-value="cat_item[0]"/>
                                        <t t-set="cat_data" t-value="cat_item[1]"/>
                                        <div class="col-md-3 col-sm-6 mb-2">
                                            <div class="card bg-light">
                                                <div class="card-body p-2">
                                                    <h6 class="card-title text-truncate" t-esc="cat_data['name']"/>
                                                    <p class="mb-1">
                                                        <span t-attf-class="text-#{cat_data['total_cash_impact'] >= 0 and 'success' or 'danger'}">
                                                            <t t-if="cat_data['total_cash_impact'] >= 0">+</t>$<t t-esc="'{:,.2f}'.format(abs(cat_data['total_cash_impact']))"/>
                                                        </span>
                                                    </p>
                                                    <small class="text-muted"><t t-esc="cat_data['transaction_count']"/> transactions</small>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                            
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Date</th>
                                                <th>Transaction Type</th>
                                                <th>Description</th>
                                                <th class="text-right">Amount</th>
                                                <th class="text-right">Running Balance</th>
                                                <th>Category</th>
                                                <th>Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- All Transaction History in Chronological Order -->
                                            <t t-foreach="all_transactions" t-as="txn">
                                                <tr>
                                                    <td><t t-esc="txn['date']"/></td>
                                                    <td>
                                                        <span t-attf-class="badge #{txn['badge_class']}">
                                                            <t t-esc="txn['type']"/>
                                                        </span>
                                                    </td>
                                                    <td><t t-esc="txn['description']"/></td>
                                                    <td class="text-right" t-attf-class="#{txn['amount'] >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-if="txn['amount'] >= 0">+</t>$<t t-esc="'{:,.2f}'.format(abs(txn['amount']))"/>
                                                    </td>
                                                    <td class="text-right font-weight-bold">
                                                        $<t t-esc="'{:,.2f}'.format(txn['running_balance'])"/>
                                                    </td>
                                                    <td><small class="text-muted"><t t-esc="txn['category'].replace('_', ' ').title()"/></small></td>
                                                    <td><small class="text-muted"><t t-esc="txn.get('reference', '')"/></small></td>
                                                </tr>
                                            </t>
                                            
                                            <!-- Current Position Summary -->
                                            <tr class="table-dark text-white">
                                                <td colspan="4"><strong>CURRENT POSITION SUMMARY</strong></td>
                                                <td class="text-right"><strong>$<t t-esc="'{:,.2f}'.format(net_worth or 0.0)"/></strong></td>
                                                <td><strong>Total Net Worth</strong></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Positions Section -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-briefcase"/> Stock Positions (<t t-esc="len(positions)"/>)</h5>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not positions">
                                    <div class="alert alert-info m-3 mb-0">
                                        <i class="fa fa-info-circle"/> No positions held.
                                    </div>
                                </t>
                                <t t-if="positions">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Security</th>
                                                    <th class="text-right">Qty</th>
                                                    <th class="text-right">Avg Cost</th>
                                                    <th class="text-right">Cost Basis</th>
                                                    <th class="text-right">Market Value</th>
                                                    <th class="text-right">Unrealized P&amp;L</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="positions" t-as="pos">
                                                    <tr>
                                                        <td><strong><t t-esc="pos.security_id.symbol"/></strong></td>
                                                        <td class="text-right"><t t-esc="pos.quantity"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(pos.average_cost or 0.0)"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(pos.cost_basis or 0.0)"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(pos.market_value or 0.0)"/></td>
                                                        <td class="text-right" t-attf-style="color: #{(pos.unrealized_pnl or 0.0) >= 0 and 'green' or 'red'}">
                                                            $<t t-esc="'{:,.2f}'.format(pos.unrealized_pnl or 0.0)"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Deposits & Loans -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-bank"/> Deposits (<t t-esc="len(deposits)"/>)</h5>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not deposits">
                                    <div class="alert alert-info m-3 mb-0">
                                        <i class="fa fa-info-circle"/> No deposits.
                                    </div>
                                </t>
                                <t t-if="deposits">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th class="text-right">Amount</th>
                                                    <th class="text-right">Current Value</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="deposits" t-as="dep">
                                                    <tr>
                                                        <td>
                                                            <t t-if="dep.create_date">
                                                                <t t-esc="dep.create_date.strftime('%Y-%m-%d')"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(dep.amount or 0.0)"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(dep.current_value or 0.0)"/></td>
                                                        <td>
                                                            <span t-attf-class="badge #{dep.status == 'active' and 'badge-success' or dep.status == 'pending' and 'badge-warning' or 'badge-danger'}">
                                                                <t t-esc="dep.status.upper()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-credit-card"/> Loans (<t t-esc="len(loans)"/>)</h5>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not loans">
                                    <div class="alert alert-info m-3 mb-0">
                                        <i class="fa fa-info-circle"/> No loans.
                                    </div>
                                </t>
                                <t t-if="loans">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th class="text-right">Principal</th>
                                                    <th class="text-right">Outstanding</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="loans" t-as="loan">
                                                    <tr>
                                                        <td>
                                                            <t t-if="loan.create_date">
                                                                <t t-esc="loan.create_date.strftime('%Y-%m-%d')"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(loan.amount or 0.0)"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(loan.principal_outstanding or 0.0)"/></td>
                                                        <td>
                                                            <span t-attf-class="badge #{loan.status == 'active' and 'badge-success' or loan.status == 'pending' and 'badge-warning' or 'badge-danger'}">
                                                                <t t-esc="loan.status.upper()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Orders -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-list"/> Recent Orders</h5>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not orders">
                                    <div class="alert alert-info m-3 mb-0">
                                        <i class="fa fa-info-circle"/> No orders.
                                    </div>
                                </t>
                                <t t-if="orders">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Order</th>
                                                    <th>Security</th>
                                                    <th class="text-center">Side</th>
                                                    <th class="text-right">Qty</th>
                                                    <th class="text-right">Price</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="orders" t-as="order">
                                                    <tr>
                                                        <td><t t-esc="order.order_date.strftime('%Y-%m-%d %H:%M')"/></td>
                                                        <td><strong><t t-esc="order.name"/></strong></td>
                                                        <td><t t-esc="order.security_id.symbol"/></td>
                                                        <td class="text-center">
                                                            <span t-attf-class="badge #{order.side == 'buy' and 'badge-success' or 'badge-danger'}">
                                                                <t t-esc="order.side.upper()"/>
                                                            </span>
                                                        </td>
                                                        <td class="text-right"><t t-esc="order.quantity"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(order.price or 0.0)"/></td>
                                                        <td>
                                                            <span t-attf-class="badge #{order.status == 'filled' and 'badge-success' or order.status == 'submitted' and 'badge-warning' or order.status == 'cancelled' and 'badge-danger' or 'badge-secondary'}">
                                                                <t t-esc="order.status.upper()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Trades -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-exchange"/> Recent Trades</h5>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not trades">
                                    <div class="alert alert-info m-3 mb-0">
                                        <i class="fa fa-info-circle"/> No trades.
                                    </div>
                                </t>
                                <t t-if="trades">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Security</th>
                                                    <th class="text-right">Quantity</th>
                                                    <th class="text-right">Price</th>
                                                    <th>Role</th>
                                                    <th>Counterparty</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="trades" t-as="trade">
                                                    <tr>
                                                        <td><t t-esc="trade.trade_date.strftime('%Y-%m-%d %H:%M')"/></td>
                                                        <td><strong><t t-esc="trade.security_id.symbol"/></strong></td>
                                                        <td class="text-right"><t t-esc="trade.quantity"/></td>
                                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(trade.price or 0.0)"/></td>
                                                        <td>
                                                            <t t-if="trade.buyer_id.id == view_user.id">
                                                                <span class="badge badge-success">BUYER</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-danger">SELLER</span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-if="trade.buyer_id.id == view_user.id">
                                                                <t t-esc="trade.seller_id.name"/>
                                                            </t>
                                                            <t t-else="">
                                                                <t t-esc="trade.buyer_id.name"/>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Securities Page Template -->
    <template id="market_securities_page" name="Market Securities Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-bar-chart text-primary me-2"></i>Securities</h2>
                            <small class="text-muted">Real-time market data</small>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Listed Securities</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Company</th>
                                                <th>Type</th>
                                                <th class="text-end">Current Price</th>
                                                <th class="text-end">Change</th>
                                                <th class="text-end">Change %</th>
                                                <th class="text-end">Volume</th>
                                                <th class="text-end">Market Cap</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-if="securities_data">
                                                <t t-foreach="securities_data" t-as="item">
                                                    <tr>
                                                        <td>
                                                            <strong t-esc="item['security'].symbol"/>
                                                        </td>
                                                        <td>
                                                            <div>
                                                                <strong t-esc="item['security'].name"/>
                                                                <br/>
                                                                <small class="text-muted" t-esc="item['security'].sector.title() if item['security'].sector else 'N/A'"/>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge badge-secondary" t-esc="item['security'].security_type.title()"/>
                                                        </td>
                                                        <td class="text-end">
                                                            <strong>
                                                                $<t t-if="item['latest_price']" t-esc="'{:,.2f}'.format(item['latest_price'].new_price)"/>
                                                                <t t-else="">-</t>
                                                            </strong>
                                                        </td>
                                                        <td class="text-end">
                                                            <span t-attf-class="#{item['change'] >= 0 and 'text-success' or 'text-danger'}">
                                                                <t t-if="item['change'] >= 0">+</t>$<t t-esc="'{:,.2f}'.format(abs(item['change']))"/>
                                                            </span>
                                                        </td>
                                                        <td class="text-end">
                                                            <span t-attf-class="#{item['change_percent'] >= 0 and 'text-success' or 'text-danger'}">
                                                                <t t-if="item['change_percent'] >= 0">+</t><t t-esc="'{:,.2f}'.format(item['change_percent'])"/>%
                                                            </span>
                                                        </td>
                                                        <td class="text-end">
                                                            <t t-if="item['security'].volume_today" t-esc="'{:,}'.format(int(item['security'].volume_today))"/>
                                                            <t t-else="">-</t>
                                                        </td>
                                                        <td class="text-end">
                                                            <t t-if="item['latest_price']">
                                                                $<t t-esc="'{:,.0f}'.format(item['latest_price'].new_price * item['security'].total_shares)"/>M
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </t>
                                            <t t-else="">
                                                <tr>
                                                    <td colspan="8" class="text-center py-4 text-muted">
                                                        <i class="fa fa-info-circle me-2"></i>No securities available
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Session Info Page Template -->
    <template id="market_session_page" name="Market Session Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-clock-o text-primary me-2"></i>Session Information</h2>
                            <small class="text-muted">Trading session status and statistics</small>
                        </div>

                        <!-- Current Session Status -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Current Session</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="active_session">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6><i class="fa fa-play-circle text-success me-2"></i>Active Session</h6>
                                                    <p class="mb-2"><strong>Name:</strong> <t t-esc="active_session.name"/></p>
                                                    <p class="mb-2"><strong>Started:</strong> <t t-esc="active_session.actual_start_date" t-options='{"widget": "datetime"}'/></p>
                                                    <p class="mb-2"><strong>Planned End:</strong> <t t-esc="active_session.planned_end_date" t-options='{"widget": "datetime"}'/></p>
                                                    <p class="mb-0"><strong>State:</strong> 
                                                        <span class="badge badge-success">
                                                            <t t-esc="active_session.state.title()"/>
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6><i class="fa fa-bar-chart text-info me-2"></i>Session Statistics</h6>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h4 class="text-primary mb-1" t-esc="session_stats.get('trades_count', 0)"/>
                                                                <small class="text-muted">Trades</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h4 class="text-success mb-1" t-esc="'{:,}'.format(session_stats.get('total_volume', 0))"/>
                                                                <small class="text-muted">Volume</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h4 class="text-info mb-1">$<t t-esc="'{:,.0f}'.format(session_stats.get('total_value', 0))"/></h4>
                                                                <small class="text-muted">Value</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h4 class="text-warning mb-1" t-esc="session_stats.get('unique_securities', 0)"/>
                                                                <small class="text-muted">Securities</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Session History -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Recent Sessions</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Session Name</th>
                                                        <th>Start Date</th>
                                                        <th>End Date</th>
                                                        <th>Duration</th>
                                                        <th>State</th>
                                                        <th class="text-end">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-if="all_sessions">
                                                        <t t-foreach="all_sessions" t-as="session">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="session.name"/>
                                                                </td>
                                                                <td>
                                                                    <t t-esc="session.actual_start_date" t-options='{"widget": "datetime"}'/>
                                                                </td>
                                                                <td>
                                                                    <t t-if="session.actual_end_date" t-esc="session.actual_end_date" t-options='{"widget": "datetime"}'/>
                                                                    <t t-else="">
                                                                        <span class="text-muted">Ongoing</span>
                                                                    </t>
                                                                </td>
                                                                <td>
                                                                    <t t-if="session.actual_end_date">
                                                                        <t t-set="duration" t-value="(session.actual_end_date - session.actual_start_date).total_seconds() / 3600"/>
                                                                        <t t-esc="'{:.1f}'.format(duration)"/> hours
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span class="text-muted">-</span>
                                                                    </t>
                                                                </td>
                                                                <td>
                                                                    <span t-attf-class="badge #{session.state == 'open' and 'badge-success' or session.state == 'closed' and 'badge-secondary' or 'badge-warning'}">
                                                                        <t t-esc="session.state.title()"/>
                                                                    </span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <button class="btn btn-sm btn-outline-primary session-details-btn" t-att-data-session-id="session.id">
                                                                        <i class="fa fa-eye"></i> View
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <tr>
                                                            <td colspan="6" class="text-center py-4 text-muted">
                                                                <i class="fa fa-info-circle me-2"></i>No sessions found
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Session Details Modal -->
            <div class="modal fade" id="sessionDetailsModal" tabindex="-1" aria-labelledby="sessionDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="sessionDetailsModalLabel">Session Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="sessionDetailsContent">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading session details...</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Session Details JavaScript -->
            <script>//<![CDATA[
                document.addEventListener('DOMContentLoaded', function() {
                    // Session details modal functionality
                    const sessionDetailsButtons = document.querySelectorAll('.session-details-btn');
                    const sessionDetailsModal = document.getElementById('sessionDetailsModal');
                    const sessionDetailsContent = document.getElementById('sessionDetailsContent');
                    
                    sessionDetailsButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const sessionId = this.getAttribute('data-session-id');
                            showSessionDetails(sessionId);
                        });
                    });
                    
                    function showSessionDetails(sessionId) {
                        // Show loading state
                        sessionDetailsContent.innerHTML = `
                            <div class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading session details...</p>
                            </div>
                        `;
                        
                        // Show modal
                        try {
                            if (window.bootstrap && bootstrap.Modal) {
                                new bootstrap.Modal(sessionDetailsModal).show();
                            } else if (window.$ && $.fn.modal) {
                                $(sessionDetailsModal).modal('show');
                            } else {
                                sessionDetailsModal.style.display = 'block';
                                sessionDetailsModal.classList.add('show');
                            }
                        } catch (e) {
                            console.error('Error showing modal:', e);
                        }
                        
                        // Fetch session details
                        fetch('/market/session/details/' + sessionId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {}
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            const result = data.result || data;
                            if (result.success) {
                                displaySessionDetails(result);
                            } else {
                                sessionDetailsContent.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        Error loading session details: ${result.error || 'Unknown error'}
                                    </div>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            sessionDetailsContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    Error loading session details: ${error.message}
                                </div>
                            `;
                        });
                    }
                    
                    function displaySessionDetails(data) {
                        const session = data.session;
                        const stats = data.statistics;
                        const topSecurities = data.top_securities;
                        const recentTrades = data.recent_trades;
                        const priceChanges = data.price_changes;
                        
                        let html = `
                            <div class="row">
                                <!-- Session Information -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fa fa-info-circle"></i> Session Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tr><td><strong>Name:</strong></td><td>${session.name}</td></tr>
                                                <tr><td><strong>Status:</strong></td><td><span class="badge ${session.state === 'open' ? 'bg-success' : session.state === 'closed' ? 'bg-secondary' : 'bg-warning'}">${session.state.charAt(0).toUpperCase() + session.state.slice(1)}</span></td></tr>
                                                ${session.actual_start_date ? `<tr><td><strong>Started:</strong></td><td>${session.actual_start_date}</td></tr>` : ''}
                                                ${session.actual_end_date ? `<tr><td><strong>Ended:</strong></td><td>${session.actual_end_date}</td></tr>` : ''}
                                                ${session.actual_duration ? `<tr><td><strong>Duration:</strong></td><td>${session.actual_duration.toFixed(2)} hours</td></tr>` : ''}
                                                <tr><td><strong>Commission Rate:</strong></td><td>${session.broker_commission_rate}%</td></tr>
                                                <tr><td><strong>Price Change Threshold:</strong></td><td>${session.price_change_threshold}%</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Session Statistics -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fa fa-chart-bar"></i> Trading Statistics</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center">
                                                <div class="col-6">
                                                    <div class="border-end">
                                                        <h4 class="text-primary mb-0">${stats.total_orders}</h4>
                                                        <small class="text-muted">Total Orders</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <h4 class="text-success mb-0">${stats.total_trades}</h4>
                                                    <small class="text-muted">Total Trades</small>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row text-center">
                                                <div class="col-6">
                                                    <div class="border-end">
                                                        <h5 class="text-info mb-0">${stats.total_volume.toLocaleString()}</h5>
                                                        <small class="text-muted">Total Volume</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <h5 class="text-warning mb-0">$${stats.total_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h5>
                                                    <small class="text-muted">Total Value</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Top Trading Securities -->
                            ${topSecurities.length > 0 ? `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-trophy"></i> Top Trading Securities</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Volume</th>
                                                    <th>Value</th>
                                                    <th>Trades</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${topSecurities.map(sec => `
                                                    <tr>
                                                        <td><strong>${sec.symbol}</strong></td>
                                                        <td>${sec.name}</td>
                                                        <td>${sec.volume.toLocaleString()}</td>
                                                        <td>$${sec.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                        <td>${sec.trades}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Recent Trades -->
                            ${recentTrades.length > 0 ? `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-exchange-alt"></i> Recent Trades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Security</th>
                                                    <th>Quantity</th>
                                                    <th>Price</th>
                                                    <th>Value</th>
                                                    <th>Date</th>
                                                    <th>Buyer</th>
                                                    <th>Seller</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${recentTrades.map(trade => `
                                                    <tr>
                                                        <td><strong>${trade.security_symbol}</strong><br><small class="text-muted">${trade.security_name}</small></td>
                                                        <td>${trade.quantity.toLocaleString()}</td>
                                                        <td>$${trade.price.toFixed(2)}</td>
                                                        <td>$${trade.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                        <td><small>${trade.trade_date}</small></td>
                                                        <td><small>${trade.buyer}</small></td>
                                                        <td><small>${trade.seller}</small></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        `;
                        
                        sessionDetailsContent.innerHTML = html;
                        
                        // Update modal title with session name
                        document.getElementById('sessionDetailsModalLabel').textContent = `Session Details - ${session.name}`;
                    }
                });
            //]]></script>
        </t>
    </template>
    
    <!-- Reports Page Template -->
    <template id="market_reports_page" name="Market Reports Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-file-text text-primary me-2"></i>Market Reports</h2>
                            <small class="text-muted">Market statistics and analytics</small>
                        </div>

                        <!-- Market Overview -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Market Overview</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h4 class="text-primary mb-1" t-esc="market_stats.get('total_securities', 0)"/>
                                                    <small class="text-muted">Securities Listed</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h4 class="text-info mb-1" t-esc="market_stats.get('total_users', 0)"/>
                                                    <small class="text-muted">Active Users</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-success mb-1" t-esc="market_stats.get('total_trades_today', 0)"/>
                                                    <small class="text-muted">Trades Today</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-warning mb-1" t-esc="'{:,}'.format(market_stats.get('total_volume_today', 0))"/>
                                                    <small class="text-muted">Volume Today</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h4 class="text-danger mb-1">$<t t-esc="'{:,.0f}'.format(market_stats.get('total_value_today', 0))"/></h4>
                                                    <small class="text-muted">Value Today</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Portfolio (if investor) -->
                        <t t-if="user.user_type == 'investor'">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Your Portfolio Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-primary mb-1" t-esc="user_stats.get('total_positions', 0)"/>
                                                        <small class="text-muted">Positions</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-success mb-1">$<t t-esc="'{:,.2f}'.format(user_stats.get('portfolio_value', 0))"/></h4>
                                                        <small class="text-muted">Portfolio Value</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-info mb-1" t-esc="user_stats.get('total_trades', 0)"/>
                                                        <small class="text-muted">Total Trades</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 t-attf-class="mb-1 #{user_stats.get('total_pnl', 0) >= 0 and 'text-success' or 'text-danger'}">
                                                            $<t t-esc="'{:,.2f}'.format(user_stats.get('total_pnl', 0))"/>
                                                        </h4>
                                                        <small class="text-muted">Unrealized P&amp;L</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>

                        <!-- Top Performing Securities -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Listed Securities</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Symbol</th>
                                                        <th>Company</th>
                                                        <th>Type</th>
                                                        <th class="text-end">Total Shares</th>
                                                        <th class="text-end">Par Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-if="top_securities">
                                                        <t t-foreach="top_securities" t-as="security">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="security.symbol"/>
                                                                </td>
                                                                <td>
                                                                    <div>
                                                                        <strong t-esc="security.name"/>
                                                                        <br/>
                                                                        <small class="text-muted" t-esc="security.sector.title() if security.sector else 'N/A'"/>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-secondary" t-esc="security.security_type.title()"/>
                                                                </td>
                                                                <td class="text-end">
                                                                    <t t-esc="'{:,}'.format(int(security.total_shares))"/>
                                                                </td>
                                                                <td class="text-end">
                                                                    $<t t-esc="'{:,.2f}'.format(security.current_price)"/>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <tr>
                                                            <td colspan="5" class="text-center py-4 text-muted">
                                                                <i class="fa fa-info-circle me-2"></i>No securities available
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Deposits Page -->
    <template id="market_deposits_page" name="Market Deposits Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-piggy-bank text-primary me-2"></i>Deposits</h2>
                            <small class="text-muted">Banking deposits and interest</small>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h4 class="text-primary mb-1">$<t t-esc="'{:,.2f}'.format(total_deposits)"/></h4>
                                        <small class="text-muted">Total Deposits</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h4 class="text-success mb-1">$<t t-esc="'{:,.2f}'.format(total_active_value)"/></h4>
                                        <small class="text-muted">Active Value</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <h4 class="text-info mb-1">$<t t-esc="'{:,.2f}'.format(total_interest_earned)"/></h4>
                                        <small class="text-muted">Interest Earned</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <h4 class="text-warning mb-1"><t t-esc="active_count"/></h4>
                                        <small class="text-muted">Active Deposits</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions and Filters -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button t-if="user.user_type in ['banker', 'admin']" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDepositModal">
                                    <i class="fa fa-plus me-2"></i>Create New Deposit
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group float-end" role="group">
                                    <t t-foreach="searchbar_filters.items()" t-as="filter_item">
                                        <t t-set="filter_key" t-value="filter_item[0]"/>
                                        <t t-set="filter_data" t-value="filter_item[1]"/>
                                        <a t-attf-href="/market/deposits?filterby=#{filter_key}" 
                                           t-attf-class="btn btn-sm btn-outline-secondary #{'active' if filterby == filter_key else ''}">
                                            <t t-esc="filter_data['label']"/>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Deposits Table -->
                        <div class="card">
                            <div class="card-body">
                                <t t-if="deposits">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Deposit #</th>
                                                    <th>Depositor</th>
                                                    <th>Banker</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Interest</th>
                                                    <th>Current Value</th>
                                                    <th>Status</th>
                                                    <th>Maturity</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr t-foreach="deposits" t-as="deposit">
                                                    <td><strong><t t-esc="deposit.name"/></strong></td>
                                                    <td><t t-esc="deposit.user_id.name"/></td>
                                                    <td><t t-esc="deposit.banker_id.name"/></td>
                                                    <td><span class="badge bg-light text-dark"><t t-esc="deposit.deposit_type.title()"/></span></td>
                                                    <td>$<t t-esc="'{:,.2f}'.format(deposit.amount)"/></td>
                                                    <td><t t-esc="'{:.2f}'.format(deposit.interest_rate)"/>%</td>
                                                    <td>$<t t-esc="'{:,.2f}'.format(deposit.current_value)"/></td>
                                                    <td>
                                                        <span t-attf-class="badge bg-#{('primary' if deposit.status == 'draft' else 'success' if deposit.status == 'active' else 'warning' if deposit.status == 'matured' else 'secondary')}">
                                                            <t t-esc="deposit.status.title()"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <t t-if="deposit.maturity_session_id">
                                                            <t t-esc="deposit.maturity_session_id.name"/>
                                                            <t t-if="deposit.sessions_to_maturity > 0">
                                                                <br/><small class="text-muted">(<t t-esc="deposit.sessions_to_maturity"/> sessions)</small>
                                                            </t>
                                                        </t>
                                                        <t t-else="">-</t>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button t-if="deposit.status == 'draft' and user.user_type in ['banker', 'admin']" 
                                                                    type="button" class="btn btn-success deposit-action-btn" 
                                                                    t-att-data-deposit-id="deposit.id" data-action="confirm">
                                                                Confirm
                                                            </button>
                                                            <button t-if="deposit.status in ['active', 'matured']" 
                                                                    type="button" class="btn btn-warning deposit-action-btn" 
                                                                    t-att-data-deposit-id="deposit.id" data-action="withdraw">
                                                                Withdraw
                                                            </button>
                                                            <button t-if="deposit.status == 'draft'" 
                                                                    type="button" class="btn btn-outline-danger deposit-action-btn" 
                                                                    t-att-data-deposit-id="deposit.id" data-action="cancel">
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                                <t t-else="">
                                    <div class="text-center py-5">
                                        <i class="fa fa-piggy-bank fa-4x text-muted mb-3"></i>
                                        <h5 class="text-muted">No deposits found</h5>
                                        <button t-if="user.user_type in ['banker', 'admin']" type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#newDepositModal">
                                            Create First Deposit
                                        </button>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Deposit Modal -->
            <div class="modal fade" id="newDepositModal" tabindex="-1" aria-hidden="true" t-if="user.user_type in ['banker', 'admin']">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Create New Deposit</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newDepositForm">
                                <div class="mb-3">
                                    <label for="investor_id" class="form-label">Investor</label>
                                    <select class="form-select" id="investor_id" name="investor_id" required="required">
                                        <option value="">Select Investor</option>
                                        <t t-foreach="investors" t-as="investor">
                                            <option t-att-value="investor.id"><t t-esc="investor.name"/> (Balance: $<t t-esc="'{:,.2f}'.format(investor.cash_balance)"/>)</option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="deposit_type" class="form-label">Deposit Type</label>
                                    <select class="form-select" id="deposit_type" name="deposit_type" required="required">
                                        <option value="fixed">Fixed Deposit</option>
                                        <option value="savings">Savings Account</option>
                                        <option value="current">Current Account</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="amount" class="form-label">Amount</label>
                                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="1" required="required"/>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="interest_rate" class="form-label">Interest Rate (%)</label>
                                            <input type="number" class="form-control" id="interest_rate" name="interest_rate" step="0.01" min="0" max="50" required="required"/>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="term_sessions" class="form-label">Term (Sessions)</label>
                                    <input type="number" class="form-control" id="term_sessions" name="term_sessions" min="1" max="500"/>
                                    <div class="form-text">Leave empty for non-term deposits. Typical: 1-12 sessions per year</div>
                                </div>
                                
                                <div class="mb-3" t-if="user.user_type == 'admin'">
                                    <label for="banker_id" class="form-label">Banker</label>
                                    <select class="form-select" id="banker_id" name="banker_id">
                                        <option value="">Auto-assign</option>
                                        <t t-foreach="bankers" t-as="banker">
                                            <option t-att-value="banker.id"><t t-esc="banker.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_confirm" name="auto_confirm"/>
                                    <label class="form-check-label" for="auto_confirm">
                                        Auto-confirm deposit
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="createDepositBtn">Create Deposit</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>//<![CDATA[
                document.addEventListener('DOMContentLoaded', function() {
                    // Create deposit form submission
                    const createDepositBtn = document.getElementById('createDepositBtn');
                    if (createDepositBtn) {
                        createDepositBtn.addEventListener('click', function() {
                            const form = document.getElementById('newDepositForm');
                            const formData = new FormData(form);
                            const data = Object.fromEntries(formData.entries());
                            
                            // Show loading state
                            createDepositBtn.disabled = true;
                            createDepositBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';
                            
                            fetch('/market/deposits/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: data
                                })
                            })
                            .then(response => response.json())
                            .then(result => {
                                const payload = result?.result || result;
                                if (payload?.success) {
                                    alert('Success: ' + payload.message);
                                    window.location.reload();
                                } else {
                                    alert('Error: ' + (payload?.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                alert('Error: ' + error.message);
                            })
                            .finally(() => {
                                createDepositBtn.disabled = false;
                                createDepositBtn.innerHTML = 'Create Deposit';
                            });
                        });
                    }
                    
                    // Deposit action buttons
                    document.addEventListener('click', function(event) {
                        if (event.target.closest('.deposit-action-btn')) {
                            const btn = event.target.closest('.deposit-action-btn');
                            const depositId = btn.dataset.depositId;
                            const action = btn.dataset.action;
                            
                            if (confirm(`Are you sure you want to ${action} this deposit?`)) {
                                btn.disabled = true;
                                btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                                
                                fetch(`/market/deposits/${depositId}/action`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: { action: action }
                                    })
                                })
                                .then(response => response.json())
                                .then(result => {
                                    const payload = result?.result || result;
                                    if (payload?.success) {
                                        alert('Success: ' + payload.message);
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + (payload?.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    alert('Error: ' + error.message);
                                })
                                .finally(() => {
                                    btn.disabled = false;
                                    btn.innerHTML = action.charAt(0).toUpperCase() + action.slice(1);
                                });
                            }
                        }
                    });
                });
            //]]></script>
        </t>
    </template>

    <!-- Loans Page -->
    <template id="market_loans_page" name="Market Loans Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-credit-card text-primary me-2"></i>Loans</h2>
                            <small class="text-muted">Banking loans and credit</small>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h4 class="text-primary mb-1">$<t t-esc="'{:,.2f}'.format(total_loans)"/></h4>
                                        <small class="text-muted">Total Loans</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <h4 class="text-danger mb-1">$<t t-esc="'{:,.2f}'.format(total_outstanding)"/></h4>
                                        <small class="text-muted">Outstanding</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h4 class="text-success mb-1">$<t t-esc="'{:,.2f}'.format(total_paid)"/></h4>
                                        <small class="text-muted">Total Paid</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <h4 class="text-warning mb-1"><t t-esc="active_count"/></h4>
                                        <small class="text-muted">Active Loans</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions and Filters -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button t-if="user.user_type in ['banker', 'admin']" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newLoanModal">
                                    <i class="fa fa-plus me-2"></i>Create New Loan
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group float-end" role="group">
                                    <t t-foreach="searchbar_filters.items()" t-as="filter_item">
                                        <t t-set="filter_key" t-value="filter_item[0]"/>
                                        <t t-set="filter_data" t-value="filter_item[1]"/>
                                        <a t-attf-href="/market/loans?filterby=#{filter_key}" 
                                           t-attf-class="btn btn-sm btn-outline-secondary #{'active' if filterby == filter_key else ''}">
                                            <t t-esc="filter_data['label']"/>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Loans Table -->
                        <div class="card">
                            <div class="card-body">
                                <t t-if="loans">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Loan #</th>
                                                    <th>Borrower</th>
                                                    <th>Banker</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Interest</th>
                                                    <th>Outstanding</th>
                                                    <th>EMI</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr t-foreach="loans" t-as="loan">
                                                    <td><strong><t t-esc="loan.name"/></strong></td>
                                                    <td><t t-esc="loan.user_id.name"/></td>
                                                    <td><t t-esc="loan.banker_id.name"/></td>
                                                    <td><span class="badge bg-light text-dark"><t t-esc="loan.loan_type.title()"/></span></td>
                                                    <td>$<t t-esc="'{:,.2f}'.format(loan.amount)"/></td>
                                                    <td><t t-esc="'{:.2f}'.format(loan.interest_rate)"/>%</td>
                                                    <td>$<t t-esc="'{:,.2f}'.format(loan.total_outstanding)"/></td>
                                                    <td>$<t t-esc="'{:,.2f}'.format(loan.emi_amount)"/></td>
                                                    <td>
                                                        <span t-attf-class="badge bg-#{('primary' if loan.status == 'draft' else 'info' if loan.status == 'approved' else 'success' if loan.status == 'active' else 'success' if loan.status == 'paid' else 'danger')}">
                                                            <t t-esc="loan.status.title()"/>
                                                        </span>
                                                        <t t-if="loan.margin_call_triggered">
                                                            <br/><small class="badge bg-warning">Margin Call</small>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button t-if="loan.status == 'draft' and user.user_type in ['banker', 'admin']" 
                                                                    type="button" class="btn btn-success loan-action-btn" 
                                                                    t-att-data-loan-id="loan.id" data-action="approve">
                                                                Approve
                                                            </button>
                                                            <button t-if="loan.status == 'approved' and user.user_type in ['banker', 'admin']" 
                                                                    type="button" class="btn btn-info loan-action-btn" 
                                                                    t-att-data-loan-id="loan.id" data-action="disburse">
                                                                Disburse
                                                            </button>
                                                            <button t-if="loan.status == 'active'" 
                                                                    type="button" class="btn btn-warning" 
                                                                    data-bs-toggle="modal" data-bs-target="#paymentModal"
                                                                    t-att-data-loan-id="loan.id" 
                                                                    t-att-data-loan-name="loan.name"
                                                                    t-att-data-emi-amount="loan.emi_amount">
                                                                Pay EMI
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                                <t t-else="">
                                    <div class="text-center py-5">
                                        <i class="fa fa-credit-card fa-4x text-muted mb-3"></i>
                                        <h5 class="text-muted">No loans found</h5>
                                        <button t-if="user.user_type in ['banker', 'admin']" type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#newLoanModal">
                                            Create First Loan
                                        </button>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Loan Modal -->
            <div class="modal fade" id="newLoanModal" tabindex="-1" aria-hidden="true" t-if="user.user_type in ['banker', 'admin']">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Create New Loan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newLoanForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="loan_investor_id" class="form-label">Borrower</label>
                                            <select class="form-select" id="loan_investor_id" name="investor_id" required="required">
                                                <option value="">Select Borrower</option>
                                                <t t-foreach="investors" t-as="investor">
                                                    <option t-att-value="investor.id"><t t-esc="investor.name"/> (Balance: $<t t-esc="'{:,.2f}'.format(investor.cash_balance)"/>)</option>
                                                </t>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="loan_type" class="form-label">Loan Type</label>
                                            <select class="form-select" id="loan_type" name="loan_type" required="required">
                                                <option value="personal">Personal Loan</option>
                                                <option value="margin">Margin Loan</option>
                                                <option value="secured">Secured Loan</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="loan_amount" class="form-label">Amount</label>
                                            <input type="number" class="form-control" id="loan_amount" name="amount" step="0.01" min="1" required="required"/>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="loan_interest_rate" class="form-label">Interest Rate (%)</label>
                                            <input type="number" class="form-control" id="loan_interest_rate" name="interest_rate" step="0.01" min="0" max="50" required="required"/>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="loan_term_sessions" class="form-label">Term (Sessions)</label>
                                            <input type="number" class="form-control" id="loan_term_sessions" name="term_sessions" min="1" max="1000" required="required"/>
                                            <div class="form-text">Loan duration in trading sessions. Typical: 1-12 sessions per year</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Collateral Section -->
                                <div id="collateralSection" style="display: none;">
                                    <h6 class="text-primary">Collateral Details</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="collateral_security_id" class="form-label">Security</label>
                                                <select class="form-select" id="collateral_security_id" name="collateral_security_id">
                                                    <option value="">Select Security</option>
                                                    <t t-foreach="securities" t-as="security">
                                                        <option t-att-value="security.id"><t t-esc="security.symbol"/> - <t t-esc="security.name"/></option>
                                                    </t>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="collateral_quantity" class="form-label">Quantity</label>
                                                <input type="number" class="form-control" id="collateral_quantity" name="collateral_quantity" min="1"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" t-if="user.user_type == 'admin'">
                                    <label for="loan_banker_id" class="form-label">Banker</label>
                                    <select class="form-select" id="loan_banker_id" name="banker_id">
                                        <option value="">Auto-assign</option>
                                        <t t-foreach="bankers" t-as="banker">
                                            <option t-att-value="banker.id"><t t-esc="banker.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="auto_approve" name="auto_approve"/>
                                            <label class="form-check-label" for="auto_approve">
                                                Auto-approve loan
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="auto_disburse" name="auto_disburse"/>
                                            <label class="form-check-label" for="auto_disburse">
                                                Auto-disburse loan
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="createLoanBtn">Create Loan</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Modal -->
            <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Make Loan Payment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="paymentForm">
                                <input type="hidden" id="payment_loan_id" name="loan_id"/>
                                <div class="mb-3">
                                    <label class="form-label">Loan: <span id="payment_loan_name" class="fw-bold"></span></label>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_amount" class="form-label">Payment Amount</label>
                                    <input type="number" class="form-control" id="payment_amount" name="amount" step="0.01" min="0.01" required="required"/>
                                    <div class="form-text">Suggested EMI: $<span id="suggested_emi" class="fw-bold">0.00</span></div>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_type" class="form-label">Payment Type</label>
                                    <select class="form-select" id="payment_type" name="payment_type">
                                        <option value="emi">EMI Payment</option>
                                        <option value="prepayment">Prepayment</option>
                                        <option value="foreclosure">Foreclosure</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="makePaymentBtn">Make Payment</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>//<![CDATA[
                document.addEventListener('DOMContentLoaded', function() {
                    // Show/hide collateral section based on loan type
                    const loanTypeSelect = document.getElementById('loan_type');
                    const collateralSection = document.getElementById('collateralSection');
                    
                    if (loanTypeSelect && collateralSection) {
                        loanTypeSelect.addEventListener('change', function() {
                            if (this.value === 'margin' || this.value === 'secured') {
                                collateralSection.style.display = 'block';
                                document.getElementById('collateral_security_id').required = true;
                                document.getElementById('collateral_quantity').required = true;
                            } else {
                                collateralSection.style.display = 'none';
                                document.getElementById('collateral_security_id').required = false;
                                document.getElementById('collateral_quantity').required = false;
                            }
                        });
                    }
                    
                    // Create loan form submission
                    const createLoanBtn = document.getElementById('createLoanBtn');
                    if (createLoanBtn) {
                        createLoanBtn.addEventListener('click', function() {
                            const form = document.getElementById('newLoanForm');
                            const formData = new FormData(form);
                            const data = Object.fromEntries(formData.entries());
                            
                            // Show loading state
                            createLoanBtn.disabled = true;
                            createLoanBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';
                            
                            fetch('/market/loans/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: data
                                })
                            })
                            .then(response => response.json())
                            .then(result => {
                                const payload = result?.result || result;
                                if (payload?.success) {
                                    alert('Success: ' + payload.message);
                                    window.location.reload();
                                } else {
                                    alert('Error: ' + (payload?.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                alert('Error: ' + error.message);
                            })
                            .finally(() => {
                                createLoanBtn.disabled = false;
                                createLoanBtn.innerHTML = 'Create Loan';
                            });
                        });
                    }
                    
                    // Loan action buttons
                    document.addEventListener('click', function(event) {
                        if (event.target.closest('.loan-action-btn')) {
                            const btn = event.target.closest('.loan-action-btn');
                            const loanId = btn.dataset.loanId;
                            const action = btn.dataset.action;
                            
                            if (confirm(`Are you sure you want to ${action} this loan?`)) {
                                btn.disabled = true;
                                btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                                
                                fetch(`/market/loans/${loanId}/action`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: { action: action }
                                    })
                                })
                                .then(response => response.json())
                                .then(result => {
                                    const payload = result?.result || result;
                                    if (payload?.success) {
                                        alert('Success: ' + payload.message);
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + (payload?.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    alert('Error: ' + error.message);
                                })
                                .finally(() => {
                                    btn.disabled = false;
                                    btn.innerHTML = action.charAt(0).toUpperCase() + action.slice(1);
                                });
                            }
                        }
                    });
                    
                    // Payment modal setup
                    const paymentModal = document.getElementById('paymentModal');
                    if (paymentModal) {
                        paymentModal.addEventListener('show.bs.modal', function(event) {
                            const button = event.relatedTarget;
                            const loanId = button.getAttribute('data-loan-id');
                            const loanName = button.getAttribute('data-loan-name');
                            const emiAmount = button.getAttribute('data-emi-amount');
                            
                            document.getElementById('payment_loan_id').value = loanId;
                            document.getElementById('payment_loan_name').textContent = loanName;
                            document.getElementById('payment_amount').value = emiAmount;
                            document.getElementById('suggested_emi').textContent = parseFloat(emiAmount || 0).toFixed(2);
                        });
                    }
                    
                    // Make payment
                    const makePaymentBtn = document.getElementById('makePaymentBtn');
                    if (makePaymentBtn) {
                        makePaymentBtn.addEventListener('click', function() {
                            const form = document.getElementById('paymentForm');
                            const formData = new FormData(form);
                            const data = Object.fromEntries(formData.entries());
                            const loanId = data.loan_id;
                            
                            // Show loading state
                            makePaymentBtn.disabled = true;
                            makePaymentBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
                            
                            fetch(`/market/loans/${loanId}/action`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: Object.assign(data, { action: 'make_payment' })
                                })
                            })
                            .then(response => response.json())
                            .then(result => {
                                const payload = result?.result || result;
                                if (payload?.success) {
                                    alert('Success: ' + payload.message);
                                    window.location.reload();
                                } else {
                                    alert('Error: ' + (payload?.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                alert('Error: ' + error.message);
                            })
                            .finally(() => {
                                makePaymentBtn.disabled = false;
                                makePaymentBtn.innerHTML = 'Make Payment';
                            });
                        });
                    }
                });
            //]]></script>
        </t>
    </template>

    <!-- Market Commissions Template -->
    <template id="market_commissions_page" name="Market Commissions Page">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-money text-success me-2"></i>Commission Report</h2>
                            <small class="text-muted">Broker commission earnings by session</small>
                        </div>

                        <!-- Commission Summary -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Commission Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-success mb-1">$<t t-esc="'{:,.2f}'.format(total_commission)"/></h4>
                                                    <small class="text-muted">Total Commission Earned</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-primary mb-1" t-esc="len(sessions)"/>
                                                    <small class="text-muted">Sessions</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-info mb-1" t-esc="len(trades)"/>
                                                    <small class="text-muted">Total Trades</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-warning mb-1">$<t t-esc="'{:,.2f}'.format(total_commission / len(sessions) if sessions else 0)"/></h4>
                                                    <small class="text-muted">Avg Commission/Session</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Commission by Session -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Commission by Session</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="sessions">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Session</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Commission Rate</th>
                                                            <th class="text-end">Commission Earned</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="sessions" t-as="session">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="session.name"/>
                                                                    <t t-if="session.state == 'active'">
                                                                        <span class="badge bg-success ms-2">Active</span>
                                                                    </t>
                                                                    <t t-elif="session.state == 'ended'">
                                                                        <span class="badge bg-secondary ms-2">Ended</span>
                                                                    </t>
                                                                </td>
                                                                <td t-esc="session.actual_start_date and session.actual_start_date.strftime('%Y-%m-%d %H:%M') or 'Not started'"/>
                                                                <td t-esc="session.actual_end_date and session.actual_end_date.strftime('%Y-%m-%d %H:%M') or 'Ongoing'"/>
                                                                <td><t t-esc="session.broker_commission_rate"/>%</td>
                                                                <td class="text-end">
                                                                    <strong class="text-success">$<t t-esc="'{:,.2f}'.format(session_commissions.get(session, 0))"/></strong>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="text-center py-4">
                                                <i class="fa fa-inbox text-muted" style="font-size: 48px;"></i>
                                                <h5 class="mt-3 text-muted">No Sessions Available</h5>
                                                <p class="text-muted">No trading sessions have been created yet.</p>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Broker Commission Breakdown (Super User Only) -->
                        <t t-if="is_super_user and broker_commissions">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fa fa-users me-2"></i>Commission by Broker
                                                <small class="text-muted ms-2">(Super User View)</small>
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Broker</th>
                                                            <th>User Type</th>
                                                            <th class="text-center">Trades Handled</th>
                                                            <th class="text-end">Commission Earned</th>
                                                            <th class="text-center">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="broker_commissions.items()" t-as="broker_data">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="broker_data[0].name"/>
                                                                    <br/>
                                                                    <small class="text-muted" t-esc="broker_data[0].login"/>
                                                                </td>
                                                                <td>
                                                                    <span class="badge" t-attf-class="bg-{{'primary' if broker_data[0].user_type == 'broker' else 'warning' if broker_data[0].user_type == 'admin' else 'danger'}}" t-esc="broker_data[0].user_type.title()"/>
                                                                </td>
                                                                <td class="text-center">
                                                                    <strong t-esc="broker_data[1]['trades']"/>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-success">$<t t-esc="'{:,.2f}'.format(broker_data[1]['total'])"/></strong>
                                                                </td>
                                                                <td class="text-center">
                                                                    <button class="btn btn-sm btn-outline-info" onclick="toggleBrokerDetails(this)" t-att-data-broker-id="broker_data[0].id">
                                                                        <i class="fa fa-eye"></i> Details
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            <!-- Broker Details Row (Hidden by default) -->
                                                            <tr style="display: none;" t-att-id="'broker-details-' + str(broker_data[0].id)">
                                                                <td colspan="5">
                                                                    <div class="p-3 bg-light">
                                                                        <h6>Recent Trades:</h6>
                                                                        <t t-if="broker_data[1]['recent_trades']">
                                                                            <div class="table-responsive">
                                                                                <table class="table table-sm">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>Trade Date</th>
                                                                                            <th>Security</th>
                                                                                            <th>Side</th>
                                                                                            <th>Quantity</th>
                                                                                            <th>Price</th>
                                                                                            <th class="text-end">Commission</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        <t t-foreach="broker_data[1]['recent_trades']" t-as="trade">
                                                                                            <tr>
                                                                                                <td t-esc="trade.trade_date.strftime('%Y-%m-%d %H:%M') if trade.trade_date else 'N/A'"/>
                                                                                                <td t-esc="trade.security_id.symbol"/>
                                                                                                <td>
                                                                                                    <t t-if="trade.buy_order_id.entered_by_id.id == broker_data[0].id">
                                                                                                        <span class="badge bg-success">BUY</span>
                                                                                                    </t>
                                                                                                    <t t-if="trade.sell_order_id.entered_by_id.id == broker_data[0].id">
                                                                                                        <span class="badge bg-danger">SELL</span>
                                                                                                    </t>
                                                                                                </td>
                                                                                                <td t-esc="'{:,}'.format(int(trade.quantity))"/>
                                                                                                <td>$<t t-esc="'{:.2f}'.format(trade.price)"/></td>
                                                                                                <td class="text-end">
                                                                                                    $<t t-esc="'{:.2f}'.format((trade.buy_commission if trade.buy_order_id.entered_by_id.id == broker_data[0].id else 0) + (trade.sell_commission if trade.sell_order_id.entered_by_id.id == broker_data[0].id else 0))"/>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </t>
                                                                                    </tbody>
                                                                                </table>
                                                                            </div>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <p class="text-muted mb-0">No recent trades found.</p>
                                                                        </t>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            
            <!-- JavaScript for broker details toggle -->
            <script>//<![CDATA[
                function toggleBrokerDetails(button) {
                    const brokerId = button.getAttribute('data-broker-id');
                    const detailsRow = document.getElementById('broker-details-' + brokerId);
                    const icon = button.querySelector('i');
                    
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = '';
                        icon.className = 'fa fa-eye-slash';
                        button.innerHTML = '<i class="fa fa-eye-slash"></i> Hide';
                    } else {
                        detailsRow.style.display = 'none';
                        icon.className = 'fa fa-eye';
                        button.innerHTML = '<i class="fa fa-eye"></i> Details';
                    }
                }
            //]]></script>
        </t>
    </template>
    
    <!-- Portal Broker Commissions Template -->
    <template id="portal_broker_commissions" name="Portal Broker Commissions">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="hide_stats" t-value="True"/>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fa fa-money text-success me-2"></i>Commission Report</h2>
                            <small class="text-muted">
                                <t t-if="is_super_user">Broker commission earnings (Super User View)</t>
                                <t t-else="">Your commission earnings</t>
                            </small>
                        </div>

                        <!-- Commission Summary -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Commission Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-success mb-1">$<t t-esc="'{:,.2f}'.format(total_commission)"/></h4>
                                                    <small class="text-muted">Total Commission Earned</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-primary mb-1" t-esc="len(session_commissions)"/>
                                                    <small class="text-muted">Sessions</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-info mb-1" t-esc="len(recent_trades)"/>
                                                    <small class="text-muted">Recent Trades</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-warning mb-1" t-esc="len(broker_commissions) if is_super_user else '1'"/>
                                                    <small class="text-muted">
                                                        <t t-if="is_super_user">Active Brokers</t>
                                                        <t t-else="">Broker</t>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Broker Commission Breakdown (Super User Only) -->
                        <t t-if="is_super_user and broker_commissions">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fa fa-users me-2"></i>Commission by Broker
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Broker</th>
                                                            <th>User Type</th>
                                                            <th class="text-center">Trades Handled</th>
                                                            <th class="text-end">Commission Earned</th>
                                                            <th class="text-center">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="broker_commissions.items()" t-as="broker_data">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="broker_data[0].name"/>
                                                                    <br/>
                                                                    <small class="text-muted" t-esc="broker_data[0].login"/>
                                                                </td>
                                                                <td>
                                                                    <span class="badge" t-attf-class="bg-{{'primary' if broker_data[0].user_type == 'broker' else 'warning' if broker_data[0].user_type == 'admin' else 'danger'}}" t-esc="broker_data[0].user_type.title()"/>
                                                                </td>
                                                                <td class="text-center">
                                                                    <strong t-esc="broker_data[1]['trades']"/>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-success">$<t t-esc="'{:,.2f}'.format(broker_data[1]['total'])"/></strong>
                                                                </td>
                                                                <td class="text-center">
                                                                    <button class="btn btn-sm btn-outline-info" onclick="toggleBrokerDetails(this)" t-att-data-broker-id="broker_data[0].id">
                                                                        <i class="fa fa-eye"></i> Details
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            <!-- Broker Details Row (Hidden by default) -->
                                                            <tr style="display: none;" t-att-id="'broker-details-' + str(broker_data[0].id)">
                                                                <td colspan="5">
                                                                    <div class="p-3 bg-light">
                                                                        <h6>Recent Trades:</h6>
                                                                        <t t-if="broker_data[1]['recent_trades']">
                                                                            <div class="table-responsive">
                                                                                <table class="table table-sm">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>Trade Date</th>
                                                                                            <th>Security</th>
                                                                                            <th>Side</th>
                                                                                            <th>Quantity</th>
                                                                                            <th>Price</th>
                                                                                            <th class="text-end">Commission</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        <t t-foreach="broker_data[1]['recent_trades']" t-as="trade">
                                                                                            <tr>
                                                                                                <td t-esc="trade.trade_date.strftime('%Y-%m-%d %H:%M') if trade.trade_date else 'N/A'"/>
                                                                                                <td t-esc="trade.security_id.symbol"/>
                                                                                                <td>
                                                                                                    <t t-if="trade.buy_order_id.entered_by_id.id == broker_data[0].id">
                                                                                                        <span class="badge bg-success">BUY</span>
                                                                                                    </t>
                                                                                                    <t t-if="trade.sell_order_id.entered_by_id.id == broker_data[0].id">
                                                                                                        <span class="badge bg-danger">SELL</span>
                                                                                                    </t>
                                                                                                </td>
                                                                                                <td t-esc="'{:,}'.format(int(trade.quantity))"/>
                                                                                                <td>$<t t-esc="'{:.2f}'.format(trade.price)"/></td>
                                                                                                <td class="text-end">
                                                                                                    $<t t-esc="'{:.2f}'.format((trade.buy_commission if trade.buy_order_id.entered_by_id.id == broker_data[0].id else 0) + (trade.sell_commission if trade.sell_order_id.entered_by_id.id == broker_data[0].id else 0))"/>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </t>
                                                                                    </tbody>
                                                                                </table>
                                                                            </div>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <p class="text-muted mb-0">No recent trades found.</p>
                                                                        </t>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>

                        <!-- Commission by Session -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Commission by Session</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="session_commissions">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Session</th>
                                                            <th class="text-end">Commission Earned</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="session_commissions.items()" t-as="session_data">
                                                            <tr>
                                                                <td>
                                                                    <strong t-esc="session_data[0]"/>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-success">$<t t-esc="'{:,.2f}'.format(session_data[1])"/></strong>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="text-center py-4">
                                                <i class="fa fa-inbox text-muted" style="font-size: 48px;"></i>
                                                <h5 class="mt-3 text-muted">No Sessions Available</h5>
                                                <p class="text-muted">No trading sessions have been created yet.</p>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- JavaScript for broker details toggle -->
            <script>//<![CDATA[
                function toggleBrokerDetails(button) {
                    const brokerId = button.getAttribute('data-broker-id');
                    const detailsRow = document.getElementById('broker-details-' + brokerId);
                    const icon = button.querySelector('i');
                    
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = '';
                        icon.className = 'fa fa-eye-slash';
                        button.innerHTML = '<i class="fa fa-eye-slash"></i> Hide';
                    } else {
                        detailsRow.style.display = 'none';
                        icon.className = 'fa fa-eye';
                        button.innerHTML = '<i class="fa fa-eye"></i> Details';
                    }
                }
            //]]></script>
        </t>
    </template>
    
</odoo> 