<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Extend portal home page -->
    <template id="portal_my_home" name="Show Stock Market Data" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type in ['investor', 'broker', 'banker']">
                <h3 class="mt-4">Stock Market Dashboard</h3>
                
                <!-- Financial Summary -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Cash Balance</h5>
                                <p class="card-text h4"><t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Portfolio Value</h5>
                                <p class="card-text h4"><t t-esc="portfolio_value or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Assets</h5>
                                <p class="card-text h4"><t t-esc="total_assets or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">P&amp;L</h5>
                                <p class="card-text h4">
                                    <span t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="profit_loss or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/>
                                        (<t t-esc="profit_loss_percentage or 0.0"/>%)
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <t t-if="user_type == 'investor'">
                            <a href="/my/order/new" class="btn btn-primary">Place New Order</a>
                            <a href="/my/portfolio" class="btn btn-secondary">View Portfolio</a>
                            <a href="/my/orders" class="btn btn-secondary">My Orders</a>
                        </t>
                        <t t-if="user_type == 'broker'">
                            <a href="/my/commissions" class="btn btn-primary">Commission Report</a>
                        </t>
                        <t t-if="user_type == 'banker'">
                            <a href="/my/banking" class="btn btn-primary">Banking Dashboard</a>
                        </t>
                        <a href="/my/market" class="btn btn-info">Market Data</a>
                    </div>
                </div>
                
                <!-- Market Movers -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Top Gainers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_gainers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-success">+<t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Top Losers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_losers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-danger"><t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>
            </t>
        </xpath>
        
        <!-- Add counts to portal docs section -->
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type == 'investor' and order_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Orders</t>
                    <t t-set="url" t-value="'/my/orders'"/>
                    <t t-set="count" t-value="order_count"/>
                </t>
            </t>
            <t t-if="request.env.user.user_type == 'investor' and position_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Positions</t>
                    <t t-set="url" t-value="'/my/portfolio'"/>
                    <t t-set="count" t-value="position_count"/>
                </t>
            </t>
            <t t-if="trade_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Trades</t>
                    <t t-set="url" t-value="'/my/trades'"/>
                    <t t-set="count" t-value="trade_count"/>
                </t>
            </t>
            <t t-if="deposit_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Deposits</t>
                    <t t-set="url" t-value="'/my/deposits'"/>
                    <t t-set="count" t-value="deposit_count"/>
                </t>
            </t>
            <t t-if="loan_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Loans</t>
                    <t t-set="url" t-value="'/my/loans'"/>
                    <t t-set="count" t-value="loan_count"/>
                </t>
            </t>
        </xpath>
    </template>
    
    <!-- Portfolio Page -->
    <template id="portal_my_portfolio" name="My Portfolio">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">My Portfolio</h1>
                </div>
                
                <t t-if="not positions">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"/> You don't have any positions yet.
                    </div>
                </t>
                
                <t t-if="positions">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fa fa-briefcase"/> Portfolio Positions</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr class="active">
                                            <th>Security</th>
                                            <th class="text-right">Quantity</th>
                                            <th class="text-right">Avg Cost</th>
                                            <th class="text-right">Market Value</th>
                                            <th class="text-right">Unrealized P&amp;L</th>
                                            <th class="text-right">P&amp;L %</th>
                                            <th class="text-right">Weight %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="positions" t-as="position">
                                            <tr>
                                                <td><t t-esc="position.security_id.symbol"/> - <t t-esc="position.security_id.name"/></td>
                                                <td class="text-right"><t t-esc="position.quantity"/></td>
                                                <td class="text-right"><t t-esc="position.average_cost" t-options='{"widget": "float", "precision": 2}'/></td>
                                                <td class="text-right"><t t-esc="position.market_value or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-esc="position.unrealized_pnl or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/>
                                                    </span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-esc="position.unrealized_pnl_percent" t-options='{"widget": "float", "precision": 2}'/>%
                                                    </span>
                                                </td>
                                                <td class="text-right"><t t-esc="position.portfolio_weight" t-options='{"widget": "float", "precision": 2}'/>%</td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>
    
    <!-- Order Entry Page -->
    <template id="portal_order_new" name="Place New Order">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Order Entry Content (for embedding in other templates) -->
    <template id="portal_order_new_content" name="Place New Order Content">
        <div class="container-fluid">
            <div class="page-header mb-4">
                <h1 class="h2">Place New Order</h1>
            </div>
            
            <t t-if="error">
                <div class="alert alert-danger" role="alert">
                    <t t-esc="error"/>
                </div>
            </t>
                
                <t t-if="active_session">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="order_form" method="post">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <!-- Client Selection for Brokers -->
                                <t t-if="user.user_type == 'broker'">
                                    <div class="form-group">
                                        <label for="client_id">Select Client</label>
                                        <select class="form-control" id="client_id" name="client_id" required="required">
                                            <option value="">-- Select Client --</option>
                                            <t t-foreach="clients" t-as="client">
                                                <option t-att-value="client.id" t-att-data-cash="client.cash_balance">
                                                    <t t-esc="client.name"/> (Cash: $<t t-esc="'{:,.2f}'.format(client.cash_balance)"/>)
                                                </option>
                                            </t>
                                        </select>
                                    </div>
                                    
                                    <div id="client_info" class="alert alert-info" style="display: none;">
                                        <strong>Client Info:</strong>
                                        <div id="client_cash">Cash Balance: $0.00</div>
                                        <div id="client_portfolio">Portfolio Value: $0.00</div>
                                    </div>
                                </t>
                                
                                <div class="form-group">
                                    <label for="side">Order Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="side" id="side_buy" value="buy" checked="checked"/>
                                            <label class="form-check-label" for="side_buy">Buy</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="side" id="side_sell" value="sell"/>
                                            <label class="form-check-label" for="side_sell">Sell</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="security_id">Security</label>
                                    <select name="security_id" id="security_id" class="form-control" required="required">
                                        <option value="">Select Security</option>
                                        <t t-foreach="securities" t-as="security">
                                            <option t-att-value="security.id" t-att-data-price="security.current_price">
                                                <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                (Current: <t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/>)
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="order_type">Price Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="order_type" id="order_type_limit" value="limit" checked="checked"/>
                                            <label class="form-check-label" for="order_type_limit">Limit</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="order_type" id="order_type_market" value="market"/>
                                            <label class="form-check-label" for="order_type_market">Market</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="quantity">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" required="required"/>
                                </div>
                                
                                <div class="form-group" id="price_group">
                                    <label for="price">Price</label>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0.01" required="required"/>
                                </div>
                                
                                <div class="form-group">
                                    <label>Estimated Order Value</label>
                                    <p class="form-control-static h4" id="order_value">0.00</p>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Submit Order</button>
                                <a href="/my" class="btn btn-secondary">Cancel</a>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Account Information</h5>
                                </div>
                                <div class="card-body">
                                    <p>Cash Balance: <strong><t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></strong></p>
                                    <p>Active Session: <strong><t t-esc="active_session.name"/></strong></p>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="positions_card" style="display:none;">
                                <div class="card-header">
                                    <h5>Your Positions</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Security</th>
                                                <th>Available</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="positions" t-as="position">
                                                <tr t-att-data-security-id="position.security_id.id">
                                                    <td><t t-esc="position.security_id.symbol"/></td>
                                                    <td><t t-esc="position.available_quantity"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
            
            <script>
                $(document).ready(function() {
                    // Calculate order value
                    function calculateOrderValue() {
                        var quantity = parseFloat($('#quantity').val()) || 0;
                        var price = parseFloat($('#price').val()) || 0;
                        var value = quantity * price;
                        $('#order_value').text(value.toFixed(2));
                    }
                    
                    $('#quantity, #price').on('input', calculateOrderValue);
                    
                    // Handle order type change
                    $('input[name="order_type"]').change(function() {
                        if ($(this).val() === 'market') {
                            $('#price_group').hide();
                            $('#price').prop('required', false);
                        } else {
                            $('#price_group').show();
                            $('#price').prop('required', true);
                        }
                    });
                    
                    // Handle side change
                    $('input[name="side"]').change(function() {
                        if ($(this).val() === 'sell') {
                            $('#positions_card').show();
                        } else {
                            $('#positions_card').hide();
                        }
                    });
                    
                    // Set current price when security changes
                    $('#security_id').change(function() {
                        var selectedOption = $(this).find('option:selected');
                        var currentPrice = selectedOption.data('price');
                        if (currentPrice) {
                            $('#price').val(currentPrice);
                            calculateOrderValue();
                        }
                    });
                    
                    // Handle client selection change (for brokers)
                    $('#client_id').change(function() {
                        var selectedOption = $(this).find('option:selected');
                        var clientCash = selectedOption.data('cash');
                        if (clientCash !== undefined) {
                            $('#client_cash').text('Cash Balance: $' + clientCash.toLocaleString('en-US', {minimumFractionDigits: 2}));
                            $('#client_info').show();
                        } else {
                            $('#client_info').hide();
                        }
                    });
                    
                    // Submit order
                    $('#order_form').submit(function(e) {
                        e.preventDefault();
                        
                        var formData = {
                            security_id: $('#security_id').val(),
                            side: $('input[name="side"]:checked').val(),
                            order_type: $('input[name="order_type"]:checked').val(),
                            quantity: $('#quantity').val(),
                            price: $('#price').val()
                        };
                        
                        // Add client_id if broker is placing order
                        if ($('#client_id').length) {
                            formData.client_id = $('#client_id').val();
                            if (!formData.client_id) {
                                alert('Please select a client');
                                return;
                            }
                        }
                        
                        $.ajax({
                            url: '/my/order/create',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-Csrf-Token': $('input[name="csrf_token"]').val()
                            },
                            success: function(result) {
                                if (result.success) {
                                    alert(result.message);
                                    window.location.href = '/my/orders';
                                } else {
                                    alert('Error: ' + result.error);
                                }
                            },
                            error: function() {
                                alert('Error submitting order');
                            }
                        });
                    });
                });
            </script>
    </template>
    
    <!-- Market Data Page -->
    <template id="portal_market_data" name="Market Data">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">Market Data</h1>
                </div>
                
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#all">All Securities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#stocks">Stocks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#bonds">Bonds</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#mf">Mutual Funds</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div id="all" class="tab-pane fade show active">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Change</th>
                                    <th class="text-right">Change %</th>
                                    <th class="text-right">Volume</th>
                                    <th class="text-right">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="securities" t-as="security">
                                    <tr>
                                        <td><strong><t t-esc="security.symbol"/></strong></td>
                                        <td><t t-esc="security.name"/></td>
                                        <td><t t-esc="security.security_type"/></td>
                                        <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                            </span>
                                        </td>
                                        <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        <td class="text-right"><t t-esc="security.value_today or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <t t-foreach="grouped_securities" t-as="sec_type">
                        <div t-att-id="sec_type" class="tab-pane fade">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th class="text-right">Price</th>
                                        <th class="text-right">Change</th>
                                        <th class="text-right">Change %</th>
                                        <th class="text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="grouped_securities[sec_type]" t-as="security">
                                        <tr>
                                            <td><strong><t t-esc="security.symbol"/></strong></td>
                                            <td><t t-esc="security.name"/></td>
                                            <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                                </span>
                                            </td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                                </span>
                                            </td>
                                            <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- JavaScript for real-time updates -->
    <template id="portal_stock_js" name="Stock Portal JavaScript">
        <script>//<![CDATA[
            // Global namespace for stock portal functionality
            window.stockPortal = window.stockPortal || {};
            
            // Portfolio refresh functionality
            function refreshPortfolioSummary() {
                fetch('/api/portfolio/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update portfolio values on dashboard
                        const cashEl = document.querySelector('[data-portfolio="cash"]');
                        const portfolioEl = document.querySelector('[data-portfolio="value"]');
                        const totalEl = document.querySelector('[data-portfolio="total"]');
                        const plEl = document.querySelector('[data-portfolio="pl"]');
                        
                        if (cashEl) cashEl.textContent = '$' + data.cash_balance.toLocaleString();
                        if (portfolioEl) portfolioEl.textContent = '$' + data.portfolio_value.toLocaleString();
                        if (totalEl) totalEl.textContent = '$' + data.total_assets.toLocaleString();
                        if (plEl) {
                            plEl.textContent = '$' + data.profit_loss.toLocaleString() + ' (' + data.profit_loss_percentage + '%)';
                            plEl.className = data.profit_loss >= 0 ? 'text-success' : 'text-danger';
                        }
                        
                        console.log('Portfolio data refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing portfolio:', error);
                });
            }
            
            // Market data refresh functionality
            function refreshMarketQuotes() {
                const symbols = [];
                document.querySelectorAll('[data-symbol]').forEach(el => {
                    symbols.push(el.dataset.symbol);
                });
                
                if (symbols.length === 0) return;
                
                fetch('/api/market/quotes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({symbols: symbols})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.quotes) {
                        data.quotes.forEach(quote => {
                            const rows = document.querySelectorAll(`[data-symbol="${quote.symbol}"]`);
                            rows.forEach(row => {
                                const priceEl = row.querySelector('.quote-price');
                                const changeEl = row.querySelector('.quote-change');
                                const pctEl = row.querySelector('.quote-percentage');
                                
                                if (priceEl) priceEl.textContent = quote.current_price.toFixed(2);
                                if (changeEl) {
                                    changeEl.textContent = quote.price_change.toFixed(2);
                                    changeEl.className = quote.price_change >= 0 ? 'text-success' : 'text-danger';
                                }
                                if (pctEl) {
                                    pctEl.textContent = quote.change_percentage + '%';
                                    pctEl.className = quote.change_percentage >= 0 ? 'text-success' : 'text-danger';
                                }
                            });
                        });
                        console.log('Market quotes refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing market quotes:', error);
                });
            }
            
            // Order submission with enhanced validation
            function submitOrder(formData) {
                const submitBtn = document.querySelector('#submit-order-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...';
                }
                
                return fetch('/my/order/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Order';
                    }
                    
                    if (data.success) {
                        showNotification('Success', data.message, 'success');
                        // Refresh portfolio data
                        setTimeout(refreshPortfolioSummary, 1000);
                    } else {
                        showNotification('Error', data.error, 'danger');
                    }
                    
                    return data;
                })
                .catch(error => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Order';
                    }
                    console.error('Order submission error:', error);
                    showNotification('Error', 'Network error occurred', 'danger');
                    throw error;
                });
            }
            
            // Notification system
            function showNotification(title, message, type) {
                // Remove existing notifications
                const existing = document.querySelectorAll('.stock-notification');
                existing.forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} alert-dismissible stock-notification`;
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Start periodic updates for real-time data
                if (window.location.pathname.startsWith('/my')) {
                    // Refresh portfolio every 30 seconds
                    setInterval(refreshPortfolioSummary, 30000);
                    
                    // Refresh market quotes every 15 seconds
                    setInterval(refreshMarketQuotes, 15000);
                    
                    console.log('Stock portal real-time updates initialized');
                }
            });
            
            // Expose functions globally
            window.stockPortal.refreshPortfolioSummary = refreshPortfolioSummary;
            window.stockPortal.refreshMarketQuotes = refreshMarketQuotes;
            window.stockPortal.submitOrder = submitOrder;
            window.stockPortal.showNotification = showNotification;
        //]]></script>
    </template>
    
    <!-- Custom Market Portal Layout -->
    <!-- Enhanced Portal Layout with Sidebar -->
    <template id="market_portal_layout" name="Stock Market Portal Layout">
        <t t-call="web.frontend_layout">
            <t t-set="pageName" t-value="'stock_market'"/>
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <!-- Hide Default Navbar -->
            <style>
                /* Hide Odoo's default navbar to prevent duplication */
                .o_main_navbar,
                .navbar.navbar-expand.navbar-light.bg-light,
                header.o_main_navbar {
                    display: none !important;
                }
                
                /* Ensure our custom layout takes full viewport */
                .stock-portal-layout {
                    min-height: 100vh;
                    position: relative;
                }
                
                /* Custom navbar user dropdown styling */
                .navbar-user.dropdown {
                    position: relative;
                }
                
                .user-dropdown-toggle {
                    display: flex;
                    align-items: center;
                    text-decoration: none;
                    color: inherit;
                    cursor: pointer;
                    padding: 0.5rem;
                    border-radius: 0.375rem;
                    transition: background-color 0.2s ease;
                }
                
                .user-dropdown-toggle:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    color: inherit;
                    text-decoration: none;
                }
                
                .navbar-user .dropdown-menu {
                    min-width: 200px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    background-color: #fff;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    margin-top: 0.5rem;
                }
                
                .navbar-user .dropdown-item {
                    padding: 0.75rem 1rem;
                    color: #374151;
                    display: flex;
                    align-items: center;
                }
                
                .navbar-user .dropdown-item:hover {
                    background-color: #f3f4f6;
                    color: #1f2937;
                }
                
                .navbar-user .dropdown-item i {
                    width: 16px;
                    text-align: center;
                }
            </style>
            
            <div class="stock-portal-layout">
                <!-- Sidebar Navigation -->
                <nav class="stock-sidebar" id="stockSidebar">
                    <!-- Sidebar Header -->
                    <div class="stock-sidebar-header">
                        <a href="/market" class="sidebar-brand">
                            <div class="sidebar-brand-icon">
                                <i class="fa fa-chart-line"></i>
                            </div>
                            <div class="sidebar-brand-text">Stock Market</div>
                        </a>
                        <div class="stock-sidebar-toggle" onclick="toggleStockSidebar()">
                            <i class="fa fa-angle-left"></i>
                        </div>
                    </div>
                    
                    <!-- Sidebar Navigation -->
                    <div class="stock-sidebar-nav">
                        <!-- Main Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Trading</div>
                            <a href="/market" class="nav-link" data-page="dashboard">
                                <i class="fa fa-tachometer-alt"></i>
                                <span class="nav-text">Dashboard</span>
                            </a>
                            <a href="/market/trading" class="nav-link" data-page="trading">
                                <i class="fa fa-exchange-alt"></i>
                                <span class="nav-text">Trading</span>
                            </a>
                            <t t-if="request.env.user.user_type in ['investor', 'broker']">
                                <a href="/market/orders" class="nav-link" data-page="orders">
                                    <i class="fa fa-list-ul"></i>
                                    <span class="nav-text">Orders</span>
                                    <span class="nav-badge" t-if="order_count"><t t-esc="order_count"/></span>
                                </a>
                            </t>
                        </div>
                        
                        <!-- Portfolio Section -->
                        <t t-if="request.env.user.user_type in ['investor', 'broker']">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Portfolio</div>
                                <a href="/market/portfolio" class="nav-link" data-page="portfolio">
                                    <i class="fa fa-briefcase"></i>
                                    <span class="nav-text">Positions</span>
                                    <span class="nav-badge" t-if="position_count"><t t-esc="position_count"/></span>
                                </a>
                                <a href="/market/trades" class="nav-link" data-page="trades">
                                    <i class="fa fa-history"></i>
                                    <span class="nav-text">Trade History</span>
                                </a>
                                <a href="/market/performance" class="nav-link" data-page="performance">
                                    <i class="fa fa-chart-area"></i>
                                    <span class="nav-text">Performance</span>
                                </a>
                            </div>
                        </t>
                        
                        <!-- Banking Section -->
                        <t t-if="request.env.user.user_type in ['investor', 'banker']">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Banking</div>
                                <a href="/market/deposits" class="nav-link" data-page="deposits">
                                    <i class="fa fa-piggy-bank"></i>
                                    <span class="nav-text">Deposits</span>
                                    <span class="nav-badge" t-if="deposit_count"><t t-esc="deposit_count"/></span>
                                </a>
                                <a href="/market/loans" class="nav-link" data-page="loans">
                                    <i class="fa fa-hand-holding-usd"></i>
                                    <span class="nav-text">Loans</span>
                                    <span class="nav-badge" t-if="loan_count"><t t-esc="loan_count"/></span>
                                </a>
                            </div>
                        </t>
                        
                        <!-- Broker Section -->
                        <t t-if="request.env.user.user_type == 'broker'">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Broker Tools</div>
                                <a href="/market/commissions" class="nav-link" data-page="commissions">
                                    <i class="fa fa-percentage"></i>
                                    <span class="nav-text">Commissions</span>
                                </a>
                                <a href="/market/clients" class="nav-link" data-page="clients">
                                    <i class="fa fa-users"></i>
                                    <span class="nav-text">Clients</span>
                                </a>
                            </div>
                        </t>
                        
                        <!-- Market Data Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Market</div>
                            <a href="/market/securities" class="nav-link" data-page="securities">
                                <i class="fa fa-chart-bar"></i>
                                <span class="nav-text">Securities</span>
                            </a>
                            <a href="/market/session" class="nav-link" data-page="session">
                                <i class="fa fa-clock"></i>
                                <span class="nav-text">Session Info</span>
                            </a>
                            <a href="/market/reports" class="nav-link" data-page="reports">
                                <i class="fa fa-file-alt"></i>
                                <span class="nav-text">Reports</span>
                            </a>
                        </div>
                        
                        <!-- Account Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Account</div>
                            <a href="/my/account" class="nav-link" data-page="account">
                                <i class="fa fa-user-cog"></i>
                                <span class="nav-text">Settings</span>
                            </a>
                            <a href="/web/session/logout" class="nav-link">
                                <i class="fa fa-sign-out-alt"></i>
                                <span class="nav-text">Logout</span>
                            </a>
                        </div>
                    </div>
                </nav>
                
                <!-- Main Content -->
                <main class="stock-main-content">
                    <!-- Top Navigation Bar -->
                    <header class="stock-navbar">
                        <div class="navbar-content">
                            <div class="navbar-title">
                                <i class="fa fa-chart-line title-icon"></i>
                                <span t-esc="page_title or 'Stock Market Portal'"/>
                            </div>
                            
                            <div class="navbar-actions">
                                <!-- Session Status -->
                                <t t-if="active_session">
                                    <div class="navbar-notification" title="Session Active">
                                        <i class="fa fa-clock text-success"></i>
                                    </div>
                                </t>
                                <t t-if="not active_session">
                                    <div class="navbar-notification" title="Session Closed">
                                        <i class="fa fa-clock text-danger"></i>
                                    </div>
                                </t>
                                
                                <!-- Market Status -->
                                <div class="navbar-notification" title="Market Status">
                                    <i class="fa fa-globe" t-attf-style="color: #{active_session and 'var(--stock-success)' or 'var(--stock-danger)'}"></i>
                                </div>
                                
                                <!-- User Info with Dropdown -->
                                <div class="navbar-user dropdown">
                                    <a href="#" class="user-dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <div class="user-avatar">
                                            <t t-esc="request.env.user.name[:2].upper()"/>
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name" t-esc="request.env.user.name"/>
                                            <div class="user-role" t-esc="request.env.user.user_type"/>
                                        </div>
                                        <i class="fa fa-chevron-down ms-2"></i>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/my/home"><i class="fa fa-user me-2"></i>My Account</a></li>
                                        <li><a class="dropdown-item" href="/odoo"><i class="fa fa-th me-2"></i>Backend</a></li>
                                        <li><hr class="dropdown-divider"/></li>
                                        <li><a class="dropdown-item" href="/web/session/logout?redirect=/"><i class="fa fa-sign-out me-2"></i>Logout</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <!-- Page Content -->
                    <div class="container-fluid px-4 py-4">
                        <!-- Financial Summary Cards -->
                        <div class="stock-dashboard-stats mb-4">
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Cash Balance</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-success-light); --icon-color: var(--stock-success);">
                                        <i class="fa fa-wallet"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    <t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                </div>
                                <div class="stat-change neutral">
                                    Available for trading
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Portfolio Value</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-info-light); --icon-color: var(--stock-info);">
                                        <i class="fa fa-briefcase"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    <t t-esc="portfolio_value or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                </div>
                                <div class="stat-change neutral">
                                    Current market value
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Total Assets</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-primary-light); --icon-color: var(--stock-primary);">
                                        <i class="fa fa-chart-pie"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    <t t-esc="total_assets or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                </div>
                                <div class="stat-change neutral">
                                    Cash + Portfolio
                                </div>
                            </div>
                            
                            <div class="stock-stat-card" t-attf-class="#{(profit_loss or 0.0) >= 0 and 'profit' or 'loss'}">
                                <div class="stat-header">
                                    <h6 class="stat-title">P&amp;L</h6>
                                    <div class="stat-icon" t-attf-style="--icon-bg: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success-light)' or 'var(--stock-danger-light)'}; --icon-color: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success)' or 'var(--stock-danger)'};">
                                        <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    <t t-esc="profit_loss or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                </div>
                                <div t-attf-class="stat-change #{(profit_loss or 0.0) >= 0 and 'positive' or 'negative'}">
                                    <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    <t t-esc="profit_loss_percentage or 0.0"/>%
                                </div>
                            </div>
                        </div>

                        <!-- Session Status Alert -->
                        <div class="alert alert-info d-flex align-items-center mb-4" t-if="active_session">
                            <i class="fa fa-clock me-2"></i>
                            <div>
                                <strong>Active Session:</strong> <t t-esc="active_session.name"/> - 
                                Session ends at <t t-esc="active_session.planned_end_date" t-options='{"widget": "datetime"}'/>
                            </div>
                        </div>
                        <div class="alert alert-warning d-flex align-items-center mb-4" t-if="not active_session">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>No Active Session</strong> - Trading is currently closed
                            </div>
                        </div>

                        <!-- Main Page Content -->
                        <t t-raw="0"/>
                    </div>
                </main>
            </div>
        </t>
        
        <!-- JavaScript for Sidebar -->
        <script>//<![CDATA[
            function toggleStockSidebar() {
                const sidebar = document.getElementById('stockSidebar');
                sidebar.classList.toggle('collapsed');
                
                // Save state
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('stock_sidebar_collapsed', isCollapsed);
            }
            
            // Load saved sidebar state
            document.addEventListener('DOMContentLoaded', function() {
                const isCollapsed = localStorage.getItem('stock_sidebar_collapsed') === 'true';
                const sidebar = document.getElementById('stockSidebar');
                if (isCollapsed && sidebar) {
                    sidebar.classList.add('collapsed');
                }
                
                // Set active navigation
                const currentPath = window.location.pathname;
                const navLinks = document.querySelectorAll('.stock-sidebar .nav-link');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    const href = link.getAttribute('href');
                    if (href && (currentPath === href || currentPath.startsWith(href + '/'))) {
                        link.classList.add('active');
                    }
                });
            });
        //]]></script>
    </template>
    
    <!-- Market Dashboard View -->
    <template id="market_dashboard_view" name="Market Dashboard View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="page_title">Dashboard</t>
            
            <!-- Quick Actions -->
            <div class="row mb-4" t-if="user.user_type == 'investor'">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <a href="/market/trading" class="btn btn-primary">
                                    <i class="fa fa-exchange"></i> Place Order
                                </a>
                                <a href="/market/portfolio" class="btn btn-info">
                                    <i class="fa fa-briefcase"></i> View Portfolio
                                </a>
                                <a href="/market/orders" class="btn btn-secondary">
                                    <i class="fa fa-list"></i> My Orders
                                </a>
                                <a href="/my/banking" class="btn btn-success">
                                    <i class="fa fa-university"></i> Banking
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Movers -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-up"></i> Top Gainers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_gainers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_gainers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            <t t-esc="security.current_price" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                        </td>
                                        <td class="text-end text-success">
                                            +<t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_gainers">No gainers today</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-down"></i> Top Losers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_losers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_losers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            <t t-esc="security.current_price" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                        </td>
                                        <td class="text-end text-danger">
                                            <t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_losers">No losers today</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Securities -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa fa-chart-line"></i> All Securities</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" t-if="securities">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Change</th>
                                            <th class="text-end">Change %</th>
                                            <th class="text-end">Volume</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="securities" t-as="sec">
                                            <td><strong><t t-esc="sec.symbol"/></strong></td>
                                            <td><t t-esc="sec.name"/></td>
                                            <td><span class="badge bg-secondary"><t t-esc="sec.security_type"/></span></td>
                                            <td class="text-end">
                                                <t t-esc="sec.current_price" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="sec.change_amount" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="sec.change_percentage"/>%
                                            </td>
                                            <td class="text-end"><t t-esc="sec.volume_today"/></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p class="text-center text-muted p-3 mb-0" t-if="not securities">No securities available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </t>
    </template>
    
    <!-- Market Portfolio View -->
    <template id="market_portfolio_view" name="Market Portfolio View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-briefcase me-2"></i>My Portfolio</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Security</th>
                                    <th>Quantity</th>
                                    <th>Avg Cost</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>P&amp;L</th>
                                    <th>P&amp;L %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="positions" t-as="position">
                                    <td><strong><t t-esc="position.security_id.symbol"/></strong><br/><small class="text-muted"><t t-esc="position.security_id.name"/></small></td>
                                    <td><t t-esc="position.quantity"/></td>
                                    <td><t t-esc="position.average_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td><t t-esc="position.security_id.current_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td><t t-esc="position.market_value or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                    </td>
                                    <td t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl_percent or 0.0"/>%
                                    </td>
                                </tr>
                                <tr t-if="not positions">
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="fa fa-inbox fa-3x mb-3 d-block"></i>
                                        No positions yet. Start trading to build your portfolio!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Market Trading View -->
    <template id="market_trading_view" name="Market Trading View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <h4 class="mb-4"><i class="fa fa-exchange-alt me-2"></i>Trading Platform</h4>
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Market Orders View -->
    <template id="market_orders_view" name="Market Orders View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-list-ul me-2"></i>My Orders</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Security</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="orders" t-as="order">
                                    <td><span class="badge bg-secondary"><t t-esc="order.name"/></span></td>
                                    <td><strong><t t-esc="order.security_id.symbol"/></strong></td>
                                    <td>
                                        <span t-attf-class="badge #{order.side == 'buy' and 'bg-success' or 'bg-danger'}">
                                            <t t-esc="order.side.upper()"/>
                                        </span>
                                    </td>
                                    <td><t t-esc="order.order_type"/></td>
                                    <td><t t-esc="order.quantity"/></td>
                                    <td><t t-esc="order.price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td>
                                        <span t-attf-class="badge #{order.status == 'filled' and 'bg-success' or order.status == 'cancelled' and 'bg-danger' or 'bg-warning'}">
                                            <t t-esc="order.status.upper()"/>
                                        </span>
                                    </td>
                                    <td><small><t t-esc="order.create_date" t-options='{"widget": "datetime"}'/></small></td>
                                </tr>
                                <tr t-if="not orders">
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fa fa-list fa-3x mb-3 d-block"></i>
                                        No orders yet. Place your first order to get started!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Remove "Powered by Odoo" Footer - Disabled for Odoo 18 compatibility -->
    <!-- 
    <template id="remove_odoo_branding" inherit_id="portal.portal_layout" priority="99">
        <xpath expr="//footer" position="replace">
            <footer class="bg-light mt-5 py-4">
                <div class="container">
                    <div class="text-center text-muted">
                        <p class="mb-0">© <t t-esc="datetime.datetime.now().year"/> Stock Market Simulation Portal</p>
                        <small>Professional Trading Platform</small>
                    </div>
                </div>
            </footer>
        </xpath>
    </template>
    -->
    
    <!-- Redirect /my to /market - Disabled for Odoo 18 compatibility -->
    <!--
    <template id="redirect_my_to_market" inherit_id="portal.portal_my_home" priority="99">
        <xpath expr="//div[hasclass('o_portal_wrap')]" position="after">
            <script>
                if (window.location.pathname === '/my' || window.location.pathname === '/my/') {
                    window.location.href = '/market';
                }
            </script>
        </xpath>
    </template>
    -->

    <!-- WIKI-Style Error Page Template -->
    <template id="stock_error_page" name="Stock Market Error Page">
        <t t-call="web.frontend_layout">
            <t t-set="pageName" t-value="'stock_error'"/>
            
            <div class="stock-portal-layout">
                <!-- Error Page Content -->
                <div class="container-fluid">
                    <div class="error-page">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-xl-6">
                                <div class="error-content text-center">
                                    <!-- Error Status -->
                                    <div class="error-status mb-4">
                                        <h1 class="error-code" t-esc="status_code"/>
                                        <h2 class="error-title" t-esc="status_message"/>
                                        <p class="error-description text-muted" t-esc="description"/>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="error-actions mb-5">
                                        <a href="/market" class="btn btn-primary me-2">
                                            <i class="fa fa-home"/> Back to Market
                                        </a>
                                        <a href="javascript:history.back()" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left"/> Go Back
                                        </a>
                                    </div>

                                    <!-- Suggestions (only for 404/403) -->
                                    <t t-if="show_suggestions">
                                        <div class="error-suggestions">
                                            <!-- Active Sessions -->
                                            <t t-if="suggested_sessions">
                                                <div class="suggestion-section mb-4">
                                                    <h5>Active Trading Sessions</h5>
                                                    <div class="row">
                                                        <t t-foreach="suggested_sessions" t-as="session">
                                                            <div class="col-md-6 mb-3">
                                                                <div class="card h-100">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title" t-field="session.name"/>
                                                                        <p class="card-text text-muted">
                                                                            <span class="badge" t-attf-class="badge-#{session.state}">
                                                                                <t t-esc="session.state.title()"/>
                                                                            </span>
                                                                        </p>
                                                                        <a t-attf-href="/market/session/#{session.id}" class="btn btn-sm btn-outline-primary">
                                                                            View Session
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>

                                            <!-- Popular Securities -->
                                            <t t-if="popular_securities">
                                                <div class="suggestion-section">
                                                    <h5>Available Securities</h5>
                                                    <div class="row">
                                                        <t t-foreach="popular_securities" t-as="security">
                                                            <div class="col-md-4 mb-3">
                                                                <div class="card h-100">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title" t-field="security.name"/>
                                                                        <p class="card-text">
                                                                            <small class="text-muted" t-field="security.symbol"/>
                                                                        </p>
                                                                        <a t-attf-href="/market/security/#{security.id}" class="btn btn-sm btn-outline-success">
                                                                            View Details
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Page Styles -->
            <style>
                .error-page {
                    min-height: 80vh;
                    display: flex;
                    align-items: center;
                    padding: 2rem 0;
                }
                
                .error-code {
                    font-size: 6rem;
                    font-weight: 700;
                    color: var(--stock-primary);
                    line-height: 1;
                    margin-bottom: 0.5rem;
                }
                
                .error-title {
                    font-size: 2rem;
                    font-weight: 600;
                    color: var(--stock-text-primary);
                    margin-bottom: 1rem;
                }
                
                .error-description {
                    font-size: 1.1rem;
                    max-width: 500px;
                    margin: 0 auto 2rem;
                }
                
                .suggestion-section {
                    text-align: left;
                }
                
                .suggestion-section h5 {
                    color: var(--stock-text-primary);
                    margin-bottom: 1rem;
                    font-weight: 600;
                }
                
                .badge-active {
                    background-color: var(--stock-success);
                }
                
                .badge-planned {
                    background-color: var(--stock-warning);
                }
                
                .badge-closed {
                    background-color: var(--stock-muted);
                }
            </style>
        </t>
    </template>
    
</odoo> 