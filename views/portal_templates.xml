<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Extend portal home page -->
    <template id="portal_my_home" name="Show Stock Market Data" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type in ['investor', 'broker', 'banker']">
                <h3 class="mt-4">Stock Market Dashboard</h3>
                
                <!-- Financial Summary -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Cash Balance</h5>
                                <p class="card-text h4">$<t t-esc="'{:,.2f}'.format(cash_balance or 0.0)"/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Portfolio Value</h5>
                                <p class="card-text h4">$<t t-esc="'{:,.2f}'.format(portfolio_value or 0.0)"/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Assets</h5>
                                <p class="card-text h4">$<t t-esc="'{:,.2f}'.format(total_assets or 0.0)"/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">P&amp;L</h5>
                                <p class="card-text h4">
                                    <span t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        $<t t-esc="'{:,.2f}'.format(profit_loss or 0.0)"/>
                                        (<t t-esc="profit_loss_percentage or 0.0"/>%)
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <t t-if="user_type == 'investor'">
                            <a href="/my/order/new" class="btn btn-primary">Place New Order</a>
                            <a href="/my/portfolio" class="btn btn-secondary">View Portfolio</a>
                            <a href="/my/orders" class="btn btn-secondary">My Orders</a>
                        </t>
                        <t t-if="user_type == 'broker'">
                            <a href="/my/commissions" class="btn btn-primary">Commission Report</a>
                        </t>
                        <t t-if="user_type == 'banker'">
                            <a href="/my/banking" class="btn btn-primary">Banking Dashboard</a>
                        </t>
                        <a href="/my/market" class="btn btn-info">Market Data</a>
                    </div>
                </div>
                
                <!-- Market Movers -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Top Gainers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_gainers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-success">+<t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Top Losers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_losers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-danger"><t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>
            </t>
        </xpath>
        
        <!-- Add counts to portal docs section -->
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type == 'investor' and order_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Orders</t>
                    <t t-set="url" t-value="'/my/orders'"/>
                    <t t-set="count" t-value="order_count"/>
                </t>
            </t>
            <t t-if="request.env.user.user_type == 'investor' and position_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Positions</t>
                    <t t-set="url" t-value="'/my/portfolio'"/>
                    <t t-set="count" t-value="position_count"/>
                </t>
            </t>
            <t t-if="trade_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Trades</t>
                    <t t-set="url" t-value="'/my/trades'"/>
                    <t t-set="count" t-value="trade_count"/>
                </t>
            </t>
            <t t-if="deposit_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Deposits</t>
                    <t t-set="url" t-value="'/my/deposits'"/>
                    <t t-set="count" t-value="deposit_count"/>
                </t>
            </t>
            <t t-if="loan_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Loans</t>
                    <t t-set="url" t-value="'/my/loans'"/>
                    <t t-set="count" t-value="loan_count"/>
                </t>
            </t>
        </xpath>
    </template>
    
    <!-- Portfolio Page -->
    <template id="portal_my_portfolio" name="My Portfolio">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">My Portfolio</h1>
                </div>
                
                <t t-if="not positions">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"/> You don't have any positions yet.
                    </div>
                </t>
                
                <t t-if="positions">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fa fa-briefcase"/> Portfolio Positions</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr class="active">
                                            <th>Security</th>
                                            <th class="text-right">Quantity</th>
                                            <th class="text-right">Avg Cost</th>
                                            <th class="text-right">Market Value</th>
                                            <th class="text-right">Unrealized P&amp;L</th>
                                            <th class="text-right">P&amp;L %</th>
                                            <th class="text-right">Weight %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="positions" t-as="position">
                                            <tr>
                                                <td><t t-esc="position.security_id.symbol"/> - <t t-esc="position.security_id.name"/></td>
                                                <td class="text-right"><t t-esc="position.quantity"/></td>
                                                <td class="text-right"><t t-esc="position.average_cost" t-options='{"widget": "float", "precision": 2}'/></td>
                                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(position.market_value or 0.0)"/></td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        $<t t-esc="'{:,.2f}'.format(position.unrealized_pnl or 0.0)"/>
                                                    </span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-esc="position.unrealized_pnl_percent" t-options='{"widget": "float", "precision": 2}'/>%
                                                    </span>
                                                </td>
                                                <td class="text-right"><t t-esc="position.portfolio_weight" t-options='{"widget": "float", "precision": 2}'/>%</td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>
    
    <!-- Order Entry Page -->
    <template id="portal_order_new" name="Place New Order">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Order Entry Content (for embedding in other templates) -->
    <template id="portal_order_new_content" name="Place New Order Content">
        <div class="container-fluid">
            <div class="page-header mb-4">
                <h1 class="h2">Place New Order</h1>
            </div>
            
            <t t-if="error">
                <div class="alert alert-danger" role="alert">
                    <t t-esc="error"/>
                </div>
            </t>
                
                <t t-if="active_session">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Order Type Selection (Trading vs IPO) -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Order Category</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                            <label class="btn btn-outline-primary active" id="trading_tab">
                                                <input type="radio" name="order_category" value="trading" checked="checked"/> Regular Trading
                                            </label>
                                            <label class="btn btn-outline-success" id="ipo_tab">
                                                <input type="radio" name="order_category" value="ipo"/> IPO/PO Orders
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Investor Selection (Required for All Users) -->
                            <div class="form-group mb-4">
                                <label for="investor_id" class="form-label">Select Investor <span class="text-danger">*</span></label>
                                <select class="form-control" id="investor_id" name="investor_id" required="required">
                                    <option value="">-- Select Investor --</option>
                                    <t t-foreach="clients" t-as="client">
                                        <option t-att-value="client.id" t-att-data-cash="client.cash_balance">
                                            <t t-esc="client.name"/> (Cash: $<t t-esc="'{:,.2f}'.format(client.cash_balance)"/>)
                                        </option>
                                    </t>
                                </select>
                                <small class="form-text text-muted">Select the investor for whom this order will be placed</small>
                            </div>
                            
                            <div id="investor_info" class="alert alert-info" style="display: none;">
                                <strong>Investor Information:</strong>
                                <div id="investor_cash">Cash Balance: $0.00</div>
                                <div id="investor_portfolio">Portfolio Value: $0.00</div>
                            </div>
                            
                            <!-- Trading Order Form -->
                            <div id="trading_form" class="order-form">
                                <form id="trading_order_form" onsubmit="return false;">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="order_type_category" value="trading"/>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fa fa-line-chart me-2"></i>Regular Trading Order</h5>
                                        </div>
                                        <div class="card-body">
                                
                                <div class="form-group">
                                    <label for="side">Order Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_side" id="trading_side_buy" value="buy" checked="checked"/>
                                            <label class="form-check-label" for="trading_side_buy">Buy</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_side" id="trading_side_sell" value="sell"/>
                                            <label class="form-check-label" for="trading_side_sell">Sell</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_security_id">Trading Security</label>
                                    <select name="trading_security_id" id="trading_security_id" class="form-control" required="required">
                                        <option value="">Select Trading Security</option>
                                        <t t-foreach="trading_securities" t-as="security">
                                            <option t-att-value="security.id" t-att-data-price="security.current_price" t-att-data-status="security.ipo_status">
                                                <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                (Current: $<t t-esc="'{:,.2f}'.format(security.current_price or 0.0)"/>)
                                            </option>
                                        </t>
                                    </select>
                                    <small class="form-text text-muted">Regular trading securities (post-IPO)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_order_type">Price Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_order_type" id="trading_order_type_limit" value="limit" checked="checked"/>
                                            <label class="form-check-label" for="trading_order_type_limit">Limit</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="trading_order_type" id="trading_order_type_market" value="market"/>
                                            <label class="form-check-label" for="trading_order_type_market">Market</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trading_quantity">Quantity</label>
                                    <input type="number" class="form-control" id="trading_quantity" name="trading_quantity" min="1" required="required"/>
                                </div>
                                
                                <div class="form-group" id="trading_price_group">
                                    <label for="trading_price">Price</label>
                                    <input type="number" class="form-control" id="trading_price" name="trading_price" step="0.01" min="0.01" required="required"/>
                                </div>
                                
                                <div class="form-group">
                                    <label>Estimated Order Value</label>
                                    <p class="form-control-static h4" id="trading_order_value">$0.00</p>
                                </div>
                                
                                <button type="submit" id="submit-trading-order-btn" class="btn btn-primary">
                                    <i class="fa fa-paper-plane me-2"></i>Submit Trading Order
                                </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- IPO Order Form -->
                            <div id="ipo_form" class="order-form" style="display: none;">
                                <form id="ipo_order_form" onsubmit="return false;">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="order_type_category" value="ipo"/>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fa fa-star me-2"></i>IPO/PO Order</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <i class="fa fa-info-circle me-2"></i>
                                                <strong>IPO Orders:</strong> These are initial public offerings or public offerings. 
                                                Orders are typically at fixed prices and allocated based on availability.
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="ipo_security_id">IPO/PO Security</label>
                                                <select name="ipo_security_id" id="ipo_security_id" class="form-control" required="required">
                                                    <option value="">Select IPO/PO Security</option>
                                                    <t t-foreach="ipo_securities" t-as="security">
                                                        <option t-att-value="security.id" 
                                                                t-att-data-price="security.ipo_price or security.current_price" 
                                                                t-att-data-status="security.ipo_status"
                                                                t-att-data-total-shares="security.total_shares">
                                                            <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                            (IPO Price: $<t t-esc="'{:,.2f}'.format(security.ipo_price or security.current_price or 0.0)"/>)
                                                            <span class="badge badge-secondary ms-2"><t t-esc="security.ipo_status.upper()"/></span>
                                                        </option>
                                                    </t>
                                                </select>
                                                <small class="form-text text-muted">Available IPO and PO securities</small>
                                            </div>
                                            
                                            <div id="ipo_details" class="alert alert-secondary" style="display: none;">
                                                <strong>IPO Details:</strong>
                                                <div id="ipo_price_display">Price: $0.00</div>
                                                <div id="ipo_total_shares">Total Shares: 0</div>
                                                <div id="ipo_status_display">Status: -</div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="ipo_quantity">Requested Quantity</label>
                                                <input type="number" class="form-control" id="ipo_quantity" name="ipo_quantity" min="1" required="required"/>
                                                <small class="form-text text-muted">Enter the number of shares you want to request (subject to allocation)</small>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label>Estimated Investment</label>
                                                <p class="form-control-static h4" id="ipo_order_value">$0.00</p>
                                                <small class="text-muted">Final allocation may differ based on demand</small>
                                            </div>
                                            
                                            <button type="submit" id="submit-ipo-order-btn" class="btn btn-success">
                                                <i class="fa fa-star me-2"></i>Submit IPO Order
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="mt-3 text-center">
                                <a href="/my" class="btn btn-secondary">
                                    <i class="fa fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Session Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Active Session:</strong> <t t-esc="active_session.name"/></p>
                                    <p><strong>Order Placed By:</strong> <t t-esc="user.name"/> (<t t-esc="user.user_type.title()"/>)</p>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="selected_investor_card" style="display: none;">
                                <div class="card-header">
                                    <h5><i class="fa fa-user me-2"></i>Selected Investor</h5>
                                </div>
                                <div class="card-body">
                                    <div id="selected_investor_name">No investor selected</div>
                                    <div id="selected_investor_cash">Cash Balance: $0.00</div>
                                    <div id="selected_investor_portfolio">Portfolio Value: $0.00</div>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="trading_help_card">
                                <div class="card-header">
                                    <h5><i class="fa fa-question-circle me-2"></i>Order Types</h5>
                                </div>
                                <div class="card-body">
                                    <div class="trading-help active" id="trading_help">
                                        <h6><i class="fa fa-line-chart me-2"></i>Regular Trading</h6>
                                        <p class="small mb-2">Trade securities that are already listed and trading on the market.</p>
                                        <ul class="small mb-0">
                                            <li><strong>Limit Orders:</strong> Set your own price</li>
                                            <li><strong>Market Orders:</strong> Execute at current market price</li>
                                            <li><strong>Buy/Sell:</strong> Standard trading operations</li>
                                        </ul>
                                    </div>
                                    <div class="trading-help" id="ipo_help" style="display: none;">
                                        <h6><i class="fa fa-star me-2"></i>IPO/PO Orders</h6>
                                        <p class="small mb-2">Participate in Initial Public Offerings or Public Offerings.</p>
                                        <ul class="small mb-0">
                                            <li><strong>Fixed Pricing:</strong> IPO price is set</li>
                                            <li><strong>Allocation:</strong> Shares allocated based on demand</li>
                                            <li><strong>Request Only:</strong> Final allocation may vary</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="investor_positions_card" style="display: none;">
                                <div class="card-header">
                                    <h5><i class="fa fa-briefcase me-2"></i>Investor Positions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="investor_positions_content">
                                        <p class="text-muted">Select an investor to view positions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
            
            <script>//<![CDATA[
                // Enhanced Trading Portal JavaScript
                
                // Global variables for state management
                let selectedInvestor = null;
                let currentOrderType = 'trading';
                
                // Show notification function
                function showNotification(title, message, type = 'info') {
                    if (window.stockPortal && window.stockPortal.showToast) {
                        window.stockPortal.showToast(message, type);
                        return;
                    }
                    
                    const typeMap = {
                        'success': '✅ Success',
                        'danger': '❌ Error', 
                        'warning': '⚠️ Warning',
                        'info': 'ℹ️ Info'
                    };
                    alert(`${typeMap[type] || 'Notification'}: ${message}`);
                }
                
                // Switch between Trading and IPO order types
                function switchOrderType(orderType) {
                    currentOrderType = orderType;
                    
                    // Update tab appearance
                    const tradingTab = document.getElementById('trading_tab');
                    const ipoTab = document.getElementById('ipo_tab');
                    const tradingForm = document.getElementById('trading_form');
                    const ipoForm = document.getElementById('ipo_form');
                    const tradingHelp = document.getElementById('trading_help');
                    const ipoHelp = document.getElementById('ipo_help');
                    
                    if (orderType === 'trading') {
                        tradingTab.classList.add('active');
                        ipoTab.classList.remove('active');
                        tradingForm.style.display = 'block';
                        ipoForm.style.display = 'none';
                        tradingHelp.style.display = 'block';
                        ipoHelp.style.display = 'none';
                    } else {
                        tradingTab.classList.remove('active');
                        ipoTab.classList.add('active');
                        tradingForm.style.display = 'none';
                        ipoForm.style.display = 'block';
                        tradingHelp.style.display = 'none';
                        ipoHelp.style.display = 'block';
                    }
                    
                    console.log('Switched to order type:', orderType);
                }
                
                // Handle investor selection
                function handleInvestorSelection(investorSelect) {
                    const selectedOption = investorSelect.options[investorSelect.selectedIndex];
                    const investorCard = document.getElementById('selected_investor_card');
                    const positionsCard = document.getElementById('investor_positions_card');
                    
                    if (selectedOption && selectedOption.value) {
                        selectedInvestor = {
                            id: selectedOption.value,
                            name: selectedOption.text.split(' (Cash:')[0],
                            cash: parseFloat(selectedOption.getAttribute('data-cash')) || 0
                        };
                        
                        // Update investor info display
                        document.getElementById('selected_investor_name').innerHTML = 
                            `<strong>${selectedInvestor.name}</strong>`;
                        document.getElementById('selected_investor_cash').innerHTML = 
                            `Cash Balance: $${selectedInvestor.cash.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                        
                        investorCard.style.display = 'block';
                        positionsCard.style.display = 'block';
                        
                        // Load investor positions
                        loadInvestorPositions(selectedInvestor.id);
                    } else {
                        selectedInvestor = null;
                        investorCard.style.display = 'none';
                        positionsCard.style.display = 'none';
                    }
                }
                
                // Load investor positions
                function loadInvestorPositions(investorId) {
                    const positionsContent = document.getElementById('investor_positions_content');
                    positionsContent.innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading positions...</div>';
                    
                    fetch(`/my/investor/${investorId}/positions`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.positions) {
                            let html = '';
                            if (data.positions.length > 0) {
                                html = '<table class="table table-sm"><thead><tr><th>Security</th><th>Available</th></tr></thead><tbody>';
                                data.positions.forEach(pos => {
                                    html += `<tr><td>${pos.symbol}</td><td>${pos.available_quantity}</td></tr>`;
                                });
                                html += '</tbody></table>';
                            } else {
                                html = '<p class="text-muted text-center">No positions found</p>';
                            }
                            positionsContent.innerHTML = html;
                        } else {
                            positionsContent.innerHTML = '<p class="text-muted">Unable to load positions</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading positions:', error);
                        positionsContent.innerHTML = '<p class="text-danger">Error loading positions</p>';
                    });
                }
                
                // Calculate order values
                function calculateTradingOrderValue() {
                    const quantityEl = document.getElementById('trading_quantity');
                    const priceEl = document.getElementById('trading_price');
                    const orderValueEl = document.getElementById('trading_order_value');
                    
                    if (!quantityEl || !priceEl || !orderValueEl) return;
                    
                    const quantity = parseFloat(quantityEl.value) || 0;
                    const price = parseFloat(priceEl.value) || 0;
                    const value = quantity * price;
                    
                    orderValueEl.textContent = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                function calculateIpoOrderValue() {
                    const quantityEl = document.getElementById('ipo_quantity');
                    const securitySelect = document.getElementById('ipo_security_id');
                    const orderValueEl = document.getElementById('ipo_order_value');
                    
                    if (!quantityEl || !securitySelect || !orderValueEl) return;
                    
                    const quantity = parseFloat(quantityEl.value) || 0;
                    const selectedOption = securitySelect.options[securitySelect.selectedIndex];
                    const price = selectedOption ? parseFloat(selectedOption.getAttribute('data-price')) || 0 : 0;
                    const value = quantity * price;
                    
                    orderValueEl.textContent = `$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                // Handle IPO security selection
                function handleIpoSecuritySelection(securitySelect) {
                    const selectedOption = securitySelect.options[securitySelect.selectedIndex];
                    const detailsDiv = document.getElementById('ipo_details');
                    
                    if (selectedOption && selectedOption.value) {
                        const price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                        const totalShares = parseInt(selectedOption.getAttribute('data-total-shares')) || 0;
                        const status = selectedOption.getAttribute('data-status') || '';
                        
                        document.getElementById('ipo_price_display').textContent = 
                            `Price: $${price.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                        document.getElementById('ipo_total_shares').textContent = 
                            `Total Shares: ${totalShares.toLocaleString()}`;
                        document.getElementById('ipo_status_display').textContent = 
                            `Status: ${status.toUpperCase()}`;
                        
                        detailsDiv.style.display = 'block';
                        calculateIpoOrderValue();
                    } else {
                        detailsDiv.style.display = 'none';
                    }
                }
                
                // Handle price type changes
                function handleTradingPriceTypeChange() {
                    const limitRadio = document.getElementById('trading_order_type_limit');
                    const priceGroup = document.getElementById('trading_price_group');
                    
                    if (limitRadio && priceGroup) {
                        priceGroup.style.display = limitRadio.checked ? 'block' : 'none';
                        calculateTradingOrderValue();
                    }
                }
                
                // Submit Trading Order
                function submitTradingOrder() {
                    const form = document.getElementById('trading_order_form');
                    const submitBtn = document.getElementById('submit-trading-order-btn');
                    
                    if (!selectedInvestor) {
                        showNotification('Error', 'Please select an investor first', 'danger');
                        return;
                    }
                    
                    const formData = new FormData(form);
                    formData.append('investor_id', selectedInvestor.id);
                    formData.append('side', document.querySelector('input[name="trading_side"]:checked').value);
                    formData.append('security_id', document.getElementById('trading_security_id').value);
                    formData.append('order_type', document.querySelector('input[name="trading_order_type"]:checked').value);
                    formData.append('quantity', document.getElementById('trading_quantity').value);
                    
                    if (document.querySelector('input[name="trading_order_type"]:checked').value === 'limit') {
                        formData.append('price', document.getElementById('trading_price').value);
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
                    
                    fetch('/my/order/submit', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Success', data.message || 'Trading order submitted successfully', 'success');
                            form.reset();
                            calculateTradingOrderValue();
                        } else {
                            showNotification('Error', data.error || 'Failed to submit order', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Trading order error:', error);
                        showNotification('Error', 'Network error occurred', 'danger');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-paper-plane me-2"></i>Submit Trading Order';
                    });
                }
                
                // Submit IPO Order
                function submitIpoOrder() {
                    const form = document.getElementById('ipo_order_form');
                    const submitBtn = document.getElementById('submit-ipo-order-btn');
                    
                    if (!selectedInvestor) {
                        showNotification('Error', 'Please select an investor first', 'danger');
                        return;
                    }
                    
                    const formData = new FormData(form);
                    formData.append('investor_id', selectedInvestor.id);
                    formData.append('security_id', document.getElementById('ipo_security_id').value);
                    formData.append('quantity', document.getElementById('ipo_quantity').value);
                    formData.append('order_type', 'ipo');
                    formData.append('side', 'buy'); // IPO orders are always buy
                    
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
                    
                    fetch('/my/order/submit', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Success', data.message || 'IPO order submitted successfully', 'success');
                            form.reset();
                            calculateIpoOrderValue();
                            document.getElementById('ipo_details').style.display = 'none';
                        } else {
                            showNotification('Error', data.error || 'Failed to submit IPO order', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('IPO order error:', error);
                        showNotification('Error', 'Network error occurred', 'danger');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-star me-2"></i>Submit IPO Order';
                    });
                }
                
                // DOM Ready Event Listeners
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Enhanced Trading Portal loaded');
                    
                    // Order type tab switching
                    const tradingTab = document.getElementById('trading_tab');
                    const ipoTab = document.getElementById('ipo_tab');
                    
                    if (tradingTab) {
                        tradingTab.addEventListener('click', () => switchOrderType('trading'));
                    }
                    if (ipoTab) {
                        ipoTab.addEventListener('click', () => switchOrderType('ipo'));
                    }
                    
                    // Investor selection
                    const investorSelect = document.getElementById('investor_id');
                    if (investorSelect) {
                        investorSelect.addEventListener('change', function() {
                            handleInvestorSelection(this);
                        });
                    }
                    
                    // Trading form events
                    const tradingQuantity = document.getElementById('trading_quantity');
                    const tradingPrice = document.getElementById('trading_price');
                    const tradingSecuritySelect = document.getElementById('trading_security_id');
                    const tradingOrderTypeRadios = document.querySelectorAll('input[name="trading_order_type"]');
                    const tradingForm = document.getElementById('trading_order_form');
                    
                    if (tradingQuantity) tradingQuantity.addEventListener('input', calculateTradingOrderValue);
                    if (tradingPrice) tradingPrice.addEventListener('input', calculateTradingOrderValue);
                    if (tradingSecuritySelect) tradingSecuritySelect.addEventListener('change', calculateTradingOrderValue);
                    
                    tradingOrderTypeRadios.forEach(radio => {
                        radio.addEventListener('change', handleTradingPriceTypeChange);
                    });
                    
                    if (tradingForm) {
                        tradingForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitTradingOrder();
                        });
                    }
                    
                    // IPO form events
                    const ipoQuantity = document.getElementById('ipo_quantity');
                    const ipoSecuritySelect = document.getElementById('ipo_security_id');
                    const ipoForm = document.getElementById('ipo_order_form');
                    
                    if (ipoQuantity) ipoQuantity.addEventListener('input', calculateIpoOrderValue);
                    if (ipoSecuritySelect) {
                        ipoSecuritySelect.addEventListener('change', function() {
                            handleIpoSecuritySelection(this);
                        });
                    }
                    
                    if (ipoForm) {
                        ipoForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitIpoOrder();
                        });
                    }
                    
                    // Initialize default state
                    switchOrderType('trading');
                    handleTradingPriceTypeChange();
                });
            //]]></script>
    </template>
    
    <!-- Market Data Page -->
    <template id="portal_market_data" name="Market Data">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2">Market Data</h1>
                </div>
                
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#all">All Securities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#stocks">Stocks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#bonds">Bonds</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#mf">Mutual Funds</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div id="all" class="tab-pane fade show active">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Change</th>
                                    <th class="text-right">Change %</th>
                                    <th class="text-right">Volume</th>
                                    <th class="text-right">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="securities" t-as="security">
                                    <tr>
                                        <td><strong><t t-esc="security.symbol"/></strong></td>
                                        <td><t t-esc="security.name"/></td>
                                        <td><t t-esc="security.security_type"/></td>
                                        <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                            </span>
                                        </td>
                                        <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(security.value_today or 0.0)"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <t t-foreach="grouped_securities" t-as="sec_type">
                        <div t-att-id="sec_type" class="tab-pane fade">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th class="text-right">Price</th>
                                        <th class="text-right">Change</th>
                                        <th class="text-right">Change %</th>
                                        <th class="text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="grouped_securities[sec_type]" t-as="security">
                                        <tr>
                                            <td><strong><t t-esc="security.symbol"/></strong></td>
                                            <td><t t-esc="security.name"/></td>
                                            <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                                </span>
                                            </td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                                </span>
                                            </td>
                                            <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- JavaScript for real-time updates -->
    <template id="portal_stock_js" name="Stock Portal JavaScript">
        <script>//<![CDATA[
            // Global namespace for stock portal functionality
            window.stockPortal = window.stockPortal || {};
            
            // Portfolio refresh functionality
            function refreshPortfolioSummary() {
                fetch('/api/portfolio/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update portfolio values on dashboard
                        const cashEl = document.querySelector('[data-portfolio="cash"]');
                        const portfolioEl = document.querySelector('[data-portfolio="value"]');
                        const totalEl = document.querySelector('[data-portfolio="total"]');
                        const plEl = document.querySelector('[data-portfolio="pl"]');
                        
                        if (cashEl) cashEl.textContent = '$' + data.cash_balance.toLocaleString();
                        if (portfolioEl) portfolioEl.textContent = '$' + data.portfolio_value.toLocaleString();
                        if (totalEl) totalEl.textContent = '$' + data.total_assets.toLocaleString();
                        if (plEl) {
                            plEl.textContent = '$' + data.profit_loss.toLocaleString() + ' (' + data.profit_loss_percentage + '%)';
                            plEl.className = data.profit_loss >= 0 ? 'text-success' : 'text-danger';
                        }
                        
                        console.log('Portfolio data refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing portfolio:', error);
                });
            }
            
            // Market data refresh functionality
            function refreshMarketQuotes() {
                const symbols = [];
                document.querySelectorAll('[data-symbol]').forEach(el => {
                    symbols.push(el.dataset.symbol);
                });
                
                if (symbols.length === 0) return;
                
                fetch('/api/market/quotes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({symbols: symbols})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.quotes) {
                        data.quotes.forEach(quote => {
                            const rows = document.querySelectorAll(`[data-symbol="${quote.symbol}"]`);
                            rows.forEach(row => {
                                const priceEl = row.querySelector('.quote-price');
                                const changeEl = row.querySelector('.quote-change');
                                const pctEl = row.querySelector('.quote-percentage');
                                
                                if (priceEl) priceEl.textContent = quote.current_price.toFixed(2);
                                if (changeEl) {
                                    changeEl.textContent = quote.price_change.toFixed(2);
                                    changeEl.className = quote.price_change >= 0 ? 'text-success' : 'text-danger';
                                }
                                if (pctEl) {
                                    pctEl.textContent = quote.change_percentage + '%';
                                    pctEl.className = quote.change_percentage >= 0 ? 'text-success' : 'text-danger';
                                }
                            });
                        });
                        console.log('Market quotes refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing market quotes:', error);
                });
            }
            
            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Start periodic updates for real-time data
                if (window.location.pathname.startsWith('/my')) {
                    // Refresh portfolio every 30 seconds
                    setInterval(refreshPortfolioSummary, 30000);
                    
                    // Refresh market quotes every 15 seconds
                    setInterval(refreshMarketQuotes, 15000);
                    
                    console.log('Stock portal real-time updates initialized');
                }
            });
            
            // Expose functions globally
            window.stockPortal = window.stockPortal || {};
            window.stockPortal.refreshPortfolioSummary = refreshPortfolioSummary;
            window.stockPortal.refreshMarketQuotes = refreshMarketQuotes;
            window.stockPortal.submitOrder = submitOrder;
            window.stockPortal.showNotification = showNotification;
        //]]></script>
    </template>
    
    <!-- Custom Market Portal Layout -->
    <!-- Enhanced Portal Layout with Sidebar -->
    <template id="market_portal_layout" name="Stock Market Portal Layout">
        <t t-call="web.frontend_layout">
            <t t-set="pageName" t-value="'stock_market'"/>
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <!-- Auto-fetch active session if not provided -->
            <t t-if="not active_session">
                <t t-set="active_session" t-value="request.env['stock.session'].sudo().search([('state', '=', 'open')], limit=1)"/>
            </t>
            
            <!-- Hide Default Navbar -->
            <style>
                /* Hide Odoo's default navbar to prevent duplication */
                .o_main_navbar,
                .navbar.navbar-expand.navbar-light.bg-light,
                header.o_main_navbar {
                    display: none !important;
                }
                
                /* Ensure our custom layout takes full viewport */
                .stock-portal-layout {
                    min-height: 100vh;
                    position: relative;
                }
                
                /* Custom navbar user dropdown styling */
                .navbar-user.dropdown {
                    position: relative;
                }
                
                .user-dropdown-toggle {
                    display: flex;
                    align-items: center;
                    text-decoration: none;
                    color: inherit;
                    cursor: pointer;
                    padding: 0.5rem;
                    border-radius: 0.375rem;
                    transition: background-color 0.2s ease;
                }
                
                .user-dropdown-toggle:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    color: inherit;
                    text-decoration: none;
                }
                
                .navbar-user .dropdown-menu {
                    min-width: 200px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    background-color: #fff;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    margin-top: 0.5rem;
                }
                
                .navbar-user .dropdown-item {
                    padding: 0.75rem 1rem;
                    color: #374151;
                    display: flex;
                    align-items: center;
                }
                
                .navbar-user .dropdown-item:hover {
                    background-color: #f3f4f6;
                    color: #1f2937;
                }
                
                .navbar-user .dropdown-item i {
                    width: 16px;
                    text-align: center;
                }
            </style>
            
            <div class="stock-portal-layout">
                <!-- Sidebar Navigation -->
                <nav class="stock-sidebar" id="stockSidebar">
                    <!-- Sidebar Header -->
                    <div class="stock-sidebar-header">
                        <a href="/market" class="sidebar-brand">
                            <div class="sidebar-brand-icon">
                                <i class="fa fa-line-chart"></i>
                            </div>
                            <span class="sidebar-brand-text">Stock Market</span>
                        </a>
                        <button type="button" class="stock-sidebar-toggle-icon" aria-label="Toggle sidebar" tabindex="0">
                            <i class="fa fa-angle-left sidebar-toggle-collapse"></i>
                            <i class="fa fa-angle-right sidebar-toggle-expand"></i>
                        </button>
                    </div>
                    
                    <!-- Sidebar Navigation -->
                    <div class="stock-sidebar-nav">
                        <!-- Main Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Trading</div>
                            <a href="/market" class="nav-link" data-page="dashboard" data-tooltip="Dashboard">
                                <i class="fa fa-tachometer"></i>
                                <span class="nav-text">Dashboard</span>
                            </a>
                            <a href="/market/trading" class="nav-link" data-page="trading" data-tooltip="Trading">
                                <i class="fa fa-exchange"></i>
                                <span class="nav-text">Trading</span>
                            </a>
                            <t t-if="request.env.user.user_type in ['investor', 'broker', 'admin']">
                                <a href="/market/orders" class="nav-link" data-page="orders" data-tooltip="Orders">
                                    <i class="fa fa-list"></i>
                                    <span class="nav-text">Orders</span>
                                    <span class="nav-badge" t-if="order_count"><t t-esc="order_count"/></span>
                                </a>
                            </t>
                        </div>
                        
                        <!-- Portfolio Section -->
                        <t t-if="request.env.user.user_type in ['investor', 'broker', 'admin']">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Portfolio</div>
                                <a href="/market/portfolio" class="nav-link" data-page="portfolio" data-tooltip="Positions">
                                    <i class="fa fa-briefcase"></i>
                                    <span class="nav-text">Positions</span>
                                    <span class="nav-badge" t-if="position_count"><t t-esc="position_count"/></span>
                                </a>
                                <a href="/market/trades" class="nav-link" data-page="trades" data-tooltip="Trade History">
                                    <i class="fa fa-history"></i>
                                    <span class="nav-text">Trade History</span>
                                </a>
                                <a href="/market/performance" class="nav-link" data-page="performance" data-tooltip="Performance">
                                    <i class="fa fa-area-chart"></i>
                                    <span class="nav-text">Performance</span>
                                </a>
                            </div>
                        </t>                        <!-- Banking Section -->
                        <t t-if="request.env.user.user_type in ['investor', 'banker', 'admin']">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Banking</div>
                                <a href="/market/deposits" class="nav-link" data-page="deposits" data-tooltip="Deposits">
                                    <i class="fa fa-bank"></i>
                                    <span class="nav-text">Deposits</span>
                                    <span class="nav-badge" t-if="deposit_count"><t t-esc="deposit_count"/></span>
                                </a>
                                <a href="/market/loans" class="nav-link" data-page="loans" data-tooltip="Loans">
                                    <i class="fa fa-money"></i>
                                    <span class="nav-text">Loans</span>
                                    <span class="nav-badge" t-if="loan_count"><t t-esc="loan_count"/></span>
                                </a>
                            </div>
                        </t>
                        
                        <!-- Broker Section -->
                        <t t-if="request.env.user.user_type in ['broker', 'admin']">
                            <div class="sidebar-section">
                                <div class="sidebar-section-title">Broker Tools</div>
                                <a href="/market/commissions" class="nav-link" data-page="commissions" data-tooltip="Commissions">
                                    <i class="fa fa-percentage"></i>
                                    <span class="nav-text">Commissions</span>
                                </a>
                                <a href="/market/clients" class="nav-link" data-page="clients" data-tooltip="Clients">
                                    <i class="fa fa-users"></i>
                                    <span class="nav-text">Clients</span>
                                </a>
                            </div>
                        </t>
                        
                        <!-- Market Data Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Market</div>
                            <a href="/market/securities" class="nav-link" data-page="securities" data-tooltip="Securities">
                                <i class="fa fa-bar-chart"></i>
                                <span class="nav-text">Securities</span>
                            </a>
                            <a href="/market/session" class="nav-link" data-page="session" data-tooltip="Session Info">
                                <i class="fa fa-clock-o"></i>
                                <span class="nav-text">Session Info</span>
                            </a>
                            <a href="/market/reports" class="nav-link" data-page="reports" data-tooltip="Reports">
                                <i class="fa fa-file-text"></i>
                                <span class="nav-text">Reports</span>
                            </a>
                            <t t-if="request.env.user.user_type in ['banker', 'admin']">
                                <a href="/market/ipo" class="nav-link" data-page="ipo" data-tooltip="IPO &amp; Allocation">
                                    <i class="fa fa-rocket"></i>
                                    <span class="nav-text">IPO &amp; Allocation</span>
                                </a>
                            </t>
                        </div>
                        
                        <!-- Account Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Account</div>
                            <a href="/my/account" class="nav-link" data-page="account" data-tooltip="Settings">
                                <i class="fa fa-cog"></i>
                                <span class="nav-text">Settings</span>
                            </a>
                            <a href="/web/session/logout" class="nav-link" data-tooltip="Logout">
                                <i class="fa fa-sign-out"></i>
                                <span class="nav-text">Logout</span>
                            </a>
                        </div>
                    </div>
                </nav>
                
                <!-- Main Content -->
                <main class="stock-main-content">
                    <!-- Top Navigation Bar -->
                    <header class="stock-navbar">
                        <div class="navbar-content">
                            <div class="navbar-title">
                                <i class="fa fa-line-chart title-icon"></i>
                                <span t-esc="page_title or 'Stock Market Portal'"/>
                            </div>
                            
                            <div class="navbar-actions">
                                <!-- Session Status -->
                                <t t-if="active_session">
                                    <div class="navbar-notification" title="Session Active">
                                        <i class="fa fa-clock text-success"></i>
                                    </div>
                                </t>
                                <t t-if="not active_session">
                                    <div class="navbar-notification" title="Session Closed">
                                        <i class="fa fa-clock text-danger"></i>
                                    </div>
                                </t>
                                
                                <!-- Market Status -->
                                <div class="navbar-notification" title="Market Status">
                                    <i class="fa fa-globe" t-attf-style="color: #{active_session and 'var(--stock-success)' or 'var(--stock-danger)'}"></i>
                                </div>
                                
                                <!-- User Info with Dropdown -->
                                <div class="navbar-user dropdown">
                                    <a href="#" class="user-dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <div class="user-avatar">
                                            <t t-esc="request.env.user.name[:2].upper()"/>
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name" t-esc="request.env.user.name"/>
                                            <div class="user-role" t-esc="request.env.user.user_type"/>
                                        </div>
                                        <i class="fa fa-chevron-down ms-2"></i>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/my/home"><i class="fa fa-user me-2"></i>My Account</a></li>
                                        <li><a class="dropdown-item" href="/odoo"><i class="fa fa-th me-2"></i>Backend</a></li>
                                        <li><hr class="dropdown-divider"/></li>
                                        <li><a class="dropdown-item" href="/web/session/logout?redirect=/"><i class="fa fa-sign-out me-2"></i>Logout</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <!-- Page Content -->
                    <div class="container-fluid px-4 py-4">
                        <!-- Financial Summary Cards -->
                        <div class="stock-dashboard-stats mb-4">
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Cash Balance</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-success-light); --icon-color: var(--stock-success);">
                                        <i class="fa fa-money"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(cash_balance or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Available for trading
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Portfolio Value</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-info-light); --icon-color: var(--stock-info);">
                                        <i class="fa fa-briefcase"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(portfolio_value or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Current market value
                                </div>
                            </div>
                            
                            <div class="stock-stat-card">
                                <div class="stat-header">
                                    <h6 class="stat-title">Total Assets</h6>
                                    <div class="stat-icon" style="--icon-bg: var(--stock-primary-light); --icon-color: var(--stock-primary);">
                                        <i class="fa fa-pie-chart"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(total_assets or 0.0)"/>
                                </div>
                                <div class="stat-change neutral">
                                    Cash + Portfolio
                                </div>
                            </div>
                            
                            <div class="stock-stat-card" t-attf-class="#{(profit_loss or 0.0) >= 0 and 'profit' or 'loss'}">
                                <div class="stat-header">
                                    <h6 class="stat-title">P&amp;L</h6>
                                    <div class="stat-icon" t-attf-style="--icon-bg: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success-light)' or 'var(--stock-danger-light)'}; --icon-color: #{(profit_loss or 0.0) >= 0 and 'var(--stock-success)' or 'var(--stock-danger)'};">
                                        <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    </div>
                                </div>
                                <div class="stat-value">
                                    $<t t-esc="'{:,.2f}'.format(profit_loss or 0.0)"/>
                                </div>
                                <div t-attf-class="stat-change #{(profit_loss or 0.0) >= 0 and 'positive' or 'negative'}">
                                    <i t-attf-class="fa #{(profit_loss or 0.0) >= 0 and 'fa-arrow-up' or 'fa-arrow-down'}"></i>
                                    <t t-esc="profit_loss_percentage or 0.0"/>%
                                </div>
                            </div>
                        </div>

                        <!-- Session Status Alert -->
                        <div class="alert alert-info d-flex align-items-center mb-4" t-if="active_session">
                            <i class="fa fa-clock me-2"></i>
                            <div>
                                <strong>Active Session:</strong> <t t-esc="active_session.name"/> - 
                                Session ends at <t t-esc="active_session.planned_end_date" t-options='{"widget": "datetime"}'/>
                            </div>
                        </div>
                        <div class="alert alert-warning d-flex align-items-center mb-4" t-if="not active_session">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>No Active Session</strong> - Trading is currently closed
                            </div>
                        </div>

                        <!-- Main Page Content -->
                        <t t-raw="0"/>
                    </div>
                </main>
            </div>
        </t>
        
        <!-- Pre-paint Initialization - Prevent UI Flicker -->
        <script>//<![CDATA[
            // Execute immediately before paint to prevent flash
            (function() {
                'use strict';
                const savedState = localStorage.getItem('stock_sidebar_collapsed');
                if (savedState === 'true') {
                    document.documentElement.classList.add('stock-sidebar-init-collapsed');
                }
            })();
        //]]></script>
        
        <!-- Sidebar Toggle Logic -->
        <script>//<![CDATA[
            (function() {
                'use strict';
                
                // Configuration
                const SIDEBAR_STATE_KEY = 'stock_sidebar_collapsed';
                const MOBILE_BREAKPOINT = 768;
                
                // Global toggle function
                window.toggleStockSidebar = function() {
                    const sidebar = document.getElementById('stockSidebar');
                    if (!sidebar) return;
                    
                    sidebar.classList.toggle('collapsed');
                    
                    // Save state to localStorage
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    try {
                        localStorage.setItem(SIDEBAR_STATE_KEY, isCollapsed.toString());
                    } catch (e) {
                        console.warn('Failed to save sidebar state:', e);
                    }
                };
                
                // Initialize when DOM is ready
                function initSidebar() {
                    const sidebar = document.getElementById('stockSidebar');
                    if (!sidebar) return;
                    
                    const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
                    
                    // Load saved state (desktop only)
                    if (!isMobile) {
                        const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
                        if (savedState === 'true') {
                            sidebar.classList.add('collapsed');
                        }
                    } else {
                        // Force collapsed on mobile
                        sidebar.classList.add('collapsed');
                    }
                    
                    // Remove initialization class to enable transitions
                    document.documentElement.classList.remove('stock-sidebar-init-collapsed');
                    
                    // Setup toggle button click handler
                    const toggleBtn = sidebar.querySelector('.stock-sidebar-toggle-icon');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', toggleStockSidebar);
                        
                        // Keyboard support
                        toggleBtn.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                toggleStockSidebar();
                            }
                        });
                    }
                    
                    // Set active navigation
                    setActiveNavigation();
                    
                    // Handle window resize
                    let resizeTimer;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(function() {
                            const newIsMobile = window.innerWidth <= MOBILE_BREAKPOINT;
                            if (newIsMobile !== isMobile) {
                                location.reload();
                            }
                        }, 250);
                    });
                }
                
                function setActiveNavigation() {
                    const currentPath = window.location.pathname;
                    const navLinks = document.querySelectorAll('.stock-sidebar .nav-link');
                    
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        const href = link.getAttribute('href');
                        if (href && (currentPath === href || currentPath.startsWith(href + '/'))) {
                            link.classList.add('active');
                        }
                    });
                }
                
                // Initialize
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initSidebar);
                } else {
                    initSidebar();
                }
            })();
        //]]></script>
    </template>

    <!-- IPO & Direct Allocation Page -->
    <template id="portal_ipo_page" name="IPO &amp; Allocation">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="container-fluid">
                <div class="page-header mb-4">
                    <h1 class="h2"><i class="fa fa-rocket"/> IPO &amp; Direct Allocation</h1>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>IPO Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Security</label>
                                    <select class="form-control" id="ipo_security">
                                        <option value="">-- Select --</option>
                                        <t t-foreach="securities" t-as="sec">
                                            <option t-att-value="sec.id"><t t-esc="sec.symbol"/> - <t t-esc="sec.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>IPO Price</label>
                                    <input type="number" class="form-control" id="ipo_price" step="0.01" min="0.01"/>
                                </div>
                                <div class="form-group">
                                    <label>Total Shares</label>
                                    <input type="number" class="form-control" id="ipo_total_shares" min="0" placeholder="Optional"/>
                                </div>
                                <div class="form-group">
                                    <label>Allocation Quantity</label>
                                    <input type="number" class="form-control" id="ipo_alloc_qty" min="0" placeholder="Optional"/>
                                </div>
                                <button class="btn btn-primary" id="btn_run_ipo">Run IPO</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Direct Allocation</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Investor ID</label>
                                    <input type="number" class="form-control" id="alloc_user_id" placeholder="res.users ID"/>
                                </div>
                                <div class="form-group">
                                    <label>Security</label>
                                    <select class="form-control" id="alloc_security">
                                        <option value="">-- Select --</option>
                                        <t t-foreach="securities" t-as="sec">
                                            <option t-att-value="sec.id"><t t-esc="sec.symbol"/> - <t t-esc="sec.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-control" id="alloc_qty" min="1"/>
                                </div>
                                <div class="form-group">
                                    <label>Price</label>
                                    <input type="number" class="form-control" id="alloc_price" step="0.01" min="0.01"/>
                                </div>
                                <button class="btn btn-success" id="btn_direct_alloc">Allocate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>//<![CDATA[
            document.addEventListener('DOMContentLoaded', function() {
                const btnIPO = document.getElementById('btn_run_ipo');
                const btnAlloc = document.getElementById('btn_direct_alloc');
                function toast(msg, type='info') {
                    if (window.stockPortal && window.stockPortal.showNotification) {
                        window.stockPortal.showNotification('Info', msg, type);
                    } else { alert(msg); }
                }
                if (btnIPO) {
                    btnIPO.addEventListener('click', async function() {
                        const security_id = document.getElementById('ipo_security').value;
                        const ipo_price = document.getElementById('ipo_price').value;
                        const total_shares = document.getElementById('ipo_total_shares').value;
                        const ipo_quantity = document.getElementById('ipo_alloc_qty').value;
                        try {
                            const resp = await fetch('/market/ipo/create', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({security_id, ipo_price, total_shares, ipo_quantity})
                            });
                            const raw = await resp.json();
                            const payload = raw?.result || raw;
                            if (payload.success) toast('IPO processed', 'success');
                            else toast(payload.error || 'IPO failed', 'danger');
                        } catch (e) { toast('Network error', 'danger'); }
                    });
                }
                if (btnAlloc) {
                    btnAlloc.addEventListener('click', async function() {
                        const user_id = document.getElementById('alloc_user_id').value;
                        const security_id = document.getElementById('alloc_security').value;
                        const quantity = document.getElementById('alloc_qty').value;
                        const price = document.getElementById('alloc_price').value;
                        try {
                            const resp = await fetch('/market/allocation/direct', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id, security_id, quantity, price})
                            });
                            const raw = await resp.json();
                            const payload = raw?.result || raw;
                            if (payload.success) toast('Allocation done', 'success');
                            else toast(payload.error || 'Allocation failed', 'danger');
                        } catch (e) { toast('Network error', 'danger'); }
                    });
                }
            });
            //]]></script>
        </t>
    </template>
    
    <!-- Market Dashboard View -->
    <template id="market_dashboard_view" name="Market Dashboard View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <t t-set="page_title">Dashboard</t>
            
            <!-- Quick Actions -->
            <div class="row mb-4" t-if="user.user_type == 'investor'">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <a href="/market/trading" class="btn btn-primary">
                                    <i class="fa fa-exchange"></i> Place Order
                                </a>
                                <a href="/market/portfolio" class="btn btn-info">
                                    <i class="fa fa-briefcase"></i> View Portfolio
                                </a>
                                <a href="/market/orders" class="btn btn-secondary">
                                    <i class="fa fa-list"></i> My Orders
                                </a>
                                <a href="/my/banking" class="btn btn-success">
                                    <i class="fa fa-university"></i> Banking
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Movers -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-up"></i> Top Gainers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_gainers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_gainers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            $<t t-esc="'{:,.2f}'.format(security.current_price)"/>
                                        </td>
                                        <td class="text-end text-success">
                                            +<t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_gainers">No gainers today</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fa fa-arrow-down"></i> Top Losers</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" t-if="top_losers">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="top_losers" t-as="security">
                                        <td><t t-esc="security.symbol"/></td>
                                        <td class="text-end">
                                            $<t t-esc="'{:,.2f}'.format(security.current_price)"/>
                                        </td>
                                        <td class="text-end text-danger">
                                            <t t-esc="security.change_percentage"/>%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-center text-muted p-3 mb-0" t-if="not top_losers">No losers today</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Securities -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa fa-line-chart"></i> All Securities</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" t-if="securities">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Change</th>
                                            <th class="text-end">Change %</th>
                                            <th class="text-end">Volume</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="securities" t-as="sec">
                                            <td><strong><t t-esc="sec.symbol"/></strong></td>
                                            <td><t t-esc="sec.name"/></td>
                                            <td><span class="badge bg-secondary"><t t-esc="sec.security_type"/></span></td>
                                            <td class="text-end">
                                                $<t t-esc="'{:,.2f}'.format(sec.current_price)"/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                $<t t-esc="'{:,.2f}'.format(sec.change_amount)"/>
                                            </td>
                                            <td class="text-end" t-attf-class="#{sec.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="sec.change_percentage"/>%
                                            </td>
                                            <td class="text-end"><t t-esc="sec.volume_today"/></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p class="text-center text-muted p-3 mb-0" t-if="not securities">No securities available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </t>
    </template>
    
    <!-- Market Portfolio View -->
    <template id="market_portfolio_view" name="Market Portfolio View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-briefcase me-2"></i>My Portfolio</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Security</th>
                                    <th>Quantity</th>
                                    <th>Avg Cost</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>P&amp;L</th>
                                    <th>P&amp;L %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="positions" t-as="position">
                                    <td><strong><t t-esc="position.security_id.symbol"/></strong><br/><small class="text-muted"><t t-esc="position.security_id.name"/></small></td>
                                    <td><t t-esc="position.quantity"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.average_price or 0.0)"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.security_id.current_price or 0.0)"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(position.market_value or 0.0)"/></td>
                                    <td t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        $<t t-esc="'{:,.2f}'.format(position.unrealized_pnl or 0.0)"/>
                                    </td>
                                    <td t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl_percent or 0.0"/>%
                                    </td>
                                </tr>
                                <tr t-if="not positions">
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="fa fa-inbox fa-3x mb-3 d-block"></i>
                                        No positions yet. Start trading to build your portfolio!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Market Trading View -->
    <template id="market_trading_view" name="Market Trading View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <h4 class="mb-4"><i class="fa fa-exchange me-2"></i>Trading Platform</h4>
            <t t-call="stock_market_simulation.portal_order_new_content"/>
        </t>
    </template>
    
    <!-- Market Orders View -->
    <template id="market_orders_view" name="Market Orders View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fa fa-list me-2"></i>My Orders</h4>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Order scope">
                            <a t-attf-href="/market/orders?scope=current" t-attf-class="btn btn-outline-primary #{scope == 'current' and 'active' or ''}">
                                <i class="fa fa-clock-o"></i> Current Session
                            </a>
                            <a t-attf-href="/market/orders?scope=all" t-attf-class="btn btn-outline-secondary #{scope == 'all' and 'active' or ''}">
                                <i class="fa fa-th-list"></i> All
                            </a>
                        </div>
                    </div>
                    <small class="text-muted" t-if="active_session and scope == 'current'">Showing orders for session: <t t-esc="active_session.name"/></small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Session</th>
                                    <th>Security</th>
                                    <th>Entered By</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="orders" t-as="order">
                                    <td><span class="badge bg-secondary"><t t-esc="order.name"/></span></td>
                                    <td><small><t t-esc="order.session_id.name or '-'"/></small></td>
                                    <td><strong><t t-esc="order.security_id.symbol"/></strong></td>
                                    <td><small><t t-esc="order.entered_by_id and order.entered_by_id.name or '-'"/></small></td>
                                    <td>
                                        <span t-attf-class="badge #{order.side == 'buy' and 'bg-success' or 'bg-danger'}">
                                            <t t-esc="order.side.upper()"/>
                                        </span>
                                    </td>
                                    <td><t t-esc="order.order_type"/></td>
                                    <td><t t-esc="order.quantity"/></td>
                                    <td>$<t t-esc="'{:,.2f}'.format(order.price or 0.0)"/></td>
                                    <td>
                                        <span t-attf-class="badge #{order.status == 'filled' and 'bg-success' or order.status == 'cancelled' and 'bg-danger' or 'bg-warning'}">
                                            <t t-esc="order.status.upper()"/>
                                        </span>
                                    </td>
                                    <td><small><t t-esc="order.create_date" t-options='{"widget": "datetime"}'/></small></td>
                                </tr>
                                <tr t-if="not orders">
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fa fa-list fa-3x mb-3 d-block"></i>
                                        No orders yet. Place your first order to get started!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Remove "Powered by Odoo" Footer - Disabled for Odoo 18 compatibility -->
    <!-- 
    <template id="remove_odoo_branding" inherit_id="portal.portal_layout" priority="99">
        <xpath expr="//footer" position="replace">
            <footer class="bg-light mt-5 py-4">
                <div class="container">
                    <div class="text-center text-muted">
                        <p class="mb-0">© <t t-esc="datetime.datetime.now().year"/> Stock Market Simulation Portal</p>
                        <small>Professional Trading Platform</small>
                    </div>
                </div>
            </footer>
        </xpath>
    </template>
    -->
    
    <!-- Redirect /my to /market - Disabled for Odoo 18 compatibility -->
    <!--
    <template id="redirect_my_to_market" inherit_id="portal.portal_my_home" priority="99">
        <xpath expr="//div[hasclass('o_portal_wrap')]" position="after">
            <script>
                if (window.location.pathname === '/my' || window.location.pathname === '/my/') {
                    window.location.href = '/market';
                }
            </script>
        </xpath>
    </template>
    -->

    <!-- WIKI-Style Error Page Template -->
    <template id="stock_error_page" name="Stock Market Error Page">
        <t t-call="web.frontend_layout">
            <t t-set="pageName" t-value="'stock_error'"/>
            
            <div class="stock-portal-layout">
                <!-- Error Page Content -->
                <div class="container-fluid">
                    <div class="error-page">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-xl-6">
                                <div class="error-content text-center">
                                    <!-- Error Status -->
                                    <div class="error-status mb-4">
                                        <h1 class="error-code" t-esc="status_code"/>
                                        <h2 class="error-title" t-esc="status_message"/>
                                        <p class="error-description text-muted" t-esc="description"/>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="error-actions mb-5">
                                        <a href="/market" class="btn btn-primary me-2">
                                            <i class="fa fa-home"/> Back to Market
                                        </a>
                                        <a href="javascript:history.back()" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left"/> Go Back
                                        </a>
                                    </div>

                                    <!-- Suggestions (only for 404/403) -->
                                    <t t-if="show_suggestions">
                                        <div class="error-suggestions">
                                            <!-- Active Sessions -->
                                            <t t-if="suggested_sessions">
                                                <div class="suggestion-section mb-4">
                                                    <h5>Active Trading Sessions</h5>
                                                    <div class="row">
                                                        <t t-foreach="suggested_sessions" t-as="session">
                                                            <div class="col-md-6 mb-3">
                                                                <div class="card h-100">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title" t-field="session.name"/>
                                                                        <p class="card-text text-muted">
                                                                            <span class="badge" t-attf-class="badge-#{session.state}">
                                                                                <t t-esc="session.state.title()"/>
                                                                            </span>
                                                                        </p>
                                                                        <a t-attf-href="/market/session/#{session.id}" class="btn btn-sm btn-outline-primary">
                                                                            View Session
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>

                                            <!-- Popular Securities -->
                                            <t t-if="popular_securities">
                                                <div class="suggestion-section">
                                                    <h5>Available Securities</h5>
                                                    <div class="row">
                                                        <t t-foreach="popular_securities" t-as="security">
                                                            <div class="col-md-4 mb-3">
                                                                <div class="card h-100">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title" t-field="security.name"/>
                                                                        <p class="card-text">
                                                                            <small class="text-muted" t-field="security.symbol"/>
                                                                        </p>
                                                                        <a t-attf-href="/market/security/#{security.id}" class="btn btn-sm btn-outline-success">
                                                                            View Details
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Page Styles -->
            <style>
                .error-page {
                    min-height: 80vh;
                    display: flex;
                    align-items: center;
                    padding: 2rem 0;
                }
                
                .error-code {
                    font-size: 6rem;
                    font-weight: 700;
                    color: var(--stock-primary);
                    line-height: 1;
                    margin-bottom: 0.5rem;
                }
                
                .error-title {
                    font-size: 2rem;
                    font-weight: 600;
                    color: var(--stock-text-primary);
                    margin-bottom: 1rem;
                }
                
                .error-description {
                    font-size: 1.1rem;
                    max-width: 500px;
                    margin: 0 auto 2rem;
                }
                
                .suggestion-section {
                    text-align: left;
                }
                
                .suggestion-section h5 {
                    color: var(--stock-text-primary);
                    margin-bottom: 1rem;
                    font-weight: 600;
                }
                
                .badge-active {
                    background-color: var(--stock-success);
                }
                
                .badge-planned {
                    background-color: var(--stock-warning);
                }
                
                .badge-closed {
                    background-color: var(--stock-muted);
                }
            </style>
        </t>
    </template>
    
</odoo> 