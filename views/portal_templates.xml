<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Extend portal home page -->
    <template id="portal_my_home" name="Show Stock Market Data" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type in ['investor', 'broker', 'banker']">
                <h3 class="mt-4">Stock Market Dashboard</h3>
                
                <!-- Financial Summary -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Cash Balance</h5>
                                <p class="card-text h4"><t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Portfolio Value</h5>
                                <p class="card-text h4"><t t-esc="portfolio_value or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Assets</h5>
                                <p class="card-text h4"><t t-esc="total_assets or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">P&amp;L</h5>
                                <p class="card-text h4">
                                    <span t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="profit_loss or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/>
                                        (<t t-esc="profit_loss_percentage or 0.0"/>%)
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <t t-if="user_type == 'investor'">
                            <a href="/my/order/new" class="btn btn-primary">Place New Order</a>
                            <a href="/my/portfolio" class="btn btn-secondary">View Portfolio</a>
                            <a href="/my/orders" class="btn btn-secondary">My Orders</a>
                        </t>
                        <t t-if="user_type == 'broker'">
                            <a href="/my/commissions" class="btn btn-primary">Commission Report</a>
                        </t>
                        <t t-if="user_type == 'banker'">
                            <a href="/my/banking" class="btn btn-primary">Banking Dashboard</a>
                        </t>
                        <a href="/my/market" class="btn btn-info">Market Data</a>
                    </div>
                </div>
                
                <!-- Market Movers -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Top Gainers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_gainers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-success">+<t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Top Losers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="top_losers" t-as="security">
                                    <tr>
                                        <td><t t-esc="security.symbol"/></td>
                                        <td><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-danger"><t t-esc="security.change_percentage"/>%</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>
            </t>
        </xpath>
        
        <!-- Add counts to portal docs section -->
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="request.env.user.user_type == 'investor' and order_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Orders</t>
                    <t t-set="url" t-value="'/my/orders'"/>
                    <t t-set="count" t-value="order_count"/>
                </t>
            </t>
            <t t-if="request.env.user.user_type == 'investor' and position_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Positions</t>
                    <t t-set="url" t-value="'/my/portfolio'"/>
                    <t t-set="count" t-value="position_count"/>
                </t>
            </t>
            <t t-if="trade_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Trades</t>
                    <t t-set="url" t-value="'/my/trades'"/>
                    <t t-set="count" t-value="trade_count"/>
                </t>
            </t>
            <t t-if="deposit_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Deposits</t>
                    <t t-set="url" t-value="'/my/deposits'"/>
                    <t t-set="count" t-value="deposit_count"/>
                </t>
            </t>
            <t t-if="loan_count">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Loans</t>
                    <t t-set="url" t-value="'/my/loans'"/>
                    <t t-set="count" t-value="loan_count"/>
                </t>
            </t>
        </xpath>
    </template>
    
    <!-- Portfolio Page -->
    <template id="portal_my_portfolio" name="My Portfolio">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Portfolio</t>
            </t>
            
            <t t-if="not positions">
                <p>You don't have any positions yet.</p>
            </t>
            
            <t t-if="positions" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th>Security</th>
                        <th class="text-right">Quantity</th>
                        <th class="text-right">Avg Cost</th>
                        <th class="text-right">Market Value</th>
                        <th class="text-right">Unrealized P&amp;L</th>
                        <th class="text-right">P&amp;L %</th>
                        <th class="text-right">Weight %</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="positions" t-as="position">
                        <tr>
                            <td><t t-esc="position.security_id.symbol"/> - <t t-esc="position.security_id.name"/></td>
                            <td class="text-right"><t t-esc="position.quantity"/></td>
                            <td class="text-right"><t t-esc="position.average_cost" t-options='{"widget": "float", "precision": 2}'/></td>
                            <td class="text-right"><t t-esc="position.market_value or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></td>
                            <td class="text-right">
                                <span t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                    <t t-esc="position.unrealized_pnl or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/>
                                </span>
                            </td>
                            <td class="text-right">
                                <span t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                    <t t-esc="position.unrealized_pnl_percent" t-options='{"widget": "float", "precision": 2}'/>%
                                </span>
                            </td>
                            <td class="text-right"><t t-esc="position.portfolio_weight" t-options='{"widget": "float", "precision": 2}'/>%</td>
                        </tr>
                    </t>
                </tbody>
            </t>
        </t>
    </template>
    
    <!-- Order Entry Page -->
    <template id="portal_order_new" name="Place New Order">
        <t t-call="portal.portal_layout">
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <div class="container mt-3">
                <h2>Place New Order</h2>
                
                <t t-if="error">
                    <div class="alert alert-danger" role="alert">
                        <t t-esc="error"/>
                    </div>
                </t>
                
                <t t-if="active_session">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="order_form" method="post">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <div class="form-group">
                                    <label for="side">Order Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="side" id="side_buy" value="buy" checked="checked"/>
                                            <label class="form-check-label" for="side_buy">Buy</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="side" id="side_sell" value="sell"/>
                                            <label class="form-check-label" for="side_sell">Sell</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="security_id">Security</label>
                                    <select name="security_id" id="security_id" class="form-control" required="required">
                                        <option value="">Select Security</option>
                                        <t t-foreach="securities" t-as="security">
                                            <option t-att-value="security.id" t-att-data-price="security.current_price">
                                                <t t-esc="security.symbol"/> - <t t-esc="security.name"/> 
                                                (Current: <t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/>)
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="order_type">Price Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="order_type" id="order_type_limit" value="limit" checked="checked"/>
                                            <label class="form-check-label" for="order_type_limit">Limit</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="order_type" id="order_type_market" value="market"/>
                                            <label class="form-check-label" for="order_type_market">Market</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="quantity">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" required="required"/>
                                </div>
                                
                                <div class="form-group" id="price_group">
                                    <label for="price">Price</label>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0.01" required="required"/>
                                </div>
                                
                                <div class="form-group">
                                    <label>Estimated Order Value</label>
                                    <p class="form-control-static h4" id="order_value">0.00</p>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Submit Order</button>
                                <a href="/my" class="btn btn-secondary">Cancel</a>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Account Information</h5>
                                </div>
                                <div class="card-body">
                                    <p>Cash Balance: <strong><t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></strong></p>
                                    <p>Active Session: <strong><t t-esc="active_session.name"/></strong></p>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="positions_card" style="display:none;">
                                <div class="card-header">
                                    <h5>Your Positions</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Security</th>
                                                <th>Available</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="positions" t-as="position">
                                                <tr t-att-data-security-id="position.security_id.id">
                                                    <td><t t-esc="position.security_id.symbol"/></td>
                                                    <td><t t-esc="position.available_quantity"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
            
            <script>
                $(document).ready(function() {
                    // Calculate order value
                    function calculateOrderValue() {
                        var quantity = parseFloat($('#quantity').val()) || 0;
                        var price = parseFloat($('#price').val()) || 0;
                        var value = quantity * price;
                        $('#order_value').text(value.toFixed(2));
                    }
                    
                    $('#quantity, #price').on('input', calculateOrderValue);
                    
                    // Handle order type change
                    $('input[name="order_type"]').change(function() {
                        if ($(this).val() === 'market') {
                            $('#price_group').hide();
                            $('#price').prop('required', false);
                        } else {
                            $('#price_group').show();
                            $('#price').prop('required', true);
                        }
                    });
                    
                    // Handle side change
                    $('input[name="side"]').change(function() {
                        if ($(this).val() === 'sell') {
                            $('#positions_card').show();
                        } else {
                            $('#positions_card').hide();
                        }
                    });
                    
                    // Set current price when security changes
                    $('#security_id').change(function() {
                        var selectedOption = $(this).find('option:selected');
                        var currentPrice = selectedOption.data('price');
                        if (currentPrice) {
                            $('#price').val(currentPrice);
                            calculateOrderValue();
                        }
                    });
                    
                    // Submit order
                    $('#order_form').submit(function(e) {
                        e.preventDefault();
                        
                        var formData = {
                            security_id: $('#security_id').val(),
                            side: $('input[name="side"]:checked').val(),
                            order_type: $('input[name="order_type"]:checked').val(),
                            quantity: $('#quantity').val(),
                            price: $('#price').val()
                        };
                        
                        $.ajax({
                            url: '/my/order/create',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-Csrf-Token': $('input[name="csrf_token"]').val()
                            },
                            success: function(result) {
                                if (result.success) {
                                    alert(result.message);
                                    window.location.href = '/my/orders';
                                } else {
                                    alert('Error: ' + result.error);
                                }
                            },
                            error: function() {
                                alert('Error submitting order');
                            }
                        });
                    });
                });
            </script>
        </t>
    </template>
    
    <!-- Market Data Page -->
    <template id="portal_market_data" name="Market Data">
        <t t-call="portal.portal_layout">
            <t t-set="no_breadcrumbs" t-value="True"/>
            
            <div class="container mt-3">
                <h2>Market Data</h2>
                
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#all">All Securities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#stocks">Stocks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#bonds">Bonds</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#mf">Mutual Funds</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div id="all" class="tab-pane fade show active">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Change</th>
                                    <th class="text-right">Change %</th>
                                    <th class="text-right">Volume</th>
                                    <th class="text-right">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="securities" t-as="security">
                                    <tr>
                                        <td><strong><t t-esc="security.symbol"/></strong></td>
                                        <td><t t-esc="security.name"/></td>
                                        <td><t t-esc="security.security_type"/></td>
                                        <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                            </span>
                                        </td>
                                        <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        <td class="text-right"><t t-esc="security.value_today or 0.0" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <t t-foreach="grouped_securities" t-as="sec_type">
                        <div t-att-id="sec_type" class="tab-pane fade">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th class="text-right">Price</th>
                                        <th class="text-right">Change</th>
                                        <th class="text-right">Change %</th>
                                        <th class="text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="grouped_securities[sec_type]" t-as="security">
                                        <tr>
                                            <td><strong><t t-esc="security.symbol"/></strong></td>
                                            <td><t t-esc="security.name"/></td>
                                            <td class="text-right"><t t-esc="security.current_price" t-options='{"widget": "float", "precision": 2}'/></td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_amount >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_amount" t-options='{"widget": "float", "precision": 2}'/>
                                                </span>
                                            </td>
                                            <td class="text-right">
                                                <span t-attf-class="#{security.change_percentage >= 0 and 'text-success' or 'text-danger'}">
                                                    <t t-esc="security.change_percentage" t-options='{"widget": "float", "precision": 2}'/>%
                                                </span>
                                            </td>
                                            <td class="text-right"><t t-esc="security.volume_today"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- JavaScript for real-time updates -->
    <template id="portal_stock_js" name="Stock Portal JavaScript">
        <script>//<![CDATA[
            // Global namespace for stock portal functionality
            window.stockPortal = window.stockPortal || {};
            
            // Portfolio refresh functionality
            function refreshPortfolioSummary() {
                fetch('/api/portfolio/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update portfolio values on dashboard
                        const cashEl = document.querySelector('[data-portfolio="cash"]');
                        const portfolioEl = document.querySelector('[data-portfolio="value"]');
                        const totalEl = document.querySelector('[data-portfolio="total"]');
                        const plEl = document.querySelector('[data-portfolio="pl"]');
                        
                        if (cashEl) cashEl.textContent = '$' + data.cash_balance.toLocaleString();
                        if (portfolioEl) portfolioEl.textContent = '$' + data.portfolio_value.toLocaleString();
                        if (totalEl) totalEl.textContent = '$' + data.total_assets.toLocaleString();
                        if (plEl) {
                            plEl.textContent = '$' + data.profit_loss.toLocaleString() + ' (' + data.profit_loss_percentage + '%)';
                            plEl.className = data.profit_loss >= 0 ? 'text-success' : 'text-danger';
                        }
                        
                        console.log('Portfolio data refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing portfolio:', error);
                });
            }
            
            // Market data refresh functionality
            function refreshMarketQuotes() {
                const symbols = [];
                document.querySelectorAll('[data-symbol]').forEach(el => {
                    symbols.push(el.dataset.symbol);
                });
                
                if (symbols.length === 0) return;
                
                fetch('/api/market/quotes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({symbols: symbols})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.quotes) {
                        data.quotes.forEach(quote => {
                            const rows = document.querySelectorAll(`[data-symbol="${quote.symbol}"]`);
                            rows.forEach(row => {
                                const priceEl = row.querySelector('.quote-price');
                                const changeEl = row.querySelector('.quote-change');
                                const pctEl = row.querySelector('.quote-percentage');
                                
                                if (priceEl) priceEl.textContent = quote.current_price.toFixed(2);
                                if (changeEl) {
                                    changeEl.textContent = quote.price_change.toFixed(2);
                                    changeEl.className = quote.price_change >= 0 ? 'text-success' : 'text-danger';
                                }
                                if (pctEl) {
                                    pctEl.textContent = quote.change_percentage + '%';
                                    pctEl.className = quote.change_percentage >= 0 ? 'text-success' : 'text-danger';
                                }
                            });
                        });
                        console.log('Market quotes refreshed');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing market quotes:', error);
                });
            }
            
            // Order submission with enhanced validation
            function submitOrder(formData) {
                const submitBtn = document.querySelector('#submit-order-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...';
                }
                
                return fetch('/my/order/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Order';
                    }
                    
                    if (data.success) {
                        showNotification('Success', data.message, 'success');
                        // Refresh portfolio data
                        setTimeout(refreshPortfolioSummary, 1000);
                    } else {
                        showNotification('Error', data.error, 'danger');
                    }
                    
                    return data;
                })
                .catch(error => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Order';
                    }
                    console.error('Order submission error:', error);
                    showNotification('Error', 'Network error occurred', 'danger');
                    throw error;
                });
            }
            
            // Notification system
            function showNotification(title, message, type) {
                // Remove existing notifications
                const existing = document.querySelectorAll('.stock-notification');
                existing.forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} alert-dismissible stock-notification`;
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Start periodic updates for real-time data
                if (window.location.pathname.startsWith('/my')) {
                    // Refresh portfolio every 30 seconds
                    setInterval(refreshPortfolioSummary, 30000);
                    
                    // Refresh market quotes every 15 seconds
                    setInterval(refreshMarketQuotes, 15000);
                    
                    console.log('Stock portal real-time updates initialized');
                }
            });
            
            // Expose functions globally
            window.stockPortal.refreshPortfolioSummary = refreshPortfolioSummary;
            window.stockPortal.refreshMarketQuotes = refreshMarketQuotes;
            window.stockPortal.submitOrder = submitOrder;
            window.stockPortal.showNotification = showNotification;
        //]]></script>
    </template>
    
    <!-- Custom Market Portal Layout -->
    <template id="market_portal_layout" name="Market Portal Layout">
        <t t-call="web.layout">
            <t t-set="head">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
                <style><![CDATA[
                    /* Custom Market Portal Styles */
                    body {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background-color: #f8f9fa;
                    }
                    
                    /* Custom Navbar */
                    .market-navbar {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 1rem 0;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .market-navbar .navbar-brand {
                        color: white;
                        font-weight: bold;
                        font-size: 1.5rem;
                    }
                    
                    .market-navbar .nav-link {
                        color: rgba(255,255,255,0.9);
                        margin: 0 10px;
                        transition: all 0.3s;
                    }
                    
                    .market-navbar .nav-link:hover {
                        color: white;
                        transform: translateY(-2px);
                    }
                    
                    .market-navbar .nav-link.active {
                        color: white;
                        font-weight: 600;
                        border-bottom: 2px solid white;
                    }
                    
                    /* Sidebar */
                    .market-sidebar {
                        background: white;
                        min-height: calc(100vh - 120px);
                        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
                        transition: all 0.3s;
                        position: sticky;
                        top: 80px;
                    }
                    
                    .market-sidebar.collapsed {
                        margin-left: -250px;
                    }
                    
                    .sidebar-toggle {
                        position: fixed;
                        left: 0;
                        top: 100px;
                        z-index: 1000;
                        background: #667eea;
                        color: white;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 0 5px 5px 0;
                        cursor: pointer;
                        transition: all 0.3s;
                    }
                    
                    .sidebar-toggle:hover {
                        background: #764ba2;
                    }
                    
                    .sidebar-menu {
                        list-style: none;
                        padding: 0;
                        margin: 0;
                    }
                    
                    .sidebar-menu li {
                        border-bottom: 1px solid #f0f0f0;
                    }
                    
                    .sidebar-menu a {
                        display: block;
                        padding: 15px 20px;
                        color: #495057;
                        text-decoration: none;
                        transition: all 0.3s;
                    }
                    
                    .sidebar-menu a:hover {
                        background: #f8f9fa;
                        color: #667eea;
                        padding-left: 25px;
                    }
                    
                    .sidebar-menu a.active {
                        background: #667eea;
                        color: white;
                        border-left: 4px solid #764ba2;
                    }
                    
                    .sidebar-menu i {
                        margin-right: 10px;
                        width: 20px;
                    }
                    
                    /* Main Content */
                    .market-content {
                        padding: 20px;
                        transition: all 0.3s;
                    }
                    
                    /* Footer */
                    .market-footer {
                        background: #2c3e50;
                        color: white;
                        padding: 30px 0;
                        margin-top: 50px;
                    }
                    
                    .market-footer a {
                        color: #ecf0f1;
                        text-decoration: none;
                    }
                    
                    .market-footer a:hover {
                        color: white;
                    }
                    
                    /* Cards */
                    .stat-card {
                        background: white;
                        border-radius: 10px;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                        transition: all 0.3s;
                    }
                    
                    .stat-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                    }
                    
                    /* Responsive */
                    @media (max-width: 768px) {
                        .market-sidebar {
                            position: fixed;
                            left: -250px;
                            top: 60px;
                            width: 250px;
                            z-index: 999;
                        }
                        
                        .market-sidebar.show {
                            left: 0;
                        }
                    }
                ]]></style>
            </t>
            
            <div class="market-portal">
                <!-- Custom Navbar -->
                <nav class="market-navbar">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/market" class="navbar-brand">
                                <i class="fa fa-chart-line me-2"></i>
                                Stock Market Portal
                            </a>
                            
                            <div class="d-flex align-items-center">
                                <div class="me-4 text-white">
                                    <small>Cash Balance:</small>
                                    <strong class="ms-2">
                                        <t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                    </strong>
                                </div>
                                
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fa fa-user-circle me-1"></i>
                                        <t t-esc="user.name"/>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/my/home"><i class="fa fa-home me-2"></i>My Portal</a></li>
                                        <li><a class="dropdown-item" href="/my/account"><i class="fa fa-user me-2"></i>My Account</a></li>
                                        <li><hr class="dropdown-divider"/></li>
                                        <li><a class="dropdown-item" href="/web/session/logout"><i class="fa fa-sign-out-alt me-2"></i>Logout</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
                
                <!-- Sidebar Toggle Button -->
                <button class="sidebar-toggle" id="sidebarToggleBtn">
                    <i class="fa fa-bars"></i>
                </button>
                
                <!-- Main Layout -->
                <div class="container-fluid">
                    <div class="row">
                        <!-- Collapsible Sidebar -->
                        <div class="col-md-3 col-lg-2 p-0">
                            <div class="market-sidebar" id="marketSidebar">
                                <ul class="sidebar-menu">
                                    <li>
                                        <a href="/market" t-attf-class="#{page_name == 'market_home' and 'active' or ''}">
                                            <i class="fa fa-home"></i>
                                            Dashboard
                                        </a>
                                    </li>
                                    <li t-if="user.user_type == 'investor'">
                                        <a href="/market/portfolio" t-attf-class="#{page_name == 'portfolio' and 'active' or ''}">
                                            <i class="fa fa-briefcase"></i>
                                            My Portfolio
                                        </a>
                                    </li>
                                    <li t-if="user.user_type == 'investor'">
                                        <a href="/market/trading" t-attf-class="#{page_name == 'trading' and 'active' or ''}">
                                            <i class="fa fa-exchange-alt"></i>
                                            Trading
                                        </a>
                                    </li>
                                    <li t-if="user.user_type == 'investor'">
                                        <a href="/market/orders" t-attf-class="#{page_name == 'orders' and 'active' or ''}">
                                            <i class="fa fa-list-ul"></i>
                                            My Orders
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/my/market">
                                            <i class="fa fa-chart-bar"></i>
                                            Market Data
                                        </a>
                                    </li>
                                    <li t-if="user.user_type == 'investor'">
                                        <a href="/my/banking">
                                            <i class="fa fa-university"></i>
                                            Banking
                                        </a>
                                    </li>
                                    <li t-if="user.user_type == 'broker'">
                                        <a href="/my/commissions">
                                            <i class="fa fa-dollar-sign"></i>
                                            Commissions
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Main Content Area -->
                        <div class="col-md-9 col-lg-10">
                            <div class="market-content">
                                <!-- Financial Summary Cards -->
                                <div class="row mb-4">
                                    <div class="col-md-3 mb-3">
                                        <div class="stat-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">Cash Balance</small>
                                                    <h4 class="mb-0">
                                                        <t t-esc="cash_balance or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                                    </h4>
                                                </div>
                                                <i class="fa fa-wallet fa-2x text-primary opacity-25"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="stat-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">Portfolio Value</small>
                                                    <h4 class="mb-0">
                                                        <t t-esc="portfolio_value or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                                    </h4>
                                                </div>
                                                <i class="fa fa-briefcase fa-2x text-success opacity-25"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="stat-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">Total Assets</small>
                                                    <h4 class="mb-0">
                                                        <t t-esc="total_assets or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                                    </h4>
                                                </div>
                                                <i class="fa fa-chart-pie fa-2x text-info opacity-25"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="stat-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">P&amp;L</small>
                                                    <h4 class="mb-0" t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        <t t-esc="profit_loss or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                                    </h4>
                                                    <small t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                                        (<t t-esc="profit_loss_percentage or 0.0"/>%)
                                                    </small>
                                                </div>
                                                <i class="fa fa-chart-line fa-2x opacity-25" t-attf-class="#{(profit_loss or 0.0) >= 0 and 'text-success' or 'text-danger'}"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Active Session Info -->
                                <div class="alert alert-info" t-if="active_session">
                                    <i class="fa fa-info-circle me-2"></i>
                                    <strong>Active Session:</strong>
                                    <t t-esc="active_session.name"/> - 
                                    <small>Started: <t t-esc="active_session.start_date" t-options='{"widget": "datetime"}'/></small>
                                </div>
                                
                                <!-- Market Movers -->
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h5 class="mb-0"><i class="fa fa-arrow-up me-2"></i>Top Gainers</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Symbol</th>
                                                                <th>Price</th>
                                                                <th class="text-end">Change</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr t-foreach="top_gainers" t-as="security">
                                                                <td><strong><t t-esc="security.symbol"/></strong></td>
                                                                <td><t t-esc="security.current_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                                                <td class="text-end text-success">
                                                                    +<t t-esc="security.change_percentage or 0.0"/>%
                                                                </td>
                                                            </tr>
                                                            <tr t-if="not top_gainers">
                                                                <td colspan="3" class="text-center text-muted">No gainers today</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-danger text-white">
                                                <h5 class="mb-0"><i class="fa fa-arrow-down me-2"></i>Top Losers</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Symbol</th>
                                                                <th>Price</th>
                                                                <th class="text-end">Change</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr t-foreach="top_losers" t-as="security">
                                                                <td><strong><t t-esc="security.symbol"/></strong></td>
                                                                <td><t t-esc="security.current_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                                                <td class="text-end text-danger">
                                                                    <t t-esc="security.change_percentage or 0.0"/>%
                                                                </td>
                                                            </tr>
                                                            <tr t-if="not top_losers">
                                                                <td colspan="3" class="text-center text-muted">No losers today</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fa fa-rocket me-2"></i>Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-2" t-if="user.user_type == 'investor'">
                                                <a href="/market/trading" class="btn btn-primary w-100">
                                                    <i class="fa fa-shopping-cart me-2"></i>Buy Securities
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2" t-if="user.user_type == 'investor'">
                                                <a href="/market/portfolio" class="btn btn-success w-100">
                                                    <i class="fa fa-briefcase me-2"></i>View Portfolio
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <a href="/my/market" class="btn btn-info w-100">
                                                    <i class="fa fa-chart-bar me-2"></i>Market Data
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2" t-if="user.user_type == 'investor'">
                                                <a href="/my/banking" class="btn btn-warning w-100">
                                                    <i class="fa fa-university me-2"></i>Banking
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Footer -->
                <footer class="market-footer">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Stock Market Simulation</h5>
                                <p class="text-muted">A comprehensive trading platform for learning and practice.</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Quick Links</h6>
                                <ul class="list-unstyled">
                                    <li><a href="/market">Dashboard</a></li>
                                    <li><a href="/my/market">Market Data</a></li>
                                    <li><a href="/my/home">My Portal</a></li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Support</h6>
                                <ul class="list-unstyled">
                                    <li><a href="#">Help Center</a></li>
                                    <li><a href="#">Contact Us</a></li>
                                    <li><a href="#">Terms &amp; Conditions</a></li>
                                </ul>
                            </div>
                        </div>
                        <hr class="my-4" style="border-color: rgba(255,255,255,0.1);"/>
                        <div class="text-center">
                            <small>© 2025 Stock Market Simulation. All rights reserved.</small>
                        </div>
                    </div>
                </footer>
                
                <!-- Sidebar Toggle Script -->
                <script>//<![CDATA[
                    document.addEventListener('DOMContentLoaded', function() {
                        // Sidebar toggle
                        const toggleBtn = document.getElementById('sidebarToggleBtn');
                        if (toggleBtn) {
                            toggleBtn.addEventListener('click', function() {
                                const sidebar = document.getElementById('marketSidebar');
                                if (sidebar) {
                                    sidebar.classList.toggle('collapsed');
                                }
                            });
                        }
                        
                        // Auto-refresh every 30 seconds
                        setInterval(function() {
                            if (window.stockPortal && window.stockPortal.refreshMarketQuotes) {
                                window.stockPortal.refreshMarketQuotes();
                            }
                        }, 30000);
                    });
                //]]></script>
            </div>
        </t>
    </template>
    
    <!-- Market Portfolio View -->
    <template id="market_portfolio_view" name="Market Portfolio View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-briefcase me-2"></i>My Portfolio</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Security</th>
                                    <th>Quantity</th>
                                    <th>Avg Cost</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>P&amp;L</th>
                                    <th>P&amp;L %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="positions" t-as="position">
                                    <td><strong><t t-esc="position.security_id.symbol"/></strong><br/><small class="text-muted"><t t-esc="position.security_id.name"/></small></td>
                                    <td><t t-esc="position.quantity"/></td>
                                    <td><t t-esc="position.average_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td><t t-esc="position.security_id.current_price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td><t t-esc="position.market_value or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td t-attf-class="#{(position.unrealized_pnl or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/>
                                    </td>
                                    <td t-attf-class="#{(position.unrealized_pnl_percent or 0.0) >= 0 and 'text-success' or 'text-danger'}">
                                        <t t-esc="position.unrealized_pnl_percent or 0.0"/>%
                                    </td>
                                </tr>
                                <tr t-if="not positions">
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="fa fa-inbox fa-3x mb-3 d-block"></i>
                                        No positions yet. Start trading to build your portfolio!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Market Trading View -->
    <template id="market_trading_view" name="Market Trading View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <h4 class="mb-4"><i class="fa fa-exchange-alt me-2"></i>Trading Platform</h4>
            <t t-call="stock_market_simulation.portal_order_new"/>
        </t>
    </template>
    
    <!-- Market Orders View -->
    <template id="market_orders_view" name="Market Orders View">
        <t t-call="stock_market_simulation.market_portal_layout">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fa fa-list-ul me-2"></i>My Orders</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Security</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="orders" t-as="order">
                                    <td><span class="badge bg-secondary"><t t-esc="order.name"/></span></td>
                                    <td><strong><t t-esc="order.security_id.symbol"/></strong></td>
                                    <td>
                                        <span t-attf-class="badge #{order.side == 'buy' and 'bg-success' or 'bg-danger'}">
                                            <t t-esc="order.side.upper()"/>
                                        </span>
                                    </td>
                                    <td><t t-esc="order.order_type"/></td>
                                    <td><t t-esc="order.quantity"/></td>
                                    <td><t t-esc="order.price or 0.0" t-options='{"widget": "monetary", "display_currency": display_currency}'/></td>
                                    <td>
                                        <span t-attf-class="badge #{order.status == 'filled' and 'bg-success' or order.status == 'cancelled' and 'bg-danger' or 'bg-warning'}">
                                            <t t-esc="order.status.upper()"/>
                                        </span>
                                    </td>
                                    <td><small><t t-esc="order.create_date" t-options='{"widget": "datetime"}'/></small></td>
                                </tr>
                                <tr t-if="not orders">
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fa fa-list fa-3x mb-3 d-block"></i>
                                        No orders yet. Place your first order to get started!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
</odoo> 